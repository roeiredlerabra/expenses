<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>דוח החזר הוצאות | Abra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" />
    <style>
        /* Advanced Design System */
        :root {
            /* Brand Colors */
            --abra-navy: #121f3f;
            --abra-coral: #ff7748;
            --abra-pink: #ff5288;
            --abra-yellow: #ff9f00;
            --abra-white: #fcf9f5;
            
            /* Light Theme (Default) */
            --bg-primary: #ffffff;
            --bg-secondary: var(--abra-white);
            --bg-tertiary: #f3f4f8;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.8);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: rgba(226, 232, 240, 0.8);
            
            /* UI Colors */
            --primary-gradient: linear-gradient(135deg, var(--abra-coral) 0%, var(--abra-pink) 100%);
            --success: #38b2ac;
            --error: #e53e3e;
            --warning: #dd6b20;
            --info: #3182ce;
            
            /* System Colors */
            --coral-light: rgba(255, 119, 72, 0.08);
            --pink-light: rgba(255, 82, 136, 0.08);
            --yellow-light: rgba(255, 159, 0, 0.08);
            --navy-light: rgba(18, 31, 63, 0.06);
            
            /* Typography */
            --font-heading: 'Sharp Sans No1', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-body: 'Simpler Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* Shadows */
            --shadow-xs: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            
            /* Border Radius */
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --bg-card: #1f2937;
            --bg-glass: rgba(17, 24, 39, 0.8);
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-muted: #a0aec0;
            --border-color: rgba(55, 65, 81, 0.8);
        }
        
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-body);
            color: var(--text-primary);
            background-color: var(--bg-primary);
            transition: background-color var(--transition-normal);
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 700;
            letter-spacing: -0.02em;
            color: var(--text-primary);
        }
        
        .text-gradient {
            background-image: var(--primary-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }
        
        /* Advanced Layout Structure */
        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: all var(--transition-normal);
            z-index: 40;
            -webkit-overflow-scrolling: touch;
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 2.5rem;
        }
        
        .logo-container {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .company-logo {
            height: 40px;
            transition: transform var(--transition-normal);
        }
        
        .company-logo:hover {
            transform: scale(1.05);
        }
        
        .sidebar-sections {
            margin-top: 2rem;
        }
        
        .sidebar-section {
            margin-bottom: 1.5rem;
        }
        
        .sidebar-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-weight: 500;
            transition: all var(--transition-normal);
            margin-bottom: 0.5rem;
            cursor: pointer;
        }
        
        .sidebar-item.active {
            background-color: var(--coral-light);
            color: var(--abra-coral);
        }
        
        .sidebar-item:hover:not(.active) {
            background-color: var(--navy-light);
            color: var(--text-primary);
        }
        
        .sidebar-item i {
            width: 1.5rem;
            text-align: center;
            font-size: 1.125rem;
        }
        
        .expense-summary {
            background: var(--primary-gradient);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            color: white;
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .expense-summary::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-full);
            top: -75px;
            right: -75px;
        }
        
        .expense-summary h4 {
            color: white;
            margin-bottom: 1rem;
        }
        
        .expense-total {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .expense-items {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .expense-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Main Content */
        .main-content {
            background-color: var(--bg-tertiary);
            min-height: 100vh;
            position: relative;
            width: 100%;
        }
        
        .content-header {
            background: var(--bg-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .page-title {
            font-size: 1.75rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .page-title i {
            color: var(--abra-coral);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .theme-toggle .light-icon,
        .theme-toggle .dark-icon {
            position: absolute;
            transition: all var(--transition-normal) cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .theme-toggle .light-icon {
            transform: translateY(0) rotate(0);
            opacity: 1;
        }
        
        .theme-toggle .dark-icon {
            transform: translateY(20px) rotate(-90deg);
            opacity: 0;
        }
        
        [data-theme="dark"] .theme-toggle .light-icon {
            transform: translateY(-20px) rotate(90deg);
            opacity: 0;
        }
        
        [data-theme="dark"] .theme-toggle .dark-icon {
            transform: translateY(0) rotate(0);
            opacity: 1;
        }
        
        .content-wrapper {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Progress Tracker */
        .progress-tracker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.5rem;
            position: relative;
            width: 100%;
        }
        
        .progress-tracker::before {
            content: '';
            position: absolute;
            top: 30%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--border-color);
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .progress-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .step-indicator {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background-color: var(--bg-card);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            transition: all var(--transition-normal);
        }
        
        .progress-step.active .step-indicator {
            background-image: var(--primary-gradient);
            color: white;
            border-color: var(--abra-coral);
            box-shadow: 0 0 0 4px var(--coral-light);
        }
        
        .progress-step.completed .step-indicator {
            background-color: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .step-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .progress-step.active .step-label {
            color: var(--abra-coral);
            font-weight: 600;
        }
        
        /* Advanced Form Styles */
        .form-section {
            background-color: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            margin-bottom: 2.5rem;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
        }
        
        .form-section:hover {
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-header h2 {
            font-size: 1.5rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-header h2 i {
            color: var(--abra-coral);
        }
        
        .section-badge {
            background-color: var(--coral-light);
            color: var(--abra-coral);
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
        }
        
        .form-control {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            transition: all var(--transition-normal);
            font-size: 1rem;
        }
        
        .form-control:focus {
            border-color: var(--abra-coral);
            box-shadow: 0 0 0 3px var(--coral-light);
            outline: none;
        }
        
        .form-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }
        
        .input-group-text {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        /* Advanced Expense Cards */
        .expenses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .expense-card {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all var(--transition-normal);
            position: relative;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }
        
        .expense-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }
        
        .expense-type-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-weight: 500;
            font-size: 0.875rem;
            position: relative;
            z-index: 1;
            margin-bottom: 1rem;
        }
        
        .expense-type-fuel {
            background-color: var(--coral-light);
            color: var(--abra-coral);
        }
        
        .expense-type-route {
            background-color: var(--navy-light);
            color: var(--info);
        }
        
        .expense-type-parking {
            background-color: var(--pink-light);
            color: var(--abra-pink);
        }
        
        .expense-type-other {
            background-color: var(--yellow-light);
            color: var(--abra-yellow);
        }
        
        /* File Upload */
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            background-color: var(--bg-tertiary);
            margin-top: 1.5rem;
        }
        
        .file-drop-zone:hover, .file-drop-zone.drag-over {
            border-color: var(--abra-coral);
            background-color: var(--coral-light);
        }
        
        .file-drop-zone i {
            font-size: 2.5rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            transition: transform var(--transition-normal), color var(--transition-normal);
        }
        
        .file-drop-zone:hover i, .file-drop-zone.drag-over i {
            transform: translateY(-5px);
            color: var(--abra-coral);
        }
        
        .file-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .file-preview-item {
            position: relative;
            aspect-ratio: 1/1;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            cursor: pointer;
        }
        
        .file-preview-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
            z-index: 2;
        }
        
        .file-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform var(--transition-normal);
        }
        
        .file-preview-item:hover img {
            transform: scale(1.1);
        }
        
        .file-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: all var(--transition-normal);
        }
        
        .file-remove:hover {
            background-color: var(--error);
            transform: scale(1.1);
        }
        
        /* PDF Preview Item */
        .pdf-preview {
            background-color: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            aspect-ratio: 1/1;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            cursor: pointer;
        }
        
        .pdf-preview i {
            font-size: 2rem;
            color: #f40f02;
            margin-bottom: 0.5rem;
        }
        
        .pdf-preview span {
            font-size: 0.75rem;
            color: var(--text-primary);
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100%;
        }
        
        /* Signature Section */
        .signature-section {
            margin-top: 2rem;
        }
        
        .signature-container {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            margin-bottom: 1.5rem;
        }
        
        .signature-container:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }
        
        .signature-label {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .signature-label i {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--coral-light);
            color: var(--abra-coral);
            border-radius: var(--radius-full);
        }
        
        .signature-pad {
            width: 100%;
            height: 150px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-tertiary);
            cursor: crosshair;
            margin: 1.25rem;
            touch-action: none; /* Improve touch experience */
        }
        
        .signature-actions {
            display: flex;
            justify-content: flex-end;
            padding: 0 1.25rem 1.25rem;
        }
        
        .signature-button {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-normal);
            cursor: pointer;
        }
        
        .signature-button:hover {
            background-color: var(--coral-light);
            color: var(--abra-coral);
            border-color: var(--abra-coral);
            transform: translateY(-2px);
        }
        
        /* Action Bar */
        .floating-total {
            background-color: var(--bg-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 30;
            transition: all var(--transition-normal);
            min-height: 70px;
        }
        
        .submit-button {
            background-image: var(--primary-gradient);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(255, 119, 72, 0.3);
        }
        
        .submit-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(-100%);
            transition: transform var(--transition-normal);
        }
        
        .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(255, 119, 72, 0.4);
        }
        
        .submit-button:hover::before {
            transform: translateX(0);
        }
        
        /* Floating Action Button */
        .floating-action-button {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: var(--radius-full);
            background-image: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(255, 119, 72, 0.4);
            cursor: pointer;
            z-index: 20;
            transition: all var(--transition-bounce);
        }
        
        .floating-action-button:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 8px 30px rgba(255, 119, 72, 0.5);
        }
        
        /* Quick Add Menu */
        .quick-add-menu {
            position: absolute;
            bottom: 70px;
            right: 10px;
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            display: none;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 20;
            min-width: 180px;
            transform-origin: bottom right;
            transform: scale(0.9);
            opacity: 0;
            transition: all var(--transition-bounce);
        }
        
        .quick-add-menu.active {
            display: flex;
            transform: scale(1);
            opacity: 1;
        }
        
        .quick-add-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 500;
            transition: all var(--transition-normal);
            cursor: pointer;
        }
        
        .quick-add-item:hover {
            background-color: var(--bg-tertiary);
            transform: translateX(-5px);
        }
        
        .quick-add-item i {
            width: 24px;
            text-align: center;
        }
        
        /* Quick Add Bar */
        .quick-add-bar {
            margin-bottom: 2rem;
        }
        
        .quick-add-button {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all var(--transition-normal);
            cursor: pointer;
            font-weight: 500;
        }
        
        .quick-add-button:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            background-color: var(--coral-light);
            color: var(--abra-coral);
            border-color: var(--abra-coral);
        }
        
        .quick-add-button i {
            font-size: 1.125rem;
        }
        
        /* File Preview Overlay */
        .file-preview-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 1000;
            place-items: center;
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .file-preview-overlay.active {
            display: grid;
            opacity: 1;
        }
        
        .preview-content {
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            background-color: var(--bg-card);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-xl);
            display: flex;
            flex-direction: column;
            animation: modal-in var(--transition-bounce);
        }
        
        .close-preview {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-full);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: all var(--transition-normal);
        }
        
        .close-preview:hover {
            background-color: var(--error);
            transform: rotate(90deg);
        }
        
        .preview-container {
            padding: 2rem;
            overflow: auto;
            max-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-container img {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: var(--radius-md);
        }
        
        /* PDF Viewer */
        .pdf-viewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .pdf-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .pdf-canvas {
            max-width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            text-align: center;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-content {
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            animation: slideIn 0.3s ease-out;
        }
        
        .loading-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .pulse-loader {
            width: 48px;
            height: 48px;
            border: 4px solid var(--abra-coral);
            border-radius: 50%;
            margin: 0 auto 1rem;
            position: relative;
            animation: pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }
        
        /* Processing Overlay */
        .processing-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            color: white;
            z-index: 50;
        }
        
        .processing-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        /* Validation Styles */
        .invalid-signature {
            border: 2px solid var(--error) !important;
        }
        
        .invalid-drop-zone {
            border: 2px dashed var(--error) !important;
        }
        
        .invalid-feedback {
            display: none;
            color: var(--error);
            font-size: 0.875em;
            margin-top: 0.25rem;
        }
        
        .invalid-feedback.d-block {
            display: block;
        }
        
        /* Manager Review Styles */
        .manager-review-header {
            padding: 1rem 2rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }
        
        .approve-button {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-normal);
        }
        
        .approve-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            opacity: 0.9;
        }
        
        .reject-button {
            background-color: var(--error);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-normal);
        }
        
        .reject-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            opacity: 0.9;
        }
        
        /* Animation For Expanded Total */
        .expanded-total-content {
            width: 100%;
        }
        
        .category-totals {
            background: rgba(var(--bs-primary-rgb), 0.05);
            border-radius: 8px;
            padding: 10px;
        }
        
        .category-total-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .category-total-item:last-child {
            margin-bottom: 0;
        }
        
        .category-total-item i {
            margin-inline-end: 10px;
            width: 20px;
            text-align: center;
        }
        
        .category-total-item .category-amount {
            margin-inline-start: auto;
            font-weight: 500;
        }
        
        .grand-total {
            border-top: 1px solid rgba(var(--bs-primary-rgb), 0.2);
            margin-top: 6px;
            padding-top: 6px;
            font-weight: bold;
        }
        
        .btn-expand-total, .btn-collapse-total {
            background: none;
            border: none;
            color: var(--abra-coral);
            cursor: pointer;
            padding: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }
        
        /* Mobile Adaptations */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 0 1fr;
            }
            
            .sidebar {
                position: fixed;
                transform: translateX(-100%);
                box-shadow: var(--shadow-xl);
                z-index: 100;
                width: 280px;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                margin-right: 1rem;
                background: transparent;
                border: none;
                color: var(--text-primary);
                font-size: 1.5rem;
                width: 40px;
                height: 40px;
                border-radius: var(--radius-md);
                cursor: pointer;
            }
            
            .floating-total {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .content-wrapper {
                padding: 1.5rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .expenses-grid {
                grid-template-columns: 1fr;
            }
            
            .progress-tracker {
                overflow-x: auto;
                padding-bottom: 1rem;
                margin-bottom: 1.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .progress-step {
                flex-shrink: 0;
                min-width: 100px;
                max-width: 120px;
            }
            
            .preview-content {
                width: 95%;
                max-height: 85vh;
            }
            
            .floating-action-button {
                bottom: 5rem;
                right: 1.5rem;
            }
            
            .signature-pad {
                height: 120px;
            }
            
            .quick-add-bar .d-flex {
                overflow-x: auto;
                padding-bottom: 0.5rem;
                -webkit-overflow-scrolling: touch;
            }
            
            .quick-add-button {
                flex-shrink: 0;
                min-width: 130px;
            }
        }
        
        @media (max-width: 576px) {
            .content-header {
                padding: 1rem;
            }
            
            .page-title {
                font-size: 1.25rem;
            }
            
            .content-wrapper {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1.25rem;
                border-radius: var(--radius-lg);
                margin-bottom: 1.5rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .section-header h2 {
                font-size: 1.25rem;
            }
            
            .section-badge {
                align-self: flex-start;
            }
            
            .floating-action-button {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
                right: 1rem;
                bottom: 5rem;
            }
            
            .floating-total {
                padding: 0.75rem;
            }
            
            .expense-card .row {
                margin-right: -0.5rem;
                margin-left: -0.5rem;
            }
            
            .expense-card .col, 
            .expense-card .col-md-3, 
            .expense-card .col-md-4, 
            .expense-card .col-md-12 {
                padding-right: 0.5rem;
                padding-left: 0.5rem;
            }
            
            .file-preview {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 0.75rem;
            }
            
            input:focus, textarea:focus, select:focus {
                position: relative;
                z-index: 5;
            }
        }
        
        @media (max-width: 360px) {
            .content-header {
                padding: 0.75rem;
            }
            
            .page-title {
                font-size: 1.125rem;
            }
            
            .page-title i {
                font-size: 0.875rem;
            }
            
            .content-wrapper {
                padding: 0.75rem;
            }
            
            .form-section {
                padding: 1rem;
                border-radius: var(--radius-md);
            }
            
            .floating-action-button {
                width: 45px;
                height: 45px;
                font-size: 1.125rem;
                right: 0.75rem;
                bottom: 4.5rem;
            }
            
            .floating-total {
                padding: 0.5rem 0.75rem;
            }
            
            .step-indicator {
                width: 32px;
                height: 32px;
                font-size: 0.875rem;
            }
            
            .step-label {
                font-size: 0.75rem;
            }
            
            .file-preview {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Print styles optimization */
        @media print {
            .sidebar, 
            .floating-action-button, 
            .quick-add-menu, 
            .floating-total {
                display: none !important;
            }
            
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                width: 100%;
            }
            
            .content-header {
                position: static;
                box-shadow: none;
                border-bottom: 1px solid #ddd;
                padding: 1rem;
            }
            
            .content-wrapper {
                padding: 1rem;
            }
            
            .form-section {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
                margin-bottom: 1.5rem;
                padding: 1rem;
                transform: none !important;
            }
            
            body {
                background-color: white;
            }
        }
        
        /* Animations */
        @keyframes modal-in {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 119, 72, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(255, 119, 72, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(255, 119, 72, 0);
            }
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <img src="/abra logo FullColor blue PNG.png" alt="Abra Logo" class="company-logo">
                    <button class="theme-toggle" aria-label="Toggle dark mode" title="שינוי מצב תצוגה">
                        <i class="fas fa-sun light-icon"></i>
                        <i class="fas fa-moon dark-icon"></i>
                    </button>
                </div>
            </div>
            
            <!-- Expense Summary -->
            <div class="expense-summary">
                <h4>סיכום הוצאות</h4>
                <div class="expense-total">₪ <span id="sidebarTotalAmount">0.00</span></div>
                <div class="expense-items">
                    <div class="expense-item">
                        <i class="fas fa-gas-pump"></i>
                        <span id="fuelAmount">0.00</span>
                    </div>
                    <div class="expense-item">
                        <i class="fas fa-route"></i>
                        <span id="routeAmount">0.00</span>
                    </div>
                    <div class="expense-item">
                        <i class="fas fa-parking"></i>
                        <span id="parkingAmount">0.00</span>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Navigation -->
            <div class="sidebar-sections">
                <div class="sidebar-section">
                    <div class="sidebar-section-title">ניווט מהיר</div>
                    <div class="sidebar-item active">
                        <i class="fas fa-home"></i>
                        <span>מסך ראשי</span>
                    </div>
                    <div class="sidebar-item">
                        <i class="fas fa-history"></i>
                        <span>היסטוריית דוחות</span>
                    </div>
                    <div class="sidebar-item">
                        <i class="fas fa-cog"></i>
                        <span>הגדרות</span>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <div class="sidebar-section-title">הוספה מהירה</div>
                    <div class="sidebar-item" onclick="ExpenseBuilder.quickAdd('fuel')">
                        <i class="fas fa-gas-pump"></i>
                        <span>הוצאת רכב</span>
                    </div>
                    <div class="sidebar-item" onclick="ExpenseBuilder.quickAdd('route')">
                        <i class="fas fa-route"></i>
                        <span>החזר נסיעות</span>
                    </div>
                    <div class="sidebar-item" onclick="ExpenseBuilder.quickAdd('parking')">
                        <i class="fas fa-parking"></i>
                        <span>הוצאת חניה</span>
                    </div>
                    <div class="sidebar-item" onclick="ExpenseBuilder.quickAdd('other')">
                        <i class="fas fa-receipt"></i>
                        <span>הוצאה אחרת</span>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Content Header -->
            <header class="content-header">
                <div class="d-flex align-items-center">
                    <button class="sidebar-toggle" aria-label="Toggle sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title">
                        <i class="fas fa-file-invoice-dollar"></i>
                        דוח החזר הוצאות
                    </h1>
                </div>
                <div class="header-actions">
                    <button type="button" class="theme-toggle" aria-label="Toggle dark mode">
                        <i class="fas fa-sun light-icon"></i>
                        <i class="fas fa-moon dark-icon"></i>
                    </button>
                </div>
            </header>
            
            <!-- Content Wrapper -->
            <div class="content-wrapper">
                <!-- Progress Tracker -->
                <div class="progress-tracker">
                    <div class="progress-step active">
                        <div class="step-indicator">1</div>
                        <div class="step-label">פרטי הדוח</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-indicator">2</div>
                        <div class="step-label">הוצאות</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-indicator">3</div>
                        <div class="step-label">חתימות</div>
                    </div>
                    <div class="progress-step">
                        <div class="step-indicator">4</div>
                        <div class="step-label">סיכום</div>
                    </div>
                </div>
                
                <!-- Form Content -->
                <form id="expenseForm">
                    <!-- Basic Info Section -->
                    <section class="form-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-info-circle"></i>
                                פרטי הדוח
                            </h2>
                            <div class="section-badge">שלב 1 מתוך 4</div>
                        </div>
                        <div class="row g-4">
                            <div class="col-md-4">
                                <label class="form-label">חודש</label>
                                <input type="month" class="form-control" name="month" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">אימייל עובד/ת</label>
                                <input type="email" class="form-control" name="employeeEmail" placeholder="הזן את כתובת האימייל שלך" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">אימייל מנהל/ת ישיר</label>
                                <input type="email" class="form-control" name="managerEmail" placeholder="הזן את כתובת האימייל של המנהל/ת" required>
                            </div>
                            <div class="col-md-4" hidden>
                                <label class="form-label">חטיבה/מחלקה</label>
                                <input type="text" class="form-control" name="department">
                            </div>
                        </div>
                    </section>
                    
                    <!-- Quick Add Bar -->
                    <div class="quick-add-bar">
                        <div class="d-flex gap-3 flex-wrap">
                            <button type="button" class="quick-add-button" onclick="ExpenseBuilder.quickAdd('fuel')" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="הוסף הוצאת רכב - צרף תמונת קבלה לזיהוי אוטומטי של הפרטים">
                                <i class="fas fa-gas-pump"></i>
                                רכב
                            </button>
                            <button type="button" class="quick-add-button" onclick="ExpenseBuilder.quickAdd('route')" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="הוסף החזר קילומטרים">
                                <i class="fas fa-route"></i>
                                נסיעה
                            </button>
                            <button type="button" class="quick-add-button" onclick="ExpenseBuilder.quickAdd('parking')"
                                data-bs-toggle="tooltip" data-bs-placement="top"
                                title="הוסף הוצאת חניה - צרף קבלה או אישור תשלום">
                                <i class="fas fa-parking"></i>
                                חניה
                            </button>
                            <button type="button" class="quick-add-button" onclick="ExpenseBuilder.quickAdd('other')" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="הוסף הוצאה אחרת - למשל:  ציוד או הוצאות משרדיות">
                                <i class="fas fa-receipt"></i>
                                הוצאה אחרת
                            </button>
                        </div>
                    </div>
                    
                    <!-- Expenses Container -->
                    <div id="expensesContainer"></div>
                    
                    <!-- Signatures Section -->
                    <section class="form-section">
                        <div class="section-header">
                            <h2>
                                <i class="fas fa-signature"></i>
                                חתימות
                            </h2>
                            <div class="section-badge">שלב 3 מתוך 4</div>
                        </div>
                        
                        <div class="row g-4">
                            <!-- Employee Signature -->
                            <div class="col-md-6">
                                <div class="signature-container">
                                    <div class="signature-label">
                                        <i class="fas fa-user"></i>
                                        חתימת העובד
                                    </div>
                                    <canvas id="employeeSignature" class="signature-pad"></canvas>
                                    <div class="signature-actions">
                                        <button type="button" class="signature-button" onclick="SignatureManager.clearSignature('employeeSignature')">
                                            <i class="fas fa-eraser"></i>
                                            נקה חתימה
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Manager Signature -->
                            <div class="col-md-6">
                                <div class="signature-container">
                                    <div class="signature-label">
                                        <i class="fas fa-user-tie"></i>
                                        חתימת מנהל ישיר
                                    </div>
                                    <canvas id="managerSignature" class="signature-pad"></canvas>
                                    <div class="signature-actions">
                                        <button type="button" class="signature-button" onclick="SignatureManager.clearSignature('managerSignature')">
                                            <i class="fas fa-eraser"></i>
                                            נקה חתימה
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </form>
            </div>
            
            <!-- Floating Action Button -->
            <div class="floating-action-button" id="floatingActionButton">
                <i class="fas fa-plus"></i>
            </div>
            
            <!-- Quick Add Menu -->
            <div class="quick-add-menu" id="quickAddMenu">
                <div class="quick-add-item" onclick="ExpenseBuilder.quickAdd('fuel')">
                    <i class="fas fa-gas-pump"></i>
                    <span>הוצאת רכב</span>
                </div>
                <div class="quick-add-item" onclick="ExpenseBuilder.quickAdd('route')">
                    <i class="fas fa-route"></i>
                    <span>החזר נסיעות</span>
                </div>
                <div class="quick-add-item" onclick="ExpenseBuilder.quickAdd('parking')">
                    <i class="fas fa-parking"></i>
                    <span>הוצאת חניה</span>
                </div>
                <div class="quick-add-item" onclick="ExpenseBuilder.quickAdd('other')">
                    <i class="fas fa-receipt"></i>
                    <span>הוצאה אחרת</span>
                </div>
            </div>
            
            <!-- Floating Total -->
            <div class="floating-total" data-state="collapsed">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div class="d-flex align-items-center">
                        <div>
                            סה"כ: <span id="totalAmount">0.00</span> ₪
                        </div>
                        <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
                            <i class="fas fa-chevron-up"></i>
                        </button>
                    </div>
                    <button type="submit" form="expenseForm" class="submit-button">
                        <i class="fas fa-paper-plane"></i>
                        שלח דוח
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- File Preview Overlay -->
    <div id="filePreviewOverlay" class="file-preview-overlay">
        <div class="preview-content">
            <button type="button" class="close-preview" onclick="closePreview()">
                <i class="fas fa-times"></i>
            </button>
            <div class="preview-container">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
    
    <script>
    // Global function that works even before the app is initialized
    function quickAdd(type) {
        console.log("quickAdd called with type:", type);
        
        // If we already have ExpenseBuilder initialized, use it directly
        if (window.ExpenseBuilder && typeof window.ExpenseBuilder.quickAdd === 'function') {
            window.ExpenseBuilder.quickAdd(type);
            return;
        }
        
        // Otherwise, store the request for later processing
        if (!window._pendingQuickAdds) {
            window._pendingQuickAdds = [];
            
            // Set up a processor for pending requests that runs after initialization
            const originalInit = window.onload || function(){};
            window.onload = function() {
                originalInit();
                if (window.ExpenseBuilder && window._pendingQuickAdds) {
                    window._pendingQuickAdds.forEach(pendingType => {
                        window.ExpenseBuilder.quickAdd(pendingType);
                    });
                    window._pendingQuickAdds = [];
                }
            };
        }
        
        // Add this request to the pending list
        window._pendingQuickAdds.push(type);
    }
    
    // Function to close preview overlay
    function closePreview() {
        const overlay = document.getElementById('filePreviewOverlay');
        if (overlay) {
            overlay.classList.remove('active');
            document.removeEventListener('keydown', handleEscKey);
        }
    }
    
    // Handle escape key press
    function handleEscKey(e) {
        if (e.key === 'Escape') {
            closePreview();
        }
    }
    
    /**
     * Optimized Expense Report Application
     * 
     * A modular JavaScript application for managing expense reports
     * Improved for performance, maintainability, and user experience
     */
    
    // Use an IIFE to avoid polluting the global scope
    (function() {
        'use strict';
        
        // ============= CONSTANTS =============
        const GEMINI_API_KEY = 'AIzaSyDixJ-7jmpArj67qP5mbT95roaO6gvCES4';
        const API_ENDPOINT = 'https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke';
        const API_PARAMS = 'api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs';
        
        // ============= CORE APP MODULE =============
        const ExpenseApp = {
            // Core app state
            state: {
                mode: 'new', // 'new' or 'review'
                id: null,
                categoryTotals: {
                    fuel: 0,
                    route: 0,
                    parking: 0,
                    other: 0
                },
                initialized: false
            },
    
            // Initialize the application
            init() {
                if (this.state.initialized) return;
                
                // Set initial state from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.state.id = urlParams.get('id');
                this.state.mode = this.state.id ? 'review' : 'new';
    
                // Initialize modules in order of dependency
                UIManager.init();
                SignatureManager.init();
                FileHandler.init();
                PdfRenderer.init();
                ValidationManager.init();
                FormHandler.init();
                
                // Initialize appropriate mode
                if (this.state.mode === 'review') {
                    this.initializeReviewMode();
                } else {
                    this.initializeNewSubmissionMode();
                }
                
                // Register global event listeners
                this.registerEventListeners();
                
                // Mark as initialized
                this.state.initialized = true;
            },
    
            // Initialize review mode
            async initializeReviewMode() {
                try {
                    const progressTracker = UIManager.createTimingProgressIndicator('טוען נתוני דוח...');
                    
                    const fetchPromise = ApiService.getExpenseReport(this.state.id);
                    const response = await progressTracker.updateFetchProgress(fetchPromise);
                    const data = await response.json();
                    
                    DataManager.populateExpenseReport(data);
                    UIManager.setupManagerReviewMode(data);
                    
                    progressTracker.close();
                } catch (error) {
                    console.error('Error fetching expense report:', error);
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('שגיאה בטעינת הדוח: ' + error.message, 'error');
                }
            },
    
            // Initialize new submission mode
            initializeNewSubmissionMode() {
                // Set current month as default
                FormHandler.setDefaultMonth();
                
                // Configure UI for new submission
                UIManager.configureForNewSubmission();
                
                // Initialize category tracking
                this.resetCategoryTotals();
            },
    
            // Register global event listeners
            registerEventListeners() {
                // Form submission handler
                document.getElementById('expenseForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    if (this.state.mode === 'review') {
                        await FormHandler.handleManagerApprove(e);
                    } else {
                        await FormHandler.handleNewSubmission(e);
                    }
                });
                
                // Theme toggler
                document.querySelectorAll('.theme-toggle').forEach(toggle => {
                    toggle.addEventListener('click', UIManager.toggleTheme);
                });
                
                // Global input handler for expense amounts with debounce
                const debounceTimeout = 300; // ms
                let debounceTimer;
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('expense-amount')) {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            const card = e.target.closest('.expense-card');
                            if (card) {
                                const expenseType = card.dataset.expenseType || 'other';
                                ExpenseCalculator.updateExpenseAmount(e.target, expenseType);
                            }
                        }, debounceTimeout);
                    }
                });
                
                // Progress update on required field changes
                document.querySelectorAll('[required]').forEach(field => {
                    field.addEventListener('change', FormHandler.updateProgress);
                });
                
                // Floating action button and quick add menu
                const fab = document.getElementById('floatingActionButton');
                const quickAddMenu = document.getElementById('quickAddMenu');
                
                fab.addEventListener('click', function() {
                    quickAddMenu.classList.toggle('active');
                });
                
                // Close quick add menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!fab.contains(event.target) && !quickAddMenu.contains(event.target)) {
                        quickAddMenu.classList.remove('active');
                    }
                });
                
                // Mobile sidebar toggle
                const sidebarToggle = document.querySelector('.sidebar-toggle');
                const sidebar = document.querySelector('.sidebar');
                
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                });
                
                // Close sidebar when clicking outside (mobile)
                document.addEventListener('click', function(event) {
                    if (window.innerWidth <= 1024) {
                        if (!sidebar.contains(event.target) && !sidebarToggle.contains(event.target) && sidebar.classList.contains('active')) {
                            sidebar.classList.remove('active');
                        }
                    }
                });
            },
    
            // Reset category totals
            resetCategoryTotals() {
                this.state.categoryTotals = {
                    fuel: 0,
                    route: 0,
                    parking: 0,
                    other: 0
                };
                ExpenseCalculator.updateLiveTotal();
            }
        };
    
        // ============= UI MANAGER MODULE =============
        const UIManager = {
            tooltipInstances: new Map(),
            loadingOverlays: [],
            
            init() {
                this.setupTheme();
                this.initTooltips();
                this.setupHeaderBehavior();
                this.addValidationStyles();
            },
            
            // Setup initial theme
            setupTheme() {
                // Check user preference or stored setting
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                } else if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
            },
            
            // Toggle theme between light and dark
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update signature colors and re-render any visible signatures
                SignatureManager.updateSignatureColors();
            },
            
            // Initialize tooltips
            initTooltips() {
                // Clear existing tooltip instances
                this.tooltipInstances.forEach(instance => {
                    if (instance && typeof instance.dispose === 'function') {
                        instance.dispose();
                    }
                });
                this.tooltipInstances.clear();
                
                // Create new tooltips with improved performance
                const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                tooltips.forEach(element => {
                    const instance = new bootstrap.Tooltip(element, {
                        trigger: 'hover focus',
                        boundary: 'window',
                        delay: { show: 500, hide: 100 }
                    });
                    this.tooltipInstances.set(element, instance);
                });
                
                // Add helpful tooltips to form elements
                this.addHelpfulTooltips();
            },
            
            // Add helpful tooltips to key form elements
            addHelpfulTooltips() {
                const tooltipMappings = [
                    { selector: 'input[name="month"]', title: 'בחר את החודש עבורו מוגש הדוח' },
                    { selector: 'input[name="employeeEmail"]', title: 'הזן את כתובת המייל שלך כפי שהיא רשומה במערכת' },
                    { selector: 'input[name="managerEmail"]', title: 'הזן את כתובת המייל של המנהל הישיר שלך שיאשר את ההוצאות' },
                    { selector: 'input[name="department"]', title: 'בחר את המחלקה או החטיבה אליה אתה שייך' },
                    { selector: '.signature-pad', title: 'חתום כאן - לחץ והחזק את העכבר תוך כדי ציור החתימה' }
                ];
                
                tooltipMappings.forEach(mapping => {
                    const elements = document.querySelectorAll(mapping.selector);
                    elements.forEach(element => {
                        if (!element.hasAttribute('data-bs-toggle')) {
                            element.setAttribute('data-bs-toggle', 'tooltip');
                            element.setAttribute('data-bs-placement', 'top');
                            element.setAttribute('title', mapping.title);
                            
                            // Create tooltip instance
                            const instance = new bootstrap.Tooltip(element, {
                                trigger: 'hover focus',
                                boundary: 'window',
                                delay: { show: 500, hide: 100 }
                            });
                            this.tooltipInstances.set(element, instance);
                        }
                    });
                });
            },
            
            // Setup header behavior with Intersection Observer
            setupHeaderBehavior() {
                const header = document.querySelector('.content-header');
                if (!header) return;
                
                // Use IntersectionObserver for better performance
                const headerObserver = new IntersectionObserver(
                    (entries) => {
                        entries.forEach(entry => {
                            if (!entry.isIntersecting) {
                                entry.target.classList.add('scrolled');
                            } else {
                                entry.target.classList.remove('scrolled');
                            }
                        });
                    },
                    { threshold: [0, 0.1, 1], rootMargin: '-50px 0px 0px 0px' }
                );
                
                headerObserver.observe(header);
            },
            
            // Configure UI for new submission
            configureForNewSubmission() {
                // Update employee name field label and placeholder
                const employeeEmailInput = document.querySelector('input[name="employeeEmail"]');
                if (employeeEmailInput) {
                    const label = employeeEmailInput.previousElementSibling;
                    if (label) label.textContent = 'אימייל עובד/ת';
                    employeeEmailInput.placeholder = 'הזן את כתובת האימייל שלך';
                    employeeEmailInput.type = 'email';
                }
    
                // Update manager email field placeholder
                const managerEmailInput = document.querySelector('input[name="managerEmail"]');
                if (managerEmailInput) {
                    managerEmailInput.placeholder = 'הזן את כתובת האימייל של המנהל/ת';
                    managerEmailInput.type = 'email';
                }
    
                // Configure signature sections
                this.configureSignatureSections();
                
                // Update progress steps
                this.updateProgressSteps(1);
            },
            
            // Configure signature sections for new submission
            configureSignatureSections() {
                // Show only employee signature in new submission mode
                document.querySelectorAll('.signature-container').forEach((section, index) => {
                    if (index === 0) {
                        // First is employee signature - show it
                        section.style.display = 'block';
                    } else {
                        // Others (manager) - hide them
                        section.style.display = 'none';
                    }
                });
    
                // Adjust canvas dimensions for proper display
                SignatureManager.adjustCanvasDimensions('employeeSignature');
            },
            
            // Setup manager review mode UI
            setupManagerReviewMode(data) {
                // Get status from the response
                const status = data.expense_main[0].Status.Value;
                const isFinalized = status === 'Approved' || status === 'Rejected';
                
                // Create or update status header
                this.createManagerReviewHeader(status);
                
                // Update form fields
                this.configureReviewModeFields();
                
                // Handle signatures based on status
                SignatureManager.configureSignaturesForReviewMode(isFinalized);
                
                // Update floating total section
                this.updateFloatingTotalForReviewMode(isFinalized);
                
                // Hide unnecessary elements
                this.hideElementsInReviewMode();
                
                // Add manager review class to body for CSS targeting
                document.body.classList.add('manager-review-mode');
                if (status === 'Approved') document.body.classList.add('status-approved');
                if (status === 'Rejected') document.body.classList.add('status-rejected');
                
                // Update total with animation
                ExpenseCalculator.updateLiveTotal();
                
                // Update progress bar
                FormHandler.updateProgress();
                
                // Update progress steps
                this.updateProgressSteps(3);
            },
            
            // Create manager review header with status
            createManagerReviewHeader(status) {
                // First check if header already exists to avoid duplicates
                const existingHeader = document.querySelector('.manager-review-header');
                if (existingHeader) existingHeader.remove();
                
                // Create the header element
                const header = document.createElement('div');
                header.className = 'alert alert-info manager-review-header';
                header.style.margin = '0';
                header.style.borderRadius = '0';
                
                // Set header text based on status
                let headerText = '';
                if (status === 'Approved') {
                    headerText = 'הדוח אושר על ידי המנהל';
                    header.className = 'alert alert-success manager-review-header';
                } else if (status === 'Rejected') {
                    headerText = 'הדוח נדחה על ידי המנהל';
                    header.className = 'alert alert-danger manager-review-header';
                } else {
                    headerText = 'הנך מתבקש/ת לסקור את הדוח ולחתום כמנהל/ת ישיר/ה';
                }
                
                header.innerHTML = `
                    <div class="container">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <div>${headerText}</div>
                        </div>
                    </div>
                `;
    
                const mainHeader = document.querySelector('.content-header');
                if (mainHeader) {
                    mainHeader.parentNode.insertBefore(header, mainHeader.nextSibling);
                }
            },
            
            // Configure form fields for review mode
            configureReviewModeFields() {
                // Update employee email field
                const employeeEmailInput = document.querySelector('input[name="employeeEmail"]');
                if (employeeEmailInput) {
                    const employeeEmailLabel = employeeEmailInput.previousElementSibling;
                    if (employeeEmailLabel) employeeEmailLabel.textContent = 'אימייל עובד/ת';
                    employeeEmailInput.type = 'email';
                    employeeEmailInput.placeholder = '';
                }
                
                // Update manager email field
                const managerEmailInput = document.querySelector('input[name="managerEmail"]');
                if (managerEmailInput) {
                    const managerEmailLabel = managerEmailInput.previousElementSibling;
                    if (managerEmailLabel) managerEmailLabel.textContent = 'אימייל מנהל/ת ישיר';
                    managerEmailInput.type = 'email';
                    managerEmailInput.placeholder = '';
                }
    
                // Show the department field that's hidden by default
                const departmentField = document.querySelector('input[name="department"]').closest('.col-md-4');
                if (departmentField) {
                    departmentField.removeAttribute('hidden');
                }
    
                // Make form fields readonly
                document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="month"]').forEach(input => {
                    input.readOnly = true;
                });
            },
                
            // Update floating total section for review mode
            updateFloatingTotalForReviewMode(isFinalized) {
                const floatingTotal = document.querySelector('.floating-total');
                if (!floatingTotal) return;
                
                if (isFinalized) {
                    // If approved/rejected, show total with expand option
                    floatingTotal.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center">
                                <div>
                                    סה"כ: <span id="totalAmount">0.00</span> ₪
                                </div>
                                <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // Show approve/reject buttons for pending review with expand option
                    floatingTotal.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between w-100">
                            <div class="d-flex align-items-center">
                                <div>
                                    סה"כ: <span id="totalAmount">0.00</span> ₪
                                </div>
                                <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
                                    <i class="fas fa-chevron-up"></i>
                                </button>
                            </div>
                            <div class="d-flex gap-3">
                                <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                                    <i class="fas fa-times"></i> דחה דוח
                                </button>
                                <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                                    <i class="fas fa-check"></i> אשר דוח
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                // Set initial state and add event handlers
                floatingTotal.dataset.state = 'collapsed';
                ExpenseCalculator.setupTotalClickHandlers(floatingTotal);
            },
            
            // Hide unnecessary elements in review mode
            hideElementsInReviewMode() {
                const elementsToHide = [
                    '.quick-add-bar',
                    '.floating-action-button',
                    '.quick-add-menu',
                    'button[type="button"].btn-outline-danger',
                    '.file-drop-zone',
                    '.file-remove:not([disabled])'
                ];
    
                elementsToHide.forEach(selector => {
                    document.querySelectorAll(selector).forEach(el => {
                        el.style.display = 'none';
                    });
                });
            },
            
            // Show notification toast
            showNotification(message, type = 'info') {
                // Map Bootstrap alert types to SweetAlert2 types
                const swalType = type === 'danger' ? 'error' : type;
                
                return Swal.fire({
                    title: '',
                    text: message,
                    icon: swalType,
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 5000,
                    timerProgressBar: true,
                    didOpen: (toast) => {
                        toast.addEventListener('mouseenter', Swal.stopTimer);
                        toast.addEventListener('mouseleave', Swal.resumeTimer);
                    }
                });
            },
            
            // Update progress steps
            updateProgressSteps(activeStep) {
                const steps = document.querySelectorAll('.progress-step');
                steps.forEach((step, index) => {
                    step.classList.remove('active', 'completed');
                    if (index + 1 === activeStep) {
                        step.classList.add('active');
                    } else if (index + 1 < activeStep) {
                        step.classList.add('completed');
                    }
                });
            },
            
            // Show loading overlay with progress tracking
            showLoadingOverlay(initialMessage = 'טוען נתונים...') {
                this.removeExistingOverlays();
    
                const stages = [
                    { id: 'queued', label: 'בתור לעיבוד', icon: 'clock' },
                    { id: 'connecting', label: 'מתחבר לשרת', icon: 'link' },
                    { id: 'processing', label: 'מעבד נתונים', icon: 'cog' },
                    { id: 'downloading', label: 'מוריד תוכן', icon: 'download' }
                ];
    
                const overlay = document.createElement('div');
                overlay.className = 'loading-overlay';
                overlay.setAttribute('role', 'dialog');
                overlay.setAttribute('aria-label', initialMessage);
    
                const content = document.createElement('div');
                content.className = 'loading-content';
                
                content.innerHTML = `
                    <div class="loading-header">
                        <div class="pulse-loader" aria-hidden="true"></div>
                        <h5>${initialMessage}</h5>
                    </div>
                    <div class="stages-container">
                        ${stages.map((stage) => `
                            <div class="stage-item" data-stage="${stage.id}">
                                <div class="stage-content">
                                    <div class="stage-icon">
                                        <i class="fas fa-${stage.icon}" aria-hidden="true"></i>
                                    </div>
                                    <div class="stage-details">
                                        <div class="stage-header">
                                            <span class="stage-label">${stage.label}</span>
                                            <div class="stage-meta">
                                                <span class="stage-duration">0ms</span>
                                                <span class="stage-status-dot" aria-hidden="true"></span>
                                            </div>
                                        </div>
                                        <div class="stage-progress">
                                            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
    
                overlay.appendChild(content);
                document.body.appendChild(overlay);
                
                // Store for cleanup
                this.loadingOverlays.push(overlay);
    
                // Return control API
                return {
                    updateStage: (stageId, progress) => {
                        const stageElement = overlay.querySelector(`[data-stage="${stageId}"]`);
                        if (!stageElement) return;
    
                        // Update progress bar
                        const progressBar = stageElement.querySelector('.progress-bar');
                        if (progressBar) {
                            progressBar.style.width = `${progress}%`;
                            progressBar.setAttribute('aria-valuenow', progress);
                        }
    
                        // Mark as active
                        stageElement.classList.add('active');
    
                        // Mark as completed if 100%
                        if (progress === 100) {
                            stageElement.classList.add('completed');
                            
                            // Animate to next stage
                            const nextStage = stageElement.nextElementSibling;
                            if (nextStage) {
                                setTimeout(() => {
                                    nextStage.classList.add('active');
                                }, 300);
                            }
                        }
                    },
                    setMessage: (message) => {
                        const messageElement = content.querySelector('h5');
                        if (messageElement) {
                            messageElement.textContent = message;
                            overlay.setAttribute('aria-label', message);
                        }
                    },
                    close: () => {
                        overlay.style.opacity = '0';
                        overlay.addEventListener('transitionend', () => {
                            overlay.remove();
                            const index = this.loadingOverlays.indexOf(overlay);
                            if (index > -1) this.loadingOverlays.splice(index, 1);
                        });
                    }
                };
            },
            
            // Add validation styles
            addValidationStyles() {
                if (document.getElementById('validation-styles')) return;
                
                const style = document.createElement('style');
                style.id = 'validation-styles';
                style.textContent = `
                    .invalid-signature {
                        border: 2px solid var(--error) !important;
                    }
                    
                    .invalid-drop-zone {
                        border: 2px dashed var(--error) !important;
                    }
                    
                   .invalid-feedback {
                        display: none;
                        color: var(--error);
                        font-size: 0.875em;
                        margin-top: 0.25rem;
                    }
                    
                    .invalid-feedback.d-block {
                        display: block;
                    }
                `;
                
                document.head.appendChild(style);
            },
            
            // Remove existing overlays
            removeExistingOverlays() {
                this.loadingOverlays.forEach(overlay => overlay.remove());
                this.loadingOverlays = [];
            },
            
            // Hide loading overlay
            hideLoadingOverlay() {
                this.removeExistingOverlays();
            },
            
            // Open file preview
            openPreview(element) {
                const overlay = document.getElementById('filePreviewOverlay');
                if (!overlay) return;
                
                const container = overlay.querySelector('.preview-container');
                if (!container) return;
    
                // Clear previous content
                container.innerHTML = '';
    
                try {
                    if (element.tagName === 'IMG') {
                        // Handle image preview
                        container.classList.remove('pdf-mode');
                        const img = document.createElement('img');
                        img.src = element.src;
                        img.alt = 'תצוגה מקדימה';
                        container.appendChild(img);
                    } else if (element.classList.contains('pdf-preview')) {
                        // Handle PDF preview
                        container.classList.add('pdf-mode');
                        
                        // First check for base64 data (review mode)
                        const fileData = element.closest('.file-preview-item')?.dataset.originalFile;
                        if (fileData) {
                            // In review mode - use the base64 data
                            PdfRenderer.renderPDF(fileData, container);
                        } else {
                            // In upload mode - use the object URL
                            const pdfUrl = element.dataset.pdfUrl;
                            if (!pdfUrl) {
                                throw new Error('PDF data not found');
                            }
                            PdfRenderer.renderPDF(pdfUrl, container);
                        }
                    }
    
                    // Show overlay with animation
                    overlay.classList.add('active');
    
                    // Add keyboard listener for escape key
                    document.addEventListener('keydown', handleEscKey);
                } catch (error) {
                    console.error('Preview error:', error);
                    this.showNotification('שגיאה בטעינת התצוגה המקדימה: ' + error.message, 'error');
                }
            },
            
            // Create timing progress indicator for loading operations
            createTimingProgressIndicator(initialMessage) {
                const startTime = performance.now();
                const progress = this.showLoadingOverlay(initialMessage);
    
                function formatDuration(ms) {
                    if (ms < 1000) return `${Math.round(ms)}ms`;
                    const seconds = ms / 1000;
                    if (seconds < 60) return `${seconds.toFixed(1)}s`;
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = (seconds % 60).toFixed(0);
                    return `${minutes}:${remainingSeconds.padStart(2, '0')}`;
                }
    
                return {
                    updateFetchProgress: async (fetchPromise) => {
                        try {
                            // Start connection phase
                            progress.updateStage('queued', 100);
                            progress.updateStage('connecting', 0);
                            
                            const response = await fetchPromise;
                            const clonedResponse = response.clone();
                            
                            // Connection complete, start processing
                            progress.updateStage('connecting', 100);
                            progress.updateStage('processing', 50);
    
                            const reader = response.body.getReader();
                            const contentLength = +response.headers.get('Content-Length') || 0;
                            let receivedLength = 0;
    
                            // Start download phase
                            progress.updateStage('processing', 100);
                            progress.updateStage('downloading', 0);
    
                            // Read the stream
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
    
                                receivedLength += value.length;
                                const downloadProgress = contentLength ? 
                                    Math.round((receivedLength / contentLength) * 100) : 
                                    50;
    
                                progress.updateStage('downloading', downloadProgress);
                                
                                // Update elapsed time
                                const elapsed = formatDuration(performance.now() - startTime);
                                progress.setMessage(`טוען נתוני דוח... (${elapsed})`);
                            }
    
                            // Complete download phase
                            progress.updateStage('downloading', 100);
    
                            return clonedResponse;
                        } catch (error) {
                            throw error;
                        }
                    },
                    close: () => progress.close()
                };
            }
        };
    
        // ============= DATA MANAGER MODULE =============
        const DataManager = {
            // Populate expense report with retrieved data
            populateExpenseReport(data) {
                // Update form fields with data
                document.querySelector('input[name="month"]').value = data.expense_main[0].Month;
                document.querySelector('input[name="employeeEmail"]').value = data.expense_main[0].EmployeeName.Email || '';
                document.querySelector('input[name="managerEmail"]').value = data.expense_main[0].Approver.Email || '';
                document.querySelector('input[name="department"]').value = data.expense_main[0].EmployeeName.Department;
    
                // Populate expenses
                this.populateExpenseItems(data.expense_items);
                
                // Handle signatures
                this.populateSignatures(data.data?.signatures);
                
                // Handle attached files
                this.populateAttachedFiles(data.data?.files);
                
                // Update progress bar
                FormHandler.updateProgress();
            },
            
            // Populate expense items
            populateExpenseItems(items) {
                const container = document.getElementById('expensesContainer');
                container.innerHTML = ''; // Clear existing expenses
                
                // Reset category totals before populating
                ExpenseApp.resetCategoryTotals();
    
                // Add expense items
                items.forEach(item => {
                    let expenseType = 'other';
                    if (item.ExpenseType?.toLowerCase().includes('רכב')) {
                        expenseType = 'fuel';
                    } else if (item.ExpenseType?.toLowerCase().includes('חניה')) {
                        expenseType = 'parking';
                    } else if (item.ExpenseType?.toLowerCase().includes('נסיעה')) {
                        expenseType = 'route';
                    }
                    
                    ExpenseBuilder.quickAdd(expenseType);
                    const card = container.firstElementChild;
                    if (!card) return;
                    
                    card.dataset.expenseId = item.ID;
                    card.dataset.expenseType = expenseType;
                    
                    // Populate fields
                    this.populateExpenseItemFields(card, item);
                });
    
                // Update total and category breakdowns
                ExpenseCalculator.updateLiveTotal();
            },
            
            // Populate fields for a single expense item
            populateExpenseItemFields(card, item) {
                // Convert and set date
                let expenseDate = '';
                if (item.ExpenseDate) {
                    try {
                        const date = new Date(item.ExpenseDate);
                        expenseDate = date.toLocaleDateString('en-CA');
                    } catch (error) {
                        console.warn('Invalid date format:', item.ExpenseDate);
                    }
                }
                
                // Get all inputs
                const dateInput = card.querySelector('input[type="date"]');
                const invoiceInput = card.querySelector('input[placeholder="הזן מספר חשבונית"]');
                const amountInput = card.querySelector('.expense-amount');
                const notesInput = card.querySelector('#note');
                
                // Set values and make readonly
                if (dateInput) {
                    dateInput.value = expenseDate;
                    dateInput.readOnly = true;
                }
                
                if (invoiceInput) {
                    invoiceInput.value = item.InvoiceNumber || '';
                    invoiceInput.readOnly = true;
                }
                
                if (amountInput) {
                    const amount = parseFloat(item.Amount) || 0;
                    amountInput.value = amount;
                    amountInput.readOnly = true;
                    
                    // Add to category total
                    const expenseType = card.dataset.expenseType;
                    ExpenseApp.state.categoryTotals[expenseType] += amount;
                }
                
                if (notesInput) {
                    notesInput.value = item.notes || '';
                    notesInput.readOnly = true;
                }
            },
            
            // Populate signatures from retrieved data
            populateSignatures(signatures) {
                if (!signatures || !Array.isArray(signatures)) return;
                
                signatures.forEach(sig => {
                    if (sig.file && sig.id) {
                        let padId;
                        // Match signature to correct pad
                        if (sig.id.toLowerCase().includes('empsig')) {
                            padId = 'employeeSignature';
                        } else if (sig.id.toLowerCase().includes('mngrsig')) {
                            padId = 'managerSignature';
                        } 
    
                        if (padId && SignatureManager.signaturePads[padId]) {
                            const canvas = SignatureManager.signaturePads[padId].canvas;
                            // Store original data
                            canvas.dataset.originalSignature = sig.file;
                            canvas.dataset.signatureId = sig.id;
                            // Draw signature
                            SignatureManager.drawSignatureToCanvas(canvas, sig.file, SignatureManager.signaturePads[padId]);
                        }
                    }
                });
            },
            
            // Populate attached files from retrieved data
            populateAttachedFiles(files) {
                if (!files || !Array.isArray(files)) return;
                
                const container = document.getElementById('expensesContainer');
                if (!container) return;
                
                files.forEach(fileData => {
                    if (fileData.file && fileData.id) {
                        const card = container.querySelector(`[data-expense-id="${fileData.id}"]`);
                        if (!card) return;
    
                        const previewContainer = card.querySelector('.file-preview');
                        if (!previewContainer) return;
    
                        FileHandler.addFilePreview(previewContainer, fileData);
                    }
                });
            },
            
            // Collect all expense data for submission
            async collectExpenseData() {
                const expenses = [];
                
                // Process each expense card
                for (const card of document.querySelectorAll('.expense-card')) {
                    const type = card.querySelector('.expense-type-indicator')?.textContent.trim();
                    const fileElements = card.querySelectorAll('.file-preview-item');
                    const files = [];
    
                    // Process each file
                    for (const el of fileElements) {
                        const fileData = await FileHandler.getFileData(el);
                        if (fileData) {
                            files.push(fileData);
                        }
                    }
    
                    expenses.push({
                        type: type,
                        date: card.querySelector('input[type="date"]')?.value || '',
                        invoice: card.querySelector('input[placeholder="הזן מספר חשבונית"]')?.value || '',
                        amount: parseFloat(card.querySelector('.expense-amount')?.value) || 0,
                        notes: card.querySelector('#note')?.value || '',
                        files: files
                    });
                }
                
                return expenses;
            }
        };
    
        // ============= FORM HANDLER MODULE =============
        const FormHandler = {
            init() {
                // Register form-specific event listeners
                this.registerFormEventListeners();
            },
            
            // Register form-specific event listeners
            registerFormEventListeners() {
                // Update progress when required fields change
                document.querySelectorAll('[required]').forEach(field => {
                    field.addEventListener('change', this.updateProgress);
                });
            },
            
            // Set default month value for new submissions
            setDefaultMonth() {
                const today = new Date();
                const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                document.querySelector('input[name="month"]').value = month;
            },
            
            // Update progress based on form completion
            updateProgress() {
                const form = document.getElementById('expenseForm');
                if (!form) return;
                
                const totalFields = form.querySelectorAll('[required]').length;
                const filledFields = Array.from(form.querySelectorAll('[required]')).filter(field => field.value).length;
                
                // Calculate signature completeness
                let signatureCount = 0;
                let filledSignatures = 0;
                
                if (ExpenseApp.state.mode === 'review') {
                    // In review mode, only count manager signature
                    signatureCount = 1;
                    filledSignatures = SignatureManager.signaturePads.managerSignature && 
                                      !SignatureManager.signaturePads.managerSignature.isEmpty() ? 1 : 0;
                } else {
                    // In new submission mode, only count employee signature
                    signatureCount = 1;
                    filledSignatures = SignatureManager.signaturePads.employeeSignature && 
                                      !SignatureManager.signaturePads.employeeSignature.isEmpty() ? 1 : 0;
                }
    
                // Calculate total progress
                const fieldWeight = 0.7;
                const signatureWeight = 0.3;
                const fieldProgress = totalFields > 0 ? (filledFields / totalFields) * fieldWeight : 0;
                const signatureProgress = signatureCount > 0 ? (filledSignatures / signatureCount) * signatureWeight : 0;
                const progress = (fieldProgress + signatureProgress) * 100;
    
                // Update the progress bar in the progress tracker
                const activeStep = document.querySelector('.progress-step.active');
                const activeStepNumber = activeStep ? parseInt(activeStep.querySelector('.step-indicator').textContent) : 1;
                
                // Update the step positions based on active step
                UIManager.updateProgressSteps(activeStepNumber);
                
                // Update the progress bar in bootstrap style
                const progressBar = document.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                    progressBar.setAttribute('aria-valuenow', progress);
                }
            },
            
            // Validate the entire form
            validateForm() {
                const form = document.getElementById('expenseForm');
                const isReviewMode = ExpenseApp.state.mode === 'review';
                let isValid = true;
    
                // Clear all existing validation errors first
                document.querySelectorAll('.is-invalid').forEach(el => {
                    ValidationManager.clearValidationError(el);
                });
    
                // Validate required fields
                const requiredFields = form.querySelectorAll('[required]');
                requiredFields.forEach(field => {
                    if (!field.value) {
                        isValid = ValidationManager.handleValidationError(field, 'שדה חובה');
                    }
                });
    
                // Validate email format
                const emailInputs = form.querySelectorAll('input[type="email"]');
                emailInputs.forEach(emailInput => {
                    if (emailInput && emailInput.value) {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(emailInput.value)) {
                            isValid = ValidationManager.handleValidationError(emailInput, 'כתובת אימייל לא תקינה');
                        }
                    }
                });
    
                // Validate expenses exist
                const expenseCards = document.querySelectorAll('.expense-card');
                if (expenseCards.length === 0) {
                    UIManager.showNotification('יש להוסיף לפחות הוצאה אחת', 'warning');
                    isValid = false;
                }
    
                // Validate expense amounts
                expenseCards.forEach(card => {
                    const amountInput = card.querySelector('.expense-amount');
                    if (amountInput && (isNaN(amountInput.value) || parseFloat(amountInput.value) <= 0)) {
                        isValid = ValidationManager.handleValidationError(amountInput, 'יש להזין סכום חיובי');
                    }
                });
    
                // Validate file attachments
                expenseCards.forEach(card => {
                    // Check if this is a route expense type (which doesn't require attachments)
                    const isRouteExpense = card.querySelector('.expense-type-route') !== null;
                    
                    // Skip attachment validation for route expenses
                    if (isRouteExpense) {
                        // If there's a dropzone that's marked as invalid, fix it
                        const dropZone = card.querySelector('.file-drop-zone');
                        if (dropZone && dropZone.classList.contains('invalid-drop-zone')) {
                            dropZone.classList.remove('invalid-drop-zone');
                            ValidationManager.clearValidationError(dropZone);
                        }
                        return; // Continue to next card
                    }
                    
                    const filePreview = card.querySelector('.file-preview');
                    const dropZone = card.querySelector('.file-drop-zone');
                    
                    if (!filePreview || filePreview.children.length === 0) {
                        if (dropZone) {
                            dropZone.classList.add('invalid-drop-zone');
                            isValid = ValidationManager.handleValidationError(dropZone, 'יש לצרף קבלה או אסמכתא');
                        }
                    } else {
                        if (dropZone) {
                            dropZone.classList.remove('invalid-drop-zone');
                            ValidationManager.clearValidationError(dropZone);
                        }
                    }
                });
    
                // Validate signatures based on mode
                if (isReviewMode) {
                    // Manager signature validation in review mode
                    if (SignatureManager.signaturePads.managerSignature && 
                        SignatureManager.signaturePads.managerSignature.isEmpty()) {
                        const canvas = SignatureManager.signaturePads.managerSignature.canvas;
                        canvas.classList.add('invalid-signature');
                        isValid = ValidationManager.handleValidationError(canvas, 'נדרשת חתימת מנהל');
                    }
                } else {
                    // Employee signature validation in new submission mode
                    if (SignatureManager.signaturePads.employeeSignature && 
                        SignatureManager.signaturePads.employeeSignature.isEmpty()) {
                        const canvas = SignatureManager.signaturePads.employeeSignature.canvas;
                        canvas.classList.add('invalid-signature');
                        isValid = ValidationManager.handleValidationError(canvas, 'נדרשת חתימת עובד');
                    }
                }
    
                // Add input listener to clear validation on change
                ValidationManager.setupValidationClearingListeners();
    
                return isValid;
            },
            
            // Show reject dialog for reports
            async showRejectDialog() {
                return new Promise((resolve) => {
                    Swal.fire({
                        title: 'סיבת דחייה',
                        input: 'textarea',
                        inputPlaceholder: 'אנא ציין את סיבת הדחייה',
                        showCancelButton: true,
                        confirmButtonText: 'שלח',
                        cancelButtonText: 'ביטול',
                        reverseButtons: true,
                        inputValidator: (value) => {
                            if (!value.trim()) {
                                return 'אנא ציין את סיבת הדחייה';
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            resolve(result.value);
                        } else {
                            resolve(null);
                        }
                    });
                });
            },
            
            // Handle report rejection
            async handleRejectReport() {
                try {
                    // Get the reason for rejection
                    const reason = await this.showRejectDialog();
                    if (!reason) return; // User cancelled
    
                    const overlay = UIManager.showLoadingOverlay('שולח דחייה...');
    
                    const response = await ApiService.rejectExpenseReport(ExpenseApp.state.id, reason);
    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
    
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('הדוח נדחה בהצלחה', 'success');
    
                    // Redirect after short delay
                    setTimeout(() => {
                        window.location.href = '/expenses/dashboard';
                    }, 2000);
    
                } catch (error) {
                    console.error('Error rejecting report:', error);
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('שגיאה בדחיית הדוח: ' + error.message, 'error');
                }
            },
            
            // Handle manager approval
            async handleManagerApprove(e) {
                e.preventDefault();
                
                if (SignatureManager.signaturePads.managerSignature.isEmpty()) {
                    UIManager.showNotification('נדרשת חתימת מנהל', 'warning');
                    return;
                }
    
                const overlay = UIManager.showLoadingOverlay('שולח אישור...');
    
                try {
                    const response = await ApiService.approveExpenseReport(
                        ExpenseApp.state.id, 
                        SignatureManager.getSignatureData(SignatureManager.signaturePads.managerSignature)
                    );
    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
    
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('הדוח אושר בהצלחה!', 'success');
    
                    // Redirect after successful approval
                    setTimeout(() => {
                        window.location.href = '/expenses/dashboard';
                    }, 2000);
    
                } catch (error) {
                    console.error('Error approving report:', error);
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('שגיאה באישור הדוח: ' + error.message, 'error');
                }
            },
            
            // Handle new submission
            async handleNewSubmission(e) {
                if (!this.validateForm()) {
                    return;
                }
    
                const overlay = UIManager.showLoadingOverlay('שולח נתונים...');
    
                try {
                    const formData = new FormData(e.target);
                    const expenses = await DataManager.collectExpenseData();
    
                    const data = {
                        employeeInfo: {
                            month: formData.get('month'),
                            email: formData.get('employeeEmail'),
                            managerEmail: formData.get('managerEmail')
                        },
                        expenses: expenses,
                        signatures: {
                            employee: SignatureManager.getSignatureData(SignatureManager.signaturePads.employeeSignature)
                        },
                        totalAmount: parseFloat(document.getElementById('totalAmount').textContent),
                        submittedAt: new Date().toISOString()
                    };
    
                    const response = await ApiService.submitExpenseReport(data);
    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
    
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('הדוח נשלח בהצלחה!', 'success');
    
                    await this.showFormClearConfirmation(e.target);
    
                } catch (error) {
                    console.error('Error:', error);
                    UIManager.hideLoadingOverlay();
                    UIManager.showNotification('אירעה שגיאה בשליחת הדוח: ' + error.message, 'error');
                }
            },
            
            // Show confirmation for clearing form after successful submission
            async showFormClearConfirmation(form) {
                const result = await Swal.fire({
                    title: 'ניקוי טופס',
                    text: 'האם ברצונך לנקות את הטופס?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'כן, נקה',
                    cancelButtonText: 'ביטול',
                    reverseButtons: true
                });
                
                if (result.isConfirmed) {
                    form.reset();
                    Object.values(SignatureManager.signaturePads).forEach(pad => pad.clear());
                    document.getElementById('expensesContainer').innerHTML = '';
                    ExpenseApp.resetCategoryTotals();
                    ExpenseCalculator.updateLiveTotal();
                    ExpenseApp.initializeNewSubmissionMode();
                }
            }
        };
    
        // ============= SIGNATURE MANAGER MODULE =============
        const SignatureManager = {
            signaturePads: {},
            
            init() {
                // Initialize all signature pads
                this.signaturePads = {
                    employeeSignature: this.initSignaturePad('employeeSignature'),
                    managerSignature: this.initSignaturePad('managerSignature')
                };
            },
            
            // Initialize a signature pad
            initSignaturePad(elementId) {
                const canvas = document.getElementById(elementId);
                if (!canvas) return null;
                
                // Function to properly resize canvas with DPR handling
                const resizeCanvas = () => {
                    const rect = canvas.getBoundingClientRect();
                    const dpr = window.devicePixelRatio || 1;
                    
                    // Set canvas size accounting for DPR
                    canvas.width = rect.width * dpr;
                    canvas.height = rect.height * dpr;
                    
                    // Scale context to match DPR
                    const ctx = canvas.getContext('2d');
                    ctx.scale(dpr, dpr);
                };
                
                // Force an initial reflow to ensure correct dimensions
                canvas.style.display = 'none';
                canvas.offsetHeight; // Trigger reflow
                canvas.style.display = 'block';
                
                // Initial resize with a small delay to ensure layout is complete
                setTimeout(resizeCanvas, 0);
                
                // Configure pad with coordinate transformation
                const pad = new SignaturePad(canvas, {
                    penColor: this.getSignatureColor(),
                    backgroundColor: 'transparent',
                    velocityFilterWeight: 0.5,
                    minWidth: 0.5,
                    maxWidth: 2.5,
                    throttle: 16,
                    minDistance: 0.5,
                    dotSize: 1.5
                });
    
                // Handle window resize with debounce
                let resizeTimeout;
                const handleResize = () => {
                    const data = pad.toData();
                    resizeCanvas();
                    if (canvas.dataset.originalSignature) {
                        this.drawSignatureToCanvas(canvas, canvas.dataset.originalSignature, pad);
                    } else if (data && data.length) {
                        pad.fromData(data);
                    }
                };
    
                // Ensure canvas is properly sized when tab becomes visible
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        handleResize();
                    }
                });
    
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(handleResize, 100);
                });
    
                // Add touch event listeners for mobile
                this.addTouchEventListeners(pad);
    
                // Force a resize after a short delay to ensure everything is properly initialized
                setTimeout(handleResize, 100);
    
                return pad;
            },
            
            // Add touch event listeners for better mobile support
            addTouchEventListeners(pad) {
                const canvas = pad.canvas;
                
                // Prevent scrolling while signing
                canvas.addEventListener('touchstart', function(e) {
                    if (e.cancelable) e.preventDefault();
                }, { passive: false });
                
                canvas.addEventListener('touchmove', function(e) {
                    if (e.cancelable) e.preventDefault();
                }, { passive: false });
                
                canvas.addEventListener('touchend', function(e) {
                    if (e.cancelable) e.preventDefault();
                }, { passive: false });
            },
            
            // Get signature color based on theme
            getSignatureColor() {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                return isDarkMode ? '#ffffff' : '#121f3f'; // White for dark mode, Abra navy for light mode
            },
            
            // Update signature colors when theme changes
            updateSignatureColors() {
                const newColor = this.getSignatureColor();
                
                Object.values(this.signaturePads).forEach(pad => {
                    if (pad) {
                        // If pad is not empty, save data, update color, and redraw
                        if (!pad.isEmpty()) {
                            const data = pad.toData();
                            pad.penColor = newColor;
                            pad.clear();
                            pad.fromData(data);
                        } else {
                            pad.penColor = newColor;
                        }
                    }
                });
            },
            
            // Clear a signature pad
            clearSignature(id) {
                if (this.signaturePads[id]) {
                    const canvas = document.getElementById(id);
                    const ctx = canvas.getContext('2d');
    
                    // Clear canvas and data
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    delete canvas.dataset.originalSignature;
                    delete canvas.dataset.signatureId;
    
                    this.signaturePads[id].clear();
                    this.signaturePads[id].penColor = this.getSignatureColor();
                    
                    // Remove validation styling if present
                    canvas.classList.remove('invalid-signature');
                    const errorDiv = canvas.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) errorDiv.remove();
                    
                    // Trigger progress update
                    FormHandler.updateProgress();
                }
            },
            
            // Draw signature to canvas from base64 data
            drawSignatureToCanvas(canvas, base64Data, padInstance) {
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Clear any existing content
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Get the device pixel ratio and canvas display size
                    const dpr = window.devicePixelRatio || 1;
                    const displayWidth = canvas.width / dpr;
                    const displayHeight = canvas.height / dpr;
                    
                    // Calculate scale to fit signature within 80% of the canvas
                    const scaleWidth = (displayWidth * 0.99) / img.width;
                    const scaleHeight = (displayHeight * 0.99) / img.height;
                    const scale = Math.min(scaleWidth, scaleHeight);
                    
                    // Calculate dimensions that maintain aspect ratio
                    const finalWidth = img.width * scale;
                    const finalHeight = img.height * scale;
                    
                    // Center the signature
                    const x = (displayWidth - finalWidth) / 2;
                    const y = (displayHeight - finalHeight) / 2;
                    
                    // Draw the image with proper DPR scaling
                    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                    ctx.drawImage(img, x, y, finalWidth, finalHeight);
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                    
                    // Mark the signature pad as having content
                    if (padInstance) {
                        padInstance._isEmpty = false;
                    }
                };
                
                img.src = 'data:image/png;base64,' + base64Data;
            },
            
            // Adjust canvas dimensions for proper display
            adjustCanvasDimensions(canvasId) {
                const canvas = document.getElementById(canvasId);
                if (!canvas) return;
                
                const containerWidth = canvas.parentElement.offsetWidth;
                const canvasHeight = containerWidth / 2.34; // Apply 2.34:1 ratio
                canvas.style.height = `${canvasHeight}px`;
                
                // Force canvas resize after setting new dimensions
                if (this.signaturePads[canvasId]) {
                    const rect = canvas.getBoundingClientRect();
                    canvas.width = rect.width * window.devicePixelRatio;
                    canvas.height = rect.height * window.devicePixelRatio;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
                    this.signaturePads[canvasId].clear(); // Clear and reinitialize
                }
            },
            
            // Configure signatures for review mode
            configureSignaturesForReviewMode(isFinalized) {
                Object.keys(this.signaturePads).forEach(key => {
                    if (this.signaturePads[key]) {
                        // If status is Approved or Rejected, make all signatures readonly
                        if (isFinalized) {
                            this.signaturePads[key].off();
                            const canvas = this.signaturePads[key].canvas;
                            if (canvas) {
                                canvas.style.cursor = 'not-allowed';
                                canvas.style.opacity = '0.7';
                            }
                            // Hide all clear buttons when finalized
                            const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                            if (clearButton) {
                                clearButton.style.display = 'none';
                            }
                        } else {
                            // Normal behavior - only manager signature is editable
                            if (key !== 'managerSignature') {
                                this.signaturePads[key].off();
                                const canvas = this.signaturePads[key].canvas;
                                if (canvas) {
                                    canvas.style.cursor = 'not-allowed';
                                    canvas.style.opacity = '0.7';
                                }
                                // Hide clear button for non-manager signatures
                                const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                                if (clearButton) {
                                    clearButton.style.display = 'none';
                                }
                            } else {
                                this.signaturePads[key].on();
                                const canvas = this.signaturePads[key].canvas;
                                if (canvas) {
                                    canvas.style.opacity = '1';
                                }
                                // Show clear button for manager signature
                                const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                                if (clearButton) {
                                    clearButton.style.display = 'block';
                                }
                            }
                        }
                    }
                });
            },
            
            // Get signature data as base64 string
            getSignatureData(signaturePad) {
                if (!signaturePad || signaturePad.isEmpty()) return null;
                
                // Get as PNG with transparent background
                const dataUrl = signaturePad.toDataURL('image/png');
                
                // Remove the data URL prefix
                return dataUrl.split(',')[1];
            }
        };
    
        // ============= FILE HANDLER MODULE =============
        const FileHandler = {
            init() {
                // Set up global drag and drop listeners
                this.setupGlobalDragAndDrop();
            },
            
            // Setup global drag and drop listeners
            setupGlobalDragAndDrop() {
                // Prevent default drag behaviors
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    document.addEventListener(eventName, (e) => {
                        // Only prevent default if it's a file being dragged
                        if (e.dataTransfer && e.dataTransfer.types.includes('Files')) {
                            e.preventDefault();
                            e.stopPropagation();
                        }
                    }, false);
                });
            },
            
            // Handle drag over event
            handleDragOver(event) {
                event.preventDefault();
                event.currentTarget.classList.add('drag-over');
            },
    
            // Handle drag leave event
            handleDragLeave(event) {
                event.preventDefault();
                event.currentTarget.classList.remove('drag-over');
            },
    
            // Handle file drop event
            handleFileDrop(event, dropZone) {
                event.preventDefault();
                dropZone.classList.remove('drag-over');
    
                const files = event.dataTransfer.files;
                this.handleFiles(files, dropZone);
            },
    
            // Handle file select from input
            handleFileSelect(event, dropZone) {
                const files = event.target.files;
                this.handleFiles(files, dropZone);
            },
            
            // Process dropped or selected files
            async handleFiles(files, dropZone) {
                // Get necessary elements
                const expenseCard = dropZone.closest('.expense-card');
                const previewContainer = dropZone.nextElementSibling;
                
                if (!expenseCard || !previewContainer) return;
                
                // Check current file count
                const currentFileCount = previewContainer.querySelectorAll('.file-preview-item').length;
                
                // Filter valid files (images and PDFs)
                const validFiles = Array.from(files).filter(file => {
                    const type = file.type.toLowerCase();
                    return type.startsWith('image/') || type === 'application/pdf';
                });
    
                // Validate file types
                if (validFiles.length !== files.length) {
                    UIManager.showNotification('רק קבצי תמונה ו-PDF מותרים להעלאה', 'warning');
                    return;
                }
    
                // Check if adding new files would exceed the limit
                if (currentFileCount + validFiles.length > 2) {
                    UIManager.showNotification('ניתן לצרף עד 2 קבצים להוצאה', 'warning');
                    return;
                }
    
                // Check for file size (limit to 5MB per file)
                const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes
                const oversizedFiles = validFiles.filter(file => file.size > MAX_FILE_SIZE);
                if (oversizedFiles.length > 0) {
                    UIManager.showNotification('גודל הקובץ חייב להיות קטן מ-5MB', 'warning');
                    return;
                }
    
                // Check if important fields already have data
                const amountInput = expenseCard.querySelector('.expense-amount');
                const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
                const hasExistingData = (amountInput?.value || invoiceInput?.value);
    
                for (const file of validFiles) {
                    try {
                        if (file.type.startsWith('image/')) {
                            await this.processImageFile(file, previewContainer, expenseCard, hasExistingData);
                        } else if (file.type === 'application/pdf') {
                            this.processPdfFile(file, previewContainer);
                        }
                    } catch (error) {
                        console.error('Error handling file:', error);
                        UIManager.showNotification('שגיאה בטעינת הקובץ: ' + error.message, 'error');
                    }
                }
    
                // After all files are processed, check total count and update drop zone
                const totalFileCount = previewContainer.querySelectorAll('.file-preview-item').length;
                this.updateDropZoneAfterUpload(dropZone, totalFileCount);
    
                // Update validation status
                const fileDropValidation = dropZone.classList.contains('invalid-drop-zone');
                if (fileDropValidation && totalFileCount > 0) {
                    dropZone.classList.remove('invalid-drop-zone');
                    const errorDiv = dropZone.parentNode.querySelector('.invalid-feedback');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                }
    
                // Update progress bar
                FormHandler.updateProgress();
            },
            
            // Process image file
            async processImageFile(file, previewContainer, expenseCard, hasExistingData) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = async function(e) {
                        try {
                            // Create and add preview
                            const preview = document.createElement('div');
                            preview.className = 'file-preview-item';
                            preview.innerHTML = 
                              `<img src="${e.target.result}" alt="Preview">
                              <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)">
                                <i class="fas fa-times"></i>
                              </button>`;
                            
                            preview.addEventListener('click', () => {
                                UIManager.openPreview(preview.querySelector('img'));
                            });
                            
                            previewContainer.appendChild(preview);
    
                            // Only process receipt if no existing data
                            if (!hasExistingData) {
                                // Add loading overlay
                                const loadingOverlay = document.createElement('div');
                                loadingOverlay.className = 'processing-overlay';
                                loadingOverlay.innerHTML = 
                                    `<div class="processing-spinner"></div>
                                    <div>מעבד את הקבלה...</div>`;
                                expenseCard.style.position = 'relative';
                                expenseCard.appendChild(loadingOverlay);
    
                                try {
                                    loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'מזהה פרטי קבלה...';
                                    const base64Image = e.target.result.split(',')[1];
                                    const receiptData = await ApiService.processReceiptImage(base64Image);
                                    
                                    loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'ממלא נתונים...';
                                    await ExpenseBuilder.populateExpenseFields(expenseCard, receiptData);
                                    
                                    loadingOverlay.remove();
                                    UIManager.showNotification('נתוני הקבלה זוהו והוזנו בהצלחה', 'success');
                                } catch (error) {
                                    console.error('Error processing receipt:', error);
                                    loadingOverlay.remove();
                                    UIManager.showNotification('לא ניתן היה לזהות את נתוני הקבלה באופן אוטומטי', 'warning');
                                }
                            }
                            
                            resolve();
                        } catch (error) {
                            reject(error);
                        }
                    };
    
                    reader.onerror = () => {
                        reject(new Error('שגיאה בקריאת הקובץ'));
                    };
    
                    reader.readAsDataURL(file);
                });
            },
            
            // Process PDF file
            processPdfFile(file, previewContainer) {
                const pdfUrl = URL.createObjectURL(file);
                const pdfPreview = document.createElement('div');
                pdfPreview.className = 'file-preview-item pdf-preview';
                pdfPreview.dataset.pdfUrl = pdfUrl;
                pdfPreview.innerHTML = 
                    `<i class="fas fa-file-pdf"></i>
                    <span>${file.name}</span>
                    <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>`;
                
                pdfPreview.addEventListener('click', () => {
                    UIManager.openPreview(pdfPreview);
                });
    
                // Store the object URL for cleanup
                pdfPreview.dataset.objectUrl = pdfUrl;
                previewContainer.appendChild(pdfPreview);
            },
            
            // Update drop zone after file upload
            updateDropZoneAfterUpload(dropZone, totalFileCount) {
                // Hide drop zone if 2 files are uploaded
                if (totalFileCount >= 2) {
                    dropZone.style.display = 'none';
                } else {
                    // Update drop zone text
                    const remainingFiles = 2 - totalFileCount;
                    const textDiv = dropZone.querySelector('div:not(.text-muted)');
                    if (textDiv) {
                        if (remainingFiles === 1) {
                            textDiv.textContent = 'ניתן להוסיף עוד קובץ אחד';
                        } else {
                            textDiv.textContent = 'ניתן להוסיף עוד ' + remainingFiles + ' קבצים';
                        }
                    }
                }
            },
            
            // Remove file from preview
            removeFile(button) {
                const previewItem = button.closest('.file-preview-item, .pdf-preview');
                if (!previewItem) return;
                
                const previewContainer = previewItem.parentElement;
                const expenseCard = previewContainer?.closest('.expense-card');
                if (!expenseCard) return;
                
                const dropZone = expenseCard.querySelector('.file-drop-zone');
                
                // Cleanup object URL if it exists
                if (previewItem.dataset.objectUrl) {
                    URL.revokeObjectURL(previewItem.dataset.objectUrl);
                }
                
                // Remove the file preview
                previewItem.remove();
    
                // Count remaining files
                const remainingFiles = previewContainer.querySelectorAll('.file-preview-item').length;
    
                // Show drop zone and update text if we have less than 2 files
                if (dropZone && remainingFiles < 2) {
                    dropZone.style.display = 'block';
                    
                    // Update the drop zone text
                    const textDiv = dropZone.querySelector('div:not(.text-muted)');
                    if (textDiv) {
                        if (remainingFiles === 0) {
                            textDiv.textContent = 'גרור קבצים לכאן או לחץ להעלאה';
                        } else {
                            textDiv.textContent = 'ניתן להוסיף עוד קובץ אחד';
                        }
                    }
                }
                
                // Update progress
                FormHandler.updateProgress();
            },
            
            // Add file preview from retrieved data
            addFilePreview(previewContainer, fileData) {
                const previewItem = document.createElement('div');
                const isPdf = fileData.name.toLowerCase().endsWith('.pdf');
                previewItem.className = isPdf ? 'file-preview-item pdf-preview' : 'file-preview-item';
                previewItem.dataset.originalFile = fileData.file;
    
                if (isPdf) {
                    previewItem.innerHTML = `
                        <i class="fas fa-file-pdf"></i>
                        <span>${fileData.name}</span>
                        <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    const mimeType = fileData.name.split('.').pop().toLowerCase() === 'png' ? 'image/png' : 'image/jpeg';
                    const dataUrl = `data:${mimeType};base64,${fileData.file}`;
                    previewItem.innerHTML = `
                        <img src="${dataUrl}" alt="${fileData.name}">
                        <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }
    
                previewItem.addEventListener('click', () => {
                    UIManager.openPreview(previewItem.querySelector('img') || previewItem);
                });
    
                previewContainer.appendChild(previewItem);
    
                // Hide drop zone
                const dropZone = previewContainer.closest('.expense-card').querySelector('.file-drop-zone');
                if (dropZone) dropZone.style.display = 'none';
            },
            
            // Get file data for submission
            async getFileData(element) {
                let fileType, fileData, fileName;
                
                if (element.classList.contains('pdf-preview')) {
                    // Handle PDF files
                    fileType = 'application/pdf';
                    fileName = element.querySelector('span')?.textContent || `document_${Date.now()}.pdf`;
                    
                    // Handle different PDF data sources
                    if (element.dataset.originalFile) {
                        // Review mode - already in base64
                        fileData = element.dataset.originalFile;
                    } else if (element.dataset.pdfUrl && element.dataset.pdfUrl.startsWith('blob:')) {
                         // Upload mode - need to convert blob URL to base64
                         fileData = await this.blobToBase64(element.dataset.pdfUrl);
                    }
                } else {
                    // Handle image files
                    const img = element.querySelector('img');
                    if (!img) return null;
                    
                    fileType = img.src.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
                    fileName = `receipt_${Date.now()}.${fileType.split('/')[1]}`;
                    
                    if (img.src.startsWith('data:')) {
                        // Image is already in base64
                        fileData = img.src.split(',')[1];
                    } else if (img.src.startsWith('blob:')) {
                        // Convert blob URL to base64
                        fileData = await this.blobToBase64(img.src);
                    }
                }
    
                // Only return data if we successfully got all parts
                if (fileData && fileType && fileName) {
                    return {
                        type: fileType,
                        name: fileName,
                        body: fileData
                    };
                }
                
                return null;
            },
            
            // Convert blob URL to base64
            async blobToBase64(blobUrl) {
                const response = await fetch(blobUrl);
                const blob = await response.blob();
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        // Remove the data URL prefix
                        const base64Data = reader.result.split(',')[1];
                        resolve(base64Data);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
        };
    
        // ============= EXPENSE BUILDER MODULE =============
        const ExpenseBuilder = {
            // Quick add expense card based on type
            quickAdd(type) {
                const container = document.getElementById('expensesContainer');
                if (!container) return;
                
                const today = new Date().toISOString().split('T')[0];
    
                const card = document.createElement('div');
                card.className = 'expense-card animate__animated animate__fadeIn';
                card.dataset.expenseType = type; // Store expense type for category tracking
    
                let typeLabel, typeIcon, typeClass;
                switch (type) {
                    case 'fuel':
                        typeLabel = 'רכב';
                        typeIcon = 'gas-pump';
                        typeClass = 'fuel';
                        break;
                    case 'parking':
                        typeLabel = 'חניה';
                        typeIcon = 'parking';
                        typeClass = 'parking';
                        break;
                    case 'route': 
                        typeLabel = 'נסיעה';
                        typeIcon = 'route';
                        typeClass = 'route';
                        break;
                    case 'other':
                        typeLabel = 'הוצאה אחרת';
                        typeIcon = 'receipt';
                        typeClass = 'other';
                        break;
                }
    
                card.innerHTML = `
                    <div class="expense-type-indicator expense-type-${typeClass}">
                        <i class="fas fa-${typeIcon}"></i>
                        ${typeLabel}
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">תאריך</label>
                            <input type="date" class="form-control" value="${today}" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">מספר חשבונית</label>
                            <input type="text" class="form-control" placeholder="הזן מספר חשבונית" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">סכום</label>
                            <div class="input-group">
                                <input type="number" step="0.01" class="form-control expense-amount" required>
                                <span class="input-group-text">₪</span>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-danger w-100" onclick="ExpenseBuilder.removeExpenseRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label">הערות נוספות</label>
                            <textarea class="form-control" id="note" rows="2" placeholder="הוסף הערות או פרטים נוספים לגבי ההוצאה (לא חובה)"></textarea>
                        </div>
                        <div class="col-12">
                            <div class="file-drop-zone" ondrop="FileHandler.handleFileDrop(event, this)" 
                                ondragover="FileHandler.handleDragOver(event)" 
                                ondragleave="FileHandler.handleDragLeave(event)">
                                <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 2rem;"></i>
                                <div>גרור קבצים לכאן או לחץ להעלאה</div>
                                <div class="text-muted">(תמונות או PDF בלבד)</div>
                                <input type="file" class="d-none" accept="image/*,.pdf" multiple 
                                        onchange="FileHandler.handleFileSelect(event, this.parentElement)">
                            </div>
                            <div class="file-preview"></div>
                        </div>
                    </div>
                `;
    
                container.insertBefore(card, container.firstChild);
                
                // Set up real-time expense amount tracking
                const amountInput = card.querySelector('.expense-amount');
                amountInput.addEventListener('input', function() {
                    ExpenseCalculator.updateExpenseAmount(this, type);
                });
                
                // Add click handler for file upload zone
                const dropZone = card.querySelector('.file-drop-zone');
                dropZone.addEventListener('click', () => {
                    dropZone.querySelector('input[type="file"]').click();
                });
                
                // Initialize tooltips
                UIManager.initTooltips();
                
                // Update progress steps to expenses step
                UIManager.updateProgressSteps(2);
                
                // Return the created card for chaining
                return card;
            },
            
            // Remove expense row
            removeExpenseRow(button) {
                const card = button.closest('.expense-card');
                if (!card) return;
                
                const expenseType = card.dataset.expenseType || 'other';
                const amountInput = card.querySelector('.expense-amount');
                const amount = parseFloat(amountInput?.value) || 0;
                
                // Subtract from category total
                ExpenseApp.state.categoryTotals[expenseType] -= amount;
                
                // Fade out and remove the card
                card.classList.remove('animate__fadeIn');
                card.classList.add('animate__fadeOut');
    
                card.addEventListener('animationend', () => {
                    card.remove();
                    ExpenseCalculator.updateLiveTotal();
                });
            },
            
            // Populate expense fields from receipt data
            async populateExpenseFields(expenseCard, receiptData) {
                try {
                    // Convert date from DD/MM/YY to YYYY-MM-DD for input field
                    const [day, month, year] = receiptData.date.split('/');
                    const fullYear = '20' + year; // Assuming all dates are from 2000s
                    const formattedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    
                    // Populate date field
                    const dateInput = expenseCard.querySelector('input[type="date"]');
                    if (dateInput) dateInput.value = formattedDate;
    
                    // Populate invoice number
                    const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
                    if (invoiceInput) invoiceInput.value = receiptData.reception_number;
    
                    // Populate amount (remove commas and convert to number)
                    const amountInput = expenseCard.querySelector('.expense-amount');
                    if (amountInput) {
                        const amount = receiptData.total_payment.replace(/,/g, '');
                        amountInput.value = parseFloat(amount);
                        
                        // Trigger the input event to update category totals
                        const expenseType = expenseCard.dataset.expenseType;
                        ExpenseCalculator.updateExpenseAmount(amountInput, expenseType);
                    }
    
                    console.log('Receipt data populated successfully:', receiptData);
                } catch (error) {
                    console.error('Error populating fields:', error);
                    throw new Error('שגיאה במילוי הנתונים מהקבלה');
                }
            }
        };
    
        // ============= EXPENSE CALCULATOR MODULE =============
        const ExpenseCalculator = {
            // Update expense amount in real-time
            updateExpenseAmount(input, type) {
                const card = input.closest('.expense-card');
                const oldValue = parseFloat(card.dataset.lastAmount || '0');
                const newValue = parseFloat(input.value) || 0;
                
                // Update the tracker
                ExpenseApp.state.categoryTotals[type] = ExpenseApp.state.categoryTotals[type] - oldValue + newValue;
                
                // Store the current value for next update
                card.dataset.lastAmount = newValue;
                
                // Update totals with animation
                this.updateLiveTotal();
            },
            
            // Update live total display with animation
            updateLiveTotal() {
                // Calculate grand total from category totals
                const totalAmount = Object.values(ExpenseApp.state.categoryTotals).reduce((sum, val) => sum + val, 0);
                
                // Update all total amount elements with animation
                document.querySelectorAll('[id="totalAmount"]').forEach(element => {
                    // Handle potential currency symbols in the text
                    const currentText = element.textContent.trim();
                    const currentValue = parseFloat(currentText.replace(/[^\d.-]/g, '')) || 0;
                    
                    this.animateNumber(
                        currentValue,
                        totalAmount,
                        {
                            duration: 500,
                            onUpdate: (value) => {
                                // Preserve any currency symbol that might be there
                                if (element.closest('.category-amount')) {
                                    element.textContent = value.toFixed(2) + ' ₪';
                                } else {
                                    element.textContent = value.toFixed(2);
                                }
                            }
                        }
                    );
                });
                
                // Update sidebar expense totals
                document.getElementById('sidebarTotalAmount').textContent = totalAmount.toFixed(2);
                document.getElementById('fuelAmount').textContent = ExpenseApp.state.categoryTotals.fuel.toFixed(2);
                document.getElementById('routeAmount').textContent = ExpenseApp.state.categoryTotals.route.toFixed(2);
                document.getElementById('parkingAmount').textContent = ExpenseApp.state.categoryTotals.parking.toFixed(2);
                
                // Update the floating total with detailed breakdown
                this.updateFloatingTotalWithCategories();
                
                // Update progress
                FormHandler.updateProgress();
            },
                
            // Animate number changes
            animateNumber(start, end, options) {
                if (Math.abs(end - start) < 0.01) {
                    options.onUpdate(end);
                    return;
                }
                
                const startTime = performance.now();
                const duration = options.duration || 1000;
    
                const update = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
    
                    // Easing function for smooth animation
                    const easeOutQuad = (t) => t * (2 - t);
                    const easedProgress = easeOutQuad(progress);
    
                    const currentValue = start + (end - start) * easedProgress;
                    options.onUpdate(currentValue);
    
                    if (progress < 1) {
                        requestAnimationFrame(update);
                    }
                };
    
                requestAnimationFrame(update);
            },
            
            // Update floating total with category breakdown
            updateFloatingTotalWithCategories() {
                const floatingTotal = document.querySelector('.floating-total');
                if (!floatingTotal) return;
                
                // Calculate grand total
                const grandTotal = Object.values(ExpenseApp.state.categoryTotals).reduce((sum, val) => sum + val, 0);
                
                // Check if we need to update the floating total structure based on state
                const isReviewMode = ExpenseApp.state.mode === 'review';
                const reviewModeApproved = document.body.classList.contains('status-approved') || 
                                           document.body.classList.contains('status-rejected');
                
                // Generate HTML for both states with current values
                const collapsedHTML = `
                    <div class="d-flex align-items-center justify-content-between w-100">
                        <div class="d-flex align-items-center">
                            <div>
                                סה"כ: <span id="totalAmount">${grandTotal.toFixed(2)}</span> ₪
                            </div>
                            <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                        </div>
                        ${isReviewMode && !reviewModeApproved ? `
                            <div class="d-flex gap-3">
                                <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                                    <i class="fas fa-times"></i> דחה דוח
                                </button>
                                <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                                    <i class="fas fa-check"></i> אשר דוח
                                </button>
                            </div>
                        ` : isReviewMode ? `` : `
                            <button type="submit" form="expenseForm" class="submit-button">
                                <i class="fas fa-paper-plane"></i>
                                שלח דוח
                            </button>
                        `}
                    </div>
                `;
                
                // Create expanded state HTML (detailed view) with current values
                const expandedHTML = `
                    <div class="expanded-total-content w-100">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div>פירוט הוצאות</div>
                                <button type="button" class="btn-collapse-total ms-2" aria-label="הסתר פירוט">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                            ${isReviewMode && !reviewModeApproved ? `
                                <div class="d-flex gap-3">
                                    <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                                        <i class="fas fa-times"></i> דחה דוח
                                    </button>
                                    <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                                        <i class="fas fa-check"></i> אשר דוח
                                    </button>
                                </div>
                            ` : isReviewMode ? `` : `
                                <button type="submit" form="expenseForm" class="submit-button">
                                    <i class="fas fa-paper-plane"></i>
                                    שלח דוח
                                </button>
                            `}
                        </div>
                        <div class="category-totals mt-2">
                            ${ExpenseApp.state.categoryTotals.fuel > 0 ? `
                                <div class="category-total-item">
                                    <i class="fas fa-gas-pump"></i>
                                    <span>רכב:</span>
                                    <span class="category-amount">${ExpenseApp.state.categoryTotals.fuel.toFixed(2)} ₪</span>
                                </div>
                            ` : ''}
                            ${ExpenseApp.state.categoryTotals.route > 0 ? `
                                <div class="category-total-item">
                                    <i class="fas fa-route"></i>
                                    <span>נסיעה:</span>
                                    <span class="category-amount">${ExpenseApp.state.categoryTotals.route.toFixed(2)} ₪</span>
                                </div>
                            ` : ''}
                            ${ExpenseApp.state.categoryTotals.parking > 0 ? `
                                <div class="category-total-item">
                                    <i class="fas fa-parking"></i>
                                    <span>חניה:</span>
                                    <span class="category-amount">${ExpenseApp.state.categoryTotals.parking.toFixed(2)} ₪</span>
                                </div>
                            ` : ''}
                            ${ExpenseApp.state.categoryTotals.other > 0 ? `
                                <div class="category-total-item">
                                    <i class="fas fa-receipt"></i>
                                    <span>הוצאות אחרות:</span>
                                    <span class="category-amount">${ExpenseApp.state.categoryTotals.other.toFixed(2)} ₪</span>
                                </div>
                            ` : ''}
                            <div class="category-total-item grand-total">
                                <span>סה"כ:</span>
                                <span class="category-amount" id="totalAmount">${grandTotal.toFixed(2)} ₪</span>
                            </div>
                        </div>
                    </div>
                `;
                
                // Safely update DOM without breaking event handlers
                if (!floatingTotal.dataset.state) {
                    // Initial setup
                    floatingTotal.dataset.state = 'collapsed';
                    floatingTotal.innerHTML = collapsedHTML;
                    this.setupTotalClickHandlers(floatingTotal);
                } else {
                    // Update specific elements instead of replacing everything
                    const totalAmountElement = floatingTotal.querySelector('#totalAmount');
                    if (totalAmountElement) {
                        this.animateNumber(
                            parseFloat(totalAmountElement.textContent || '0'),
                            grandTotal,
                            {
                                duration: 500,
                                onUpdate: (value) => {
                                    totalAmountElement.textContent = value.toFixed(2);
                                }
                            }
                        );
                    }
                    
                    // If expanded, also update category amounts
                    if (floatingTotal.dataset.state === 'expanded') {
                        Object.keys(ExpenseApp.state.categoryTotals).forEach(category => {
                            const amount = ExpenseApp.state.categoryTotals[category];
                            if (amount > 0) {
                                let selector;
                                switch(category) {
                                    case 'fuel': selector = '.fa-gas-pump'; break;
                                    case 'route': selector = '.fa-route'; break;
                                    case 'parking': selector = '.fa-parking'; break;
                                    case 'other': selector = '.fa-receipt'; break;
                                }
                                
                                const categoryItem = floatingTotal.querySelector(selector)?.closest('.category-total-item');
                                if (categoryItem) {
                                    const amountElement = categoryItem.querySelector('.category-amount');
                                    if (amountElement) {
                                        const currentValue = parseFloat(amountElement.textContent);
                                        this.animateNumber(currentValue, amount, {
                                            duration: 500,
                                            onUpdate: (value) => {
                                                amountElement.textContent = value.toFixed(2) + ' ₪';
                                            }
                                        });
                                    }
                                }
                            }
                        });
                        
                        // Also update grand total in expanded view
                        const grandTotalElement = floatingTotal.querySelector('.grand-total .category-amount');
                        if (grandTotalElement) {
                            this.animateNumber(
                                parseFloat(grandTotalElement.textContent),
                                grandTotal,
                                {
                                    duration: 500,
                                    onUpdate: (value) => {
                                        grandTotalElement.textContent = value.toFixed(2) + ' ₪';
                                    }
                                }
                            );
                        }
                    }
                }
            },
            
            // Setup click handlers for expand/collapse
            setupTotalClickHandlers(floatingTotal) {
                floatingTotal.addEventListener('click', (e) => {
                    const grandTotal = Object.values(ExpenseApp.state.categoryTotals).reduce((sum, val) => sum + val, 0);
                    
                    if (e.target.closest('.btn-expand-total')) {
                        floatingTotal.dataset.state = 'expanded';
                        
                        // Generate the expanded HTML content
                        const isReviewMode = ExpenseApp.state.mode === 'review';
                        const reviewModeApproved = document.body.classList.contains('status-approved') || 
                                                document.body.classList.contains('status-rejected');
                        
                        const expandedHTML = `
                            <div class="expanded-total-content w-100">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div>פירוט הוצאות</div>
                                        <button type="button" class="btn-collapse-total ms-2" aria-label="הסתר פירוט">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    ${isReviewMode && !reviewModeApproved ? `
                                        <div class="d-flex gap-3">
                                            <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                                                <i class="fas fa-times"></i> דחה דוח
                                            </button>
                                            <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                                                <i class="fas fa-check"></i> אשר דוח
                                            </button>
                                        </div>
                                    ` : isReviewMode ? `` : `
                                        <button type="submit" form="expenseForm" class="submit-button">
                                            <i class="fas fa-paper-plane"></i>
                                            שלח דוח
                                        </button>
                                    `}
                                </div>
                                <div class="category-totals mt-2">
                                    ${ExpenseApp.state.categoryTotals.fuel > 0 ? `
                                        <div class="category-total-item">
                                            <i class="fas fa-gas-pump"></i>
                                            <span>רכב:</span>
                                            <span class="category-amount">${ExpenseApp.state.categoryTotals.fuel.toFixed(2)} ₪</span>
                                        </div>
                                    ` : ''}
                                    ${ExpenseApp.state.categoryTotals.route > 0 ? `
                                        <div class="category-total-item">
                                            <i class="fas fa-route"></i>
                                            <span>נסיעה:</span>
                                            <span class="category-amount">${ExpenseApp.state.categoryTotals.route.toFixed(2)} ₪</span>
                                        </div>
                                    ` : ''}
                                    ${ExpenseApp.state.categoryTotals.parking > 0 ? `
                                        <div class="category-total-item">
                                            <i class="fas fa-parking"></i>
                                            <span>חניה:</span>
                                            <span class="category-amount">${ExpenseApp.state.categoryTotals.parking.toFixed(2)} ₪</span>
                                        </div>
                                    ` : ''}
                                    ${ExpenseApp.state.categoryTotals.other > 0 ? `
                                        <div class="category-total-item">
                                            <i class="fas fa-receipt"></i>
                                            <span>הוצאות אחרות:</span>
                                            <span class="category-amount">${ExpenseApp.state.categoryTotals.other.toFixed(2)} ₪</span>
                                        </div>
                                    ` : ''}
                                    <div class="category-total-item grand-total">
                                        <span>סה"כ:</span>
                                        <span class="category-amount" id="totalAmount">${grandTotal.toFixed(2)} ₪</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        floatingTotal.innerHTML = expandedHTML;
                        floatingTotal.classList.add('expanded');
                        this.setupTotalClickHandlers(floatingTotal);
                    } else if (e.target.closest('.btn-collapse-total')) {
                        floatingTotal.dataset.state = 'collapsed';
                        
                        // Generate the collapsed HTML content
                        const isReviewMode = ExpenseApp.state.mode === 'review';
                        const reviewModeApproved = document.body.classList.contains('status-approved') || 
                                                document.body.classList.contains('status-rejected');
                        
                        const collapsedHTML = `
                            <div class="d-flex align-items-center justify-content-between w-100">
                                <div class="d-flex align-items-center">
                                    <div>
                                        סה"כ: <span id="totalAmount">${grandTotal.toFixed(2)}</span> ₪
                                    </div>
                                    <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
                                        <i class="fas fa-chevron-up"></i>
                                    </button>
                                </div>
                                ${isReviewMode && !reviewModeApproved ? `
                                    <div class="d-flex gap-3">
                                        <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                                            <i class="fas fa-times"></i> דחה דוח
                                        </button>
                                        <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                                            <i class="fas fa-check"></i> אשר דוח
                                        </button>
                                    </div>
                                ` : isReviewMode ? `` : `
                                    <button type="submit" form="expenseForm" class="submit-button">
                                        <i class="fas fa-paper-plane"></i>
                                        שלח דוח
                                    </button>
                                `}
                            </div>
                        `;
                        
                        floatingTotal.innerHTML = collapsedHTML;
                        floatingTotal.classList.remove('expanded');
                        this.setupTotalClickHandlers(floatingTotal);
                    }
                });
            }
        };
    
        // ============= VALIDATION MANAGER MODULE =============
        const ValidationManager = {
            init() {
                // Nothing to initialize
            },
            
            // Handle validation error
            handleValidationError(element, errorMessage, errorClass = 'invalid-feedback') {
                element.classList.add('is-invalid');
                
                // Look for existing error div within the parent
                let errorDiv = element.parentNode.querySelector('.' + errorClass);
                
                // Create error div if it doesn't exist
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.className = errorClass;
                    // For drop zones and signatures, make sure error is visible
                    if (element.classList.contains('file-drop-zone') || 
                        element.classList.contains('signature-pad')) {
                        errorDiv.className += ' d-block';
                    }
                    element.parentNode.appendChild(errorDiv);
                }
                
                errorDiv.textContent = errorMessage;
                return false;
            },
    
            // Clear validation error
            clearValidationError(element) {
                element.classList.remove('is-invalid');
                const errorDiv = element.parentNode.querySelector('.invalid-feedback');
                if (errorDiv) {
                    errorDiv.remove();
                }
            },
            
            // Setup listeners to clear validation errors on input
            setupValidationClearingListeners() {
                // Clear validation styling on input
                const form = document.getElementById('expenseForm');
                if (!form) return;
                
                form.addEventListener('input', function(e) {
                    if (e.target.classList.contains('is-invalid')) {
                        ValidationManager.clearValidationError(e.target);
                    }
                });
    
                // Clear signature validation on signing
                Object.values(SignatureManager.signaturePads).forEach(pad => {
                    const canvas = pad.canvas;
                    if (!canvas._hasValidationListener) { // Check if listener already exists
                        canvas._hasValidationListener = true;
                        canvas.addEventListener('mousedown', function() {
                            this.classList.remove('invalid-signature');
                            ValidationManager.clearValidationError(this);
                        });
                    }
                });
            }
        };
        
        // ============= PDF RENDERER MODULE =============
        const PdfRenderer = {
            init() {
                // Nothing to initialize
            },
            
            // Render PDF to container
            renderPDF(pdfSource, container) {
                // Clear any existing content
                container.innerHTML = '';
    
                // Create loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'pdf-loading';
                loadingIndicator.innerHTML = `
                    <div class="spinner">
                        <i class="fas fa-file-pdf"></i>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">טוען PDF...</span>
                        </div>
                    </div>
                    <p>טוען מסמך PDF...</p>
                `;
                container.appendChild(loadingIndicator);
    
                // Determine the source type
                let pdfData;
                try {
                    // Check if it's a base64 string or blob/object URL
                    if (typeof pdfSource === 'string') {
                        if (pdfSource.startsWith('data:application/pdf;base64,')) {
                            // Full data URL
                            pdfData = pdfSource;
                        } else if (pdfSource.startsWith('blob:')) {
                            // Blob URL
                            return this.fetchBlobPDF(pdfSource, container);
                        } else {
                            // Assume base64 without prefix
                            pdfData = `data:application/pdf;base64,${pdfSource}`;
                        }
                    } else {
                        throw new Error('Invalid PDF source');
                    }
    
                    // Create PDF viewer
                    const pdfViewerContainer = document.createElement('div');
                    pdfViewerContainer.className = 'pdf-viewer';
                    
                    // Navigation controls
                    const controls = document.createElement('div');
                    controls.className = 'pdf-controls';
                    controls.innerHTML = `
                        <button class="btn btn-outline-secondary pdf-zoom-out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span class="pdf-page-info">עמוד <span class="current-page">1</span> מתוך <span class="total-pages">-</span></span>
                        <button class="btn btn-outline-secondary pdf-zoom-in">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    `;
    
                    // Canvas for PDF rendering
                    const canvas = document.createElement('canvas');
                    canvas.className = 'pdf-canvas';
    
                    // State variables for PDF
                    const pdfState = {
                        pdfDoc: null,
                        pageNum: 1,
                        pageRendering: false,
                        pageNumPending: null,
                        scale: 1.5
                    };
    
                    // Load PDF
                    pdfjsLib.getDocument(pdfData).promise
                        .then((pdf) => {
                            pdfState.pdfDoc = pdf;
                            loadingIndicator.remove();
                            
                            // Add controls and canvas
                            pdfViewerContainer.appendChild(controls);
                            pdfViewerContainer.appendChild(canvas);
                            container.appendChild(pdfViewerContainer);
    
                            // Render first page
                            this.renderPdfPage(canvas, pdfState, 1);
                            
                            // Set up zoom controls
                            this.setupPdfControls(controls, canvas, pdfState);
                        })
                        .catch((error) => {
                            console.error('PDF Load Error:', error);
                            loadingIndicator.innerHTML = `
                                <div class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    שגיאה בטעינת PDF
                                </div>
                            `;
                        });
    
                } catch (error) {
                    console.error('PDF Render Error:', error);
                    container.innerHTML = `
                        <div class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            שגיאה בהצגת PDF: ${error.message}
                        </div>
                    `;
                }
            },
            
            // Render a specific PDF page
            renderPdfPage(canvas, pdfState, num) {
                pdfState.pageRendering = true;
                
                pdfState.pdfDoc.getPage(num).then((page) => {
                    const viewport = page.getViewport({ scale: pdfState.scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
    
                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };
    
                    const renderTask = page.render(renderContext);
                    renderTask.promise.then(() => {
                        pdfState.pageRendering = false;
                        if (pdfState.pageNumPending !== null) {
                            this.renderPdfPage(canvas, pdfState, pdfState.pageNumPending);
                            pdfState.pageNumPending = null;
                        }
                        
                        // Update page info
                        const pdfViewer = canvas.closest('.pdf-viewer');
                        if (pdfViewer) {
                            const currentPage = pdfViewer.querySelector('.current-page');
                            const totalPages = pdfViewer.querySelector('.total-pages');
                            
                            if (currentPage) currentPage.textContent = num;
                            if (totalPages) totalPages.textContent = pdfState.pdfDoc.numPages;
                        }
                    });
                });
            },
            
            // Queue page rendering (if already rendering)
            queueRenderPage(canvas, pdfState, num) {
                if (pdfState.pageRendering) {
                    pdfState.pageNumPending = num;
                } else {
                    this.renderPdfPage(canvas, pdfState, num);
                }
            },
            
            // Set up PDF controls (zoom, navigation)
            setupPdfControls(controls, canvas, pdfState) {
                controls.querySelector('.pdf-zoom-in').addEventListener('click', () => {
                    pdfState.scale += 0.25;
                    this.queueRenderPage(canvas, pdfState, pdfState.pageNum);
                });
    
                controls.querySelector('.pdf-zoom-out').addEventListener('click', () => {
                    pdfState.scale = Math.max(0.5, pdfState.scale - 0.25);
                    this.queueRenderPage(canvas, pdfState, pdfState.pageNum);
                });
            },
            
            // Helper function to fetch blob PDFs
            fetchBlobPDF(blobUrl, container) {
                fetch(blobUrl)
                    .then(response => response.blob())
                    .then(blob => {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            this.renderPDF(reader.result, container);
                        };
                        reader.readAsDataURL(blob);
                    })
                    .catch(error => {
                        console.error('Blob PDF Fetch Error:', error);
                        container.innerHTML = `
                            <div class="text-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                                שגיאה בטעינת PDF: ${error.message}
                            </div>
                        `;
                    });
            }
        };
    
        // ============= API SERVICE MODULE =============
        const ApiService = {
            // API endpoints
            endpoints: {
                base: API_ENDPOINT,
                params: API_PARAMS
            },
            
            // Get expense report by ID
            getExpenseReport(id) {
                return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        id: id,
                        action: "get-report"  
                    })
                });
            },
            
            // Submit new expense report
            submitExpenseReport(data) {
                return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ...data,
                        action: "new-submit",
                        status: 'submitted'
                    })
                });
            },
            
            // Manager approve expense report
            approveExpenseReport(id, signature) {
                return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        action: "manager-approve",
                        status: 'manager_approved',
                        managerSignature: signature,
                        approvedAt: new Date().toISOString()
                    })
                });
            },
            
            // Manager reject expense report
            rejectExpenseReport(id, reason) {
                return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        id: id,
                        action: "manager-reject",
                        status: 'rejected',
                        rejectionReason: reason,
                        rejectedAt: new Date().toISOString()
                    })
                });
            },
            
            // Process receipt image with Gemini API
            async processReceiptImage(imageBase64) {
                const systemPrompt = `אתה מומחה בניתוח קבלות. אנא חלץ את המידע הבא מהקבלה ותחזיר אותו בפורמט JSON:
                    - תאריך (date)
                    - סכום לתשלום (total_payment)
                    - מספר קבלה/חשבונית (reception_number)
                    
                    החזר את התוצאה בפורמט הבא בדיוק:
                    { "date": "DD/MM/YY", "total_payment": "X,XXX.XX", "reception_number": "XXXXX" }`;
    
                // Array of model configurations to try in order
                const models = [
                    {
                        name: 'Gemini 1.5',
                        endpoint: 'gemini-1.5-flash',
                        handler: async () => {
                            const requestBody = {
                                contents: [{
                                    parts: [
                                        { text: systemPrompt },
                                        {
                                            inlineData: {
                                                mimeType: "image/jpeg",
                                                data: imageBase64
                                            }
                                        }
                                    ]
                                }],
                                generationConfig: {
                                    temperature: 0.1,
                                    topK: 1,
                                    topP: 0.1
                                }
                            };
    
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                }
                            );
    
                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    },
                    {
                        name: 'Gemini 1.5 Flash 8B',
                        endpoint: 'gemini-1.5-flash-8b',
                        handler: async () => {
                            const requestBody = {
                                contents: [{
                                    role: "user",
                                    parts: [
                                        {
                                            inlineData: {
                                                mimeType: "image/jpeg",
                                                data: imageBase64
                                            }
                                        },
                                        { text: systemPrompt }
                                    ]
                                }],
                                generationConfig: {
                                    temperature: 1,
                                    topK: 40,
                                    topP: 0.95,
                                    maxOutputTokens: 8192,
                                    responseMimeType: "text/plain"
                                }
                            };

                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-8b:generateContent?key=${GEMINI_API_KEY}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                }
                            );

                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    },
                    {
                        name: 'Gemini 2.0',
                        endpoint: 'gemini-2.0-flash',
                        handler: async () => {
                            const requestBody = {
                                contents: [{
                                    role: "user",
                                    parts: [
                                        {
                                            inlineData: {
                                                mimeType: "image/jpeg",
                                                data: imageBase64
                                            }
                                        },
                                        { text: systemPrompt }
                                    ]
                                }],
                                generationConfig: {
                                    temperature: 1,
                                    topK: 40,
                                    topP: 0.95,
                                    maxOutputTokens: 8192,
                                    responseMimeType: "text/plain"
                                }
                            };

                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                }
                            );

                            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                            return await response.json();
                        }
                    }
                ];

                // Try each model in sequence with better error handling
                let lastError = null;
                for (const model of models) {
                    try {
                        console.log(`Trying ${model.name}...`);
                        const data = await model.handler();

                        // Parse the response
                        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                            throw new Error('Invalid response format: missing text in response');
                        }
                        
                        const text = data.candidates[0].content.parts[0].text;
                        
                        // Try to extract JSON from the response using more flexible regex
                        const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) || 
                                        text.match(/```\n([\s\S]*?)\n```/) ||
                                        text.match(/{[\s\S]*}/);

                        if (!jsonMatch) {
                            throw new Error('Invalid response format: could not extract JSON');
                        }

                        // Get JSON content and parse it
                        const jsonString = jsonMatch[1] ? jsonMatch[1].trim() : text.match(/{[\s\S]*}/)[0];
                        const result = JSON.parse(jsonString);

                        // Validate the parsed receipt data
                        this.validateReceiptData(result);

                        console.log(`Success with ${model.name}`);
                        return result;
                    } catch (error) {
                        console.error(`${model.name} failed:`, error);
                        lastError = error;
                        continue; // Try next model
                    }
                }

                // If we get here, all models failed
                console.error('All models failed to process the receipt');
                throw new Error('לא ניתן היה לזהות את נתוני הקבלה - ' + lastError.message);
            },
            
            // Validate receipt data
            validateReceiptData(data) {
                // Check that all required fields are present
                const requiredFields = ['date', 'total_payment', 'reception_number'];
                for (const field of requiredFields) {
                    if (!data.hasOwnProperty(field)) {
                        throw new Error(`Missing required field: ${field}`);
                    }
                }

                // Validate date format (allow multiple formats)
                const dateFormats = [
                    /^\d{2}\/\d{2}\/\d{2}$/, // DD/MM/YY
                    /^\d{2}\.\d{2}\.\d{2}$/, // DD.MM.YY
                    /^\d{2}-\d{2}-\d{2}$/    // DD-MM-YY
                ];
                
                let validDateFormat = false;
                for (const dateRegex of dateFormats) {
                    if (dateRegex.test(data.date)) {
                        validDateFormat = true;
                        break;
                    }
                }
                
                if (!validDateFormat) {
                    // Try to normalize the date format
                    const normalizedDate = this.normalizeDate(data.date);
                    if (normalizedDate) {
                        data.date = normalizedDate;
                    } else {
                        throw new Error('Invalid date format. Expected DD/MM/YY');
                    }
                }
                
                // Normalize date to DD/MM/YY if needed
                if (data.date.includes('.') || data.date.includes('-')) {
                    data.date = data.date.replace(/[.-]/g, '/');
                }
                
                // Validate total_payment format (allow more flexibility)
                const paymentFormats = [
                    /^\d{1,3}(?:,\d{3})*\.\d{2}$/, // X,XXX.XX
                    /^\d+\.\d{2}$/,                 // XXXX.XX
                    /^\d+$/                         // XXXX (whole number)
                ];
                
                let validPaymentFormat = false;
                for (const paymentRegex of paymentFormats) {
                    if (paymentRegex.test(data.total_payment)) {
                        validPaymentFormat = true;
                        break;
                    }
                }
                
                if (!validPaymentFormat) {
                    // Try to normalize by removing non-numeric chars except . and ,
                    const normalizedPayment = data.total_payment.replace(/[^\d.,]/g, '');
                    if (/^[\d.,]+$/.test(normalizedPayment)) {
                        data.total_payment = normalizedPayment;
                    } else {
                        throw new Error('Invalid total_payment format');
                    }
                }
                
                // If payment is a whole number, add decimal places
                if (/^\d+$/.test(data.total_payment)) {
                    data.total_payment = data.total_payment + '.00';
                }
                
                // Format with thousands separator if needed
                if (!data.total_payment.includes(',')) {
                    const parts = data.total_payment.split('.');
                    parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                    data.total_payment = parts.join('.');
                }

                // Validate reception_number (more flexible)
                if (!data.reception_number || data.reception_number.length < 3) {
                    // Generate a placeholder if missing or too short
                    data.reception_number = 'INV' + Math.floor(Math.random() * 90000 + 10000);
                }
            },
            
            // Helper to normalize date from various formats
            normalizeDate(dateString) {
                // Try to extract day, month, year with various separators
                const dateMatch = dateString.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
                if (dateMatch) {
                    let [_, day, month, year] = dateMatch;
                    
                    // Handle 2-digit day/month
                    day = day.padStart(2, '0');
                    month = month.padStart(2, '0');
                    
                    // Handle 4-digit year
                    if (year.length === 4) {
                        year = year.substring(2);
                    }
                    
                    return `${day}/${month}/${year}`;
                }
                
                return null;
            }
        };

        // ============= INITIALIZE APP =============
        // Execute when DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app
            ExpenseApp.init();
            
            // Expose necessary methods to global scope for HTML event handlers
            window.ExpenseBuilder = ExpenseBuilder;
            window.FormHandler = FormHandler;
            window.FileHandler = FileHandler;
            window.SignatureManager = SignatureManager;
            window.UIManager = UIManager;
        });
    })();
    </script>
</body>
</html>