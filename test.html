<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="description" content="דוח החזר הוצאות - מערכת מקוונת להגשת דיווחי הוצאות עבור עובדי אברא. נהל את כל ההוצאות שלך באופן דיגיטלי, כולל דלק, נסיעות, חניה, קילומטרים והוצאות אחרות.">
  <meta name="keywords" content="דוח הוצאות, החזר הוצאות, אברא, דיווח הוצאות, דלק, נסיעות, חניה, קילומטרים, מערכת דיווח">
  <meta name="author" content="Abra">
  <meta name="application-name" content="מערכת החזר הוצאות">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/abra Profile Photo.png" type="image/png">
  <link rel="apple-touch-icon" href="/abra Profile Photo.png">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://expenses.abra.co.il/">
<meta property="og:title" content="דוח החזר הוצאות | Abra">
<meta property="og:description" content="מערכת מקוונת להגשת ומעקב אחר דיווחי הוצאות עבור עובדי אברא">
<meta property="og:image" content="https://media.licdn.com/dms/image/v2/C4D0BAQH8RXrIA-H-Wg/company-logo_200_200/company-logo_200_200/0/1659272782073?e=2147483647&v=beta&t=c59UA2Jwtt5lgjHuNuYL_dwa2UI86qTVuh7Ix-aFD4I">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://expenses.abra.co.il/">
<meta property="twitter:title" content="דוח החזר הוצאות | Abra">
<meta property="twitter:description" content="מערכת מקוונת להגשת ומעקב אחר דיווחי הוצאות עבור עובדי אברא">
<meta property="twitter:image" content="https://media.licdn.com/dms/image/v2/C4D0BAQH8RXrIA-H-Wg/company-logo_200_200/company-logo_200_200/0/1659272782073?e=2147483647&v=beta&t=c59UA2Jwtt5lgjHuNuYL_dwa2UI86qTVuh7Ix-aFD4I">

<!-- Mobile App meta -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Abra החזר הוצאות">
<meta name="format-detection" content="telephone=no">

<!-- Security -->

<meta http-equiv="X-Content-Type-Options" content="nosniff">

<meta name="referrer" content="strict-origin-when-cross-origin">

<!-- Language and direction -->
<meta name="language" content="Hebrew">
<meta property="og:locale" content="he_IL">
  <title>דוח החזר הוצאות | Abra</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.0/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="style.css?ver=1.3" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script src="pdf.js"></script>
  <style>

  </style>
  <script type="text/javascript">
    (function (c, l, a, r, i, t, y) {
      c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
      t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
      y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
    })(window, document, "clarity", "script", "q8n5bdb421");
  </script>
</head>

<body class="body-he">
  <header class="header header-animate">
    <div class="container">
      <div class="header-content">
        <h1 class="header-title heading-he text-h1">דוח החזר הוצאות</h1>
        <div class="d-flex align-items-center gap-3">
          <!-- Theme Toggle Button -->
          <button class="theme-toggle" aria-label="Toggle dark mode" title="שינוי מצב תצוגה">
            <i class="fas fa-sun light-icon"></i>
            <i class="fas fa-moon dark-icon"></i>
          </button>
          <!-- Company Logo -->
          <div class="logo-container">
            <img src="abra logo FullColor white PNG.png" alt="Company Logo" class="company-logo" loading="eager">
          </div>
        </div>
      </div>
    </div>
  </header>
  <div class="container mt-3">
    <div class="progress" style="height: 8px;">
      <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
        aria-valuemax="100"></div>
    </div>
  </div>
  <div class="container">
    <form id="expenseForm">
      <!-- Basic Info Section -->
      <div class="info-section mb-4">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">חודש</label>
            <input type="month" class="form-control" name="month" required disabled>
          </div>
          <div class="col-md-3">
            <label class="form-label">אימייל עובד/ת</label>
            <input type="email" class="form-control" name="employeeEmail" placeholder="הזן את כתובת האימייל שלך"
              required>
          </div>
          <div class="col-md-3">
            <label class="form-label">אימייל מנהל/ת ישיר</label>
            <input type="email" class="form-control" name="managerEmail" placeholder="הזן את כתובת האימייל של המנהל/ת"
              required>
          </div>
          <div class="col-md-3" hidden>
            <label class="form-label">חטיבה/מחלקה</label>
            <input type="text" class="form-control" name="department">
          </div>
        </div>
      </div>

      <!-- Quick Add Bar -->
      <div class="quick-add-bar">
        <div class="d-flex gap-3 flex-wrap">
          <button type="button" class="quick-add-button" onclick="quickAdd('fuel')" data-bs-toggle="tooltip"
            data-bs-placement="top" title="הוסף הוצאת דלק - צרף תמונת קבלה לזיהוי אוטומטי של הפרטים">
            <i class="fas fa-gas-pump"></i>
            דלק
          </button>
          <button type="button" class="quick-add-button" onclick="quickAdd('route')" data-bs-toggle="tooltip"
            data-bs-placement="top" title="הוסף נסיעות בתחבורה ציבורית - למשל: מונית, אוטובוס" </button>
            <i class="fas fa-route"></i>
            נסיעות
          </button>
          <button type="button" class="quick-add-button" onclick="quickAdd('parking')" data-bs-toggle="tooltip"
            data-bs-placement="top" title="הוסף הוצאת חניה - צרף קבלה או אישור תשלום">
            <i class="fas fa-parking"></i>
            חניה
          </button>
          <button type="button" class="quick-add-button" onclick="quickAdd('kilometers')" data-bs-toggle="tooltip"
            data-bs-placement="top" title="הוסף הוצאת קילומטרים - ציון מספר הקילומטרים והמטרה של הנסיעה">
            <i class="fas fa-road"></i>
            קילומטרים
          </button>
          <button type="button" class="quick-add-button" onclick="quickAdd('other')" data-bs-toggle="tooltip"
            data-bs-placement="top" title="הוסף הוצאה אחרת - למשל:  ציוד, כיבוד, הוצאות משרדיות">
            <i class="fas fa-receipt"></i>
            הוצאה אחרת
          </button>
          <button type="button" class="quick-add-button" disabled data-bs-toggle="tooltip" data-bs-placement="top" data-bs-original-title="אפשרות זו תהיה זמינה בקרוב">
            <span class="coming-soon-badge">בפיתוח</span>
            <div class="button-content">
                <i class="fas fa-plane"></i>
              חו"ל
            </div>
          </button>
        </div>
      </div>

      <!-- Expenses Container -->
      <div id="expensesContainer"></div>

      <!-- Signatures Section -->
      <div class="signature-section">
        <h5 class="mb-4">חתימות</h5>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="signature-container">
              <div class="signature-label">
                <i class="fas fa-user"></i>
                חתימת העובד
              </div>
              <canvas id="employeeSignature" class="signature-pad"></canvas>
              <div class="signature-actions">
                <button type="button" class="signature-button" onclick="clearSignature('employeeSignature')">
                  <i class="fas fa-eraser"></i>
                  נקה חתימה
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="signature-container">
              <div class="signature-label">
                <i class="fas fa-user-tie"></i>
                חתימת מנהל ישיר
              </div>
              <canvas id="managerSignature" class="signature-pad"></canvas>
              <div class="signature-actions">
                <button type="button" class="signature-button" onclick="clearSignature('managerSignature')">
                  <i class="fas fa-eraser"></i>
                  נקה חתימה
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </form>
  </div>

  <!-- Floating Total with Submit -->
  <div class="floating-total">
    <div>
      סה"כ: <span id="totalAmount">0.00</span> ₪
    </div>
    <button type="submit" form="expenseForm" class="submit-button">
      <i class="fas fa-paper-plane"></i>
      שלח דוח
    </button>
  </div>

  <script>
    // Global function that works even before the app is initialized
    function quickAdd(type) {
      

      // If we already have ExpenseBuilder initialized, use it directly
      if (window.ExpenseBuilder && typeof window.ExpenseBuilder.quickAdd === 'function') {
        window.ExpenseBuilder.quickAdd(type);
        return;
      }

      // Otherwise, store the request for later processing
      if (!window._pendingQuickAdds) {
        window._pendingQuickAdds = [];

        // Set up a processor for pending requests that runs after initialization
        const originalInit = window.onload || function () { };
        window.onload = function () {
          originalInit();
          if (window.ExpenseBuilder && window._pendingQuickAdds) {
            window._pendingQuickAdds.forEach(pendingType => {
              window.ExpenseBuilder.quickAdd(pendingType);
            });
            window._pendingQuickAdds = [];
          }
        };
      }

      // Add this request to the pending list
      window._pendingQuickAdds.push(type);
    }
    /**
 * Optimized Expense Report Application
 * 
 * A modular JavaScript application for managing expense reports
 * Improved for performance, maintainability, and user experience
 */

    // Use an IIFE to avoid polluting the global scope
    (function () {
      'use strict';

      // ============= CONSTANTS =============
      const GEMINI_API_KEY = 'AIzaSyDixJ-7jmpArj67qP5mbT95roaO6gvCES4';
      const API_ENDPOINT = 'https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke';
      const API_PARAMS = 'api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs';

      // ============= CORE APP MODULE =============
      const ExpenseApp = {
        // Core app state
        state: {
          mode: 'new', // 'new' or 'review'
          id: null,
          categoryTotals: {
            fuel: 0,
            route: 0,
            parking: 0,
            kilometers: 0,
            other: 0
          },
          initialized: false
        },

        // Initialize the application
        init() {
          if (this.state.initialized) return;

          // Set initial state from URL
          const urlParams = new URLSearchParams(window.location.search);
          this.state.id = urlParams.get('id');
          this.state.mode = this.state.id ? 'review' : 'new';

          // Initialize modules in order of dependency
          UIManager.init();
          SignatureManager.init();
          FileHandler.init();
          PdfRenderer.init();
          ValidationManager.init();
          FormHandler.init();

          // Initialize appropriate mode
          if (this.state.mode === 'review') {
            this.initializeReviewMode();
          } else {
            this.initializeNewSubmissionMode();
          }

          // Register global event listeners
          this.registerEventListeners();

          // Mark as initialized
          this.state.initialized = true;
        },

        // Initialize review mode
        async initializeReviewMode() {
          try {
            const progressTracker = UIManager.createTimingProgressIndicator('טוען נתוני דוח...');

            const fetchPromise = ApiService.getExpenseReport(this.state.id);
            const response = await progressTracker.updateFetchProgress(fetchPromise);
            const data = await response.json();

            DataManager.populateExpenseReport(data);
            UIManager.setupManagerReviewMode(data);

            progressTracker.close();
          } catch (error) {
            console.error('Error fetching expense report:', error);
            UIManager.hideLoadingOverlay();
            UIManager.showNotification('שגיאה בטעינת הדוח: ' + error.message, 'error');
          }
        },

        // Initialize new submission mode
        initializeNewSubmissionMode() {
          // Set current month as default
          FormHandler.setDefaultMonth();

          // Configure UI for new submission
          UIManager.configureForNewSubmission();

          // Initialize category tracking
          this.resetCategoryTotals();
        },

        // Register global event listeners
        registerEventListeners() {
          // Form submission handler
          document.getElementById('expenseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (this.state.mode === 'review') {
              await FormHandler.handleManagerApprove(e);
            } else {
              await FormHandler.handleNewSubmission(e);
            }
          });



          // Theme toggler
          document.querySelector('.theme-toggle').addEventListener('click', UIManager.toggleTheme);

          // Global input handler for expense amounts with debounce
          const debounceTimeout = 300; // ms
          let debounceTimer;
          document.addEventListener('input', (e) => {
            if (e.target.classList.contains('expense-amount')) {
              clearTimeout(debounceTimer);
              debounceTimer = setTimeout(() => {
                const card = e.target.closest('.expense-card');
                if (card) {
                  const expenseType = card.dataset.expenseType || 'other';
                  ExpenseCalculator.updateExpenseAmount(e.target, expenseType);
                }
              }, debounceTimeout);
            }
          });

          // Progress update on required field changes
          document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('change', FormHandler.updateProgress);
          });
        },

        // Reset category totals
        resetCategoryTotals() {
          this.state.categoryTotals = {
            fuel: 0,
            route: 0,
            parking: 0,
            kilometers: 0,
            other: 0
          };
          ExpenseCalculator.updateLiveTotal();
        }
      };

      // ============= UI MANAGER MODULE =============
      const UIManager = {
        tooltipInstances: new Map(),
        loadingOverlays: [],

        init() {
          this.setupTheme();
          this.initTooltips();
          this.setupHeaderBehavior();
          this.createFilePreviewOverlay();
          this.addValidationStyles();
        },

        // Setup initial theme
        setupTheme() {
          // Check user preference or stored setting
          const savedTheme = localStorage.getItem('theme');
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

          if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
          } else if (prefersDark) {
            document.documentElement.setAttribute('data-theme', 'dark');
          }
        },

        // Toggle theme between light and dark
        toggleTheme() {
          const currentTheme = document.documentElement.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

          document.documentElement.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);

          // Update signature colors and re-render any visible signatures
          SignatureManager.updateSignatureColors();
        },

        // Initialize tooltips
        initTooltips() {
          // Clear existing tooltip instances
          this.tooltipInstances.forEach(instance => {
            if (instance && typeof instance.dispose === 'function') {
              instance.dispose();
            }
          });
          this.tooltipInstances.clear();

          // Create new tooltips with improved performance
          const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
          tooltips.forEach(element => {
            const instance = new bootstrap.Tooltip(element, {
              trigger: 'hover focus',
              boundary: 'window',
              delay: { show: 500, hide: 100 }
            });
            this.tooltipInstances.set(element, instance);
          });

          // Add helpful tooltips to form elements
          this.addHelpfulTooltips();
        },

        // Add helpful tooltips to key form elements
        addHelpfulTooltips() {
          const tooltipMappings = [
            { selector: 'input[name="month"]', title: 'בחר את החודש עבורו מוגש הדוח' },
            { selector: 'input[name="employeeEmail"]', title: 'הזן את כתובת המייל שלך כפי שהיא רשומה במערכת' },
            { selector: 'input[name="managerEmail"]', title: 'הזן את כתובת המייל של המנהל הישיר שלך שיאשר את ההוצאות' },
            { selector: 'input[name="department"]', title: 'בחר את המחלקה או החטיבה אליה אתה שייך' },
            { selector: '.signature-pad', title: 'חתום כאן - לחץ והחזק את העכבר תוך כדי ציור החתימה' }
          ];

          tooltipMappings.forEach(mapping => {
            const elements = document.querySelectorAll(mapping.selector);
            elements.forEach(element => {
              element.setAttribute('data-bs-toggle', 'tooltip');
              element.setAttribute('data-bs-placement', 'top');
              element.setAttribute('title', mapping.title);

              // Create tooltip instance
              const instance = new bootstrap.Tooltip(element, {
                trigger: 'hover focus',
                boundary: 'window',
                delay: { show: 500, hide: 100 }
              });
              this.tooltipInstances.set(element, instance);
            });
          });
        },

        // Setup header behavior with Intersection Observer
        setupHeaderBehavior() {
          const header = document.querySelector('.header');
          if (!header) return;

          // Use IntersectionObserver for better performance
          const headerObserver = new IntersectionObserver(
            (entries) => {
              entries.forEach(entry => {
                if (!entry.isIntersecting) {
                  entry.target.classList.add('scrolled');
                } else {
                  entry.target.classList.remove('scrolled');
                }
              });
            },
            { threshold: [0, 0.1, 1], rootMargin: '-50px 0px 0px 0px' }
          );

          headerObserver.observe(header);
        },

        // Create file preview overlay if it doesn't exist
        createFilePreviewOverlay() {
          if (document.getElementById('filePreviewOverlay')) return;

          const overlay = document.createElement('div');
          overlay.id = 'filePreviewOverlay';
          overlay.className = 'file-preview-overlay';
          overlay.innerHTML = `
        <div class="preview-content">
          <button type="button" class="close-preview" onclick="closePreview()">
            <i class="fas fa-times"></i>
          </button>
          <div class="preview-container">
            <!-- Content will be dynamically inserted here -->
          </div>
        </div>
      `;

          document.body.appendChild(overlay);

          // Enable close with escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && overlay.classList.contains('active')) {
              this.closePreview();
            }
          });
        },

        // Configure UI for new submission
        configureForNewSubmission() {
          // Update employee name field label and placeholder
          const employeeEmailInput = document.querySelector('input[name="employeeEmail"]');
          if (employeeEmailInput) {
            const label = employeeEmailInput.previousElementSibling;
            if (label) label.textContent = 'אימייל עובד/ת';
            employeeEmailInput.placeholder = 'הזן את כתובת האימייל שלך';
            employeeEmailInput.type = 'email';
          }

          // Update manager email field placeholder
          const managerEmailInput = document.querySelector('input[name="managerEmail"]');
          if (managerEmailInput) {
            managerEmailInput.placeholder = 'הזן את כתובת האימייל של המנהל/ת';
            managerEmailInput.type = 'email';
          }

          // Configure signature sections
          this.configureSignatureSections();
        },

        // Configure signature sections for new submission
        configureSignatureSections() {
          const signatureSections = document.querySelectorAll('.signature-container');
          signatureSections.forEach((section, index) => {
            if (index !== 0) {
              // Hide all signature sections except the first one (employee signature)
              section.style.display = 'none';
            } else {
              // Show the first signature section (employee signature)
              section.style.display = 'block';
            }
          });

          // Adjust canvas dimensions for proper display
          SignatureManager.adjustCanvasDimensions('employeeSignature');
        },

        // Setup manager review mode UI
        setupManagerReviewMode(data) {
          // Get status from the response
          const status = data.expense_main[0].Status.Value;
          const rejectionReason = data.expense_main[0].Reject_Reason;
          const isFinalized = status === 'Approved' || status === 'Rejected';

          // Create or update status header
          this.createManagerReviewHeader(status, rejectionReason);

          // Update form fields
          this.configureReviewModeFields();

          // Handle signatures based on status
          SignatureManager.configureSignaturesForReviewMode(isFinalized);

          // Update floating total section
          this.updateFloatingTotalForReviewMode(isFinalized);

          // Hide unnecessary elements
          this.hideElementsInReviewMode();

          // Add manager review class to body for CSS targeting
          document.body.classList.add('manager-review-mode');
          if (status === 'Approved') document.body.classList.add('status-approved');
          if (status === 'Rejected') document.body.classList.add('status-rejected');

          // Update total with animation
          ExpenseCalculator.updateLiveTotal();

          // Update progress bar
          FormHandler.updateProgress();
        },

        // Create manager review header with status
        createManagerReviewHeader(status, rejectionReason = '') {
  // First check if header already exists to avoid duplicates
  const existingHeader = document.querySelector('.manager-review-header');
  if (existingHeader) existingHeader.remove();

  // Create the header element
  const header = document.createElement('div');
  header.className = 'alert alert-info manager-review-header';
  header.style.margin = '0';
  header.style.borderRadius = '0';

  // Set header text based on status
  let headerText = '';
  if (status === 'Approved') {
    headerText = 'הדוח אושר על ידי המנהל';
    header.className = 'alert alert-success manager-review-header';
    
    header.innerHTML = `
      <div class="container">
        <div class="d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i>
          <div>${headerText}</div>
        </div>
      </div>
    `;
  } else if (status === 'Rejected') {
    headerText = 'הדוח נדחה על ידי המנהל';
    header.className = 'alert alert-danger manager-review-header';
    
    header.innerHTML = `
      <div class="container">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <i class="fas fa-info-circle me-2"></i>
            <div>${headerText}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger p-0 rejection-reason-toggle" onclick="toggleRejectionReason(this)">
            <i class="fas fa-chevron-down me-1"></i>הצג סיבה
          </button>
        </div>
        <div class="rejection-reason-container mt-3" style="display: none;">
          <textarea class="form-control bg-light text-danger" readonly rows="3" 
            style="resize: none; border-color: rgba(220, 53, 69, 0.3);">${rejectionReason || 'לא צוינה סיבה לדחייה.'}</textarea>
        </div>
      </div>
    `;
  } else {
    headerText = 'הנך מתבקש/ת לסקור את הדוח ולחתום כמנהל/ת ישיר/ה';
    
    header.innerHTML = `
      <div class="container">
        <div class="d-flex align-items-center">
          <i class="fas fa-info-circle me-2"></i>
          <div>${headerText}</div>
        </div>
      </div>
    `;
  }

  const mainHeader = document.querySelector('header.header');
  if (mainHeader) {
    mainHeader.parentNode.insertBefore(header, mainHeader.nextSibling);
  }
  
  // Add the toggle function if it doesn't exist yet
  if (status === 'Rejected' && !window.toggleRejectionReason) {
    window.toggleRejectionReason = function(button) {
      const container = button.closest('.alert').querySelector('.rejection-reason-container');
      const isVisible = container.style.display !== 'none';
      
      // Toggle container visibility with animation
      if (isVisible) {
        container.style.maxHeight = container.scrollHeight + 'px';
        setTimeout(() => {
          container.style.maxHeight = '0';
          setTimeout(() => {
            container.style.display = 'none';
            button.innerHTML = '<i class="fas fa-chevron-down me-1"></i>הצג סיבה';
          }, 300);
        }, 10);
      } else {
        container.style.display = 'block';
        container.style.maxHeight = '0';
        setTimeout(() => {
          container.style.maxHeight = container.scrollHeight + 'px';
          button.innerHTML = '<i class="fas fa-chevron-up me-1"></i>הסתר סיבה';
        }, 10);
      }
    };
    
    // Add CSS for smooth transitions
    const style = document.createElement('style');
    style.textContent = `
      .rejection-reason-container {
        overflow: hidden;
        max-height: 0;
        transition: max-height 0.3s ease-out;
      }
      
      .rejection-reason-toggle {
        transition: all 0.2s ease;
        text-decoration: none !important;
      }
      
      .rejection-reason-toggle:hover {
        opacity: 0.8;
      }
    `;
    document.head.appendChild(style);
  }
},

        // Configure form fields for review mode
        configureReviewModeFields() {
          // Update employee email field
          const employeeEmailInput = document.querySelector('input[name="employeeEmail"]');
          if (employeeEmailInput) {
            const employeeEmailLabel = employeeEmailInput.previousElementSibling;
            if (employeeEmailLabel) employeeEmailLabel.textContent = 'אימייל עובד/ת';
            employeeEmailInput.type = 'email';
            employeeEmailInput.placeholder = '';
          }

          // Update manager email field
          const managerEmailInput = document.querySelector('input[name="managerEmail"]');
          if (managerEmailInput) {
            const managerEmailLabel = managerEmailInput.previousElementSibling;
            if (managerEmailLabel) managerEmailLabel.textContent = 'אימייל מנהל/ת ישיר';
            managerEmailInput.type = 'email';
            managerEmailInput.placeholder = '';
          }

          // Show the department field that's hidden by default
          const departmentField = document.querySelector('input[name="department"]').closest('.col-md-3');
          if (departmentField) {
            departmentField.removeAttribute('hidden');
          }

          // Make form fields readonly
          document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"], input[type="date"], input[type="month"]').forEach(input => {
            input.readOnly = true;
          });
        },

        // Update floating total section for review mode
        updateFloatingTotalForReviewMode(isFinalized) {
          const floatingTotal = document.querySelector('.floating-total');
          if (!floatingTotal) return;

          if (isFinalized) {
            // If approved/rejected, show total with expand option
            floatingTotal.innerHTML = `
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <div>
            סה"כ: <span id="totalAmount">0.00</span> ₪
          </div>
          <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
      </div>
    `;
          } else {
            // Show approve/reject buttons for pending review with expand option
            floatingTotal.innerHTML = `
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <div>
            סה"כ: <span id="totalAmount">0.00</span> ₪
          </div>
          <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div class="d-flex gap-3">
          <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
            <i class="fas fa-times"></i> דחה דוח
          </button>
          <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
            <i class="fas fa-check"></i> אשר דוח
          </button>
        </div>
      </div>
    `;
          }

          // Set initial state and add event handlers
          floatingTotal.dataset.state = 'collapsed';
          ExpenseCalculator.setupTotalClickHandlers(floatingTotal);
        },

        // Hide unnecessary elements in review mode
        hideElementsInReviewMode() {
          const elementsToHide = [
            '.quick-add-bar',
            '.btn-outline-danger',
            '.file-drop-zone',
            '.file-remove'
          ];

          elementsToHide.forEach(selector => {
            document.querySelectorAll(selector).forEach(el => {
              el.style.display = 'none';
            });
          });
        },

        // Show notification toast
        showNotification(message, type = 'info') {
          // Map Bootstrap alert types to SweetAlert2 types
          const swalType = type === 'danger' ? 'error' : type;

          return Swal.fire({
            title: '',
            text: message,
            icon: swalType,
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 5000,
            timerProgressBar: true,
            didOpen: (toast) => {
              toast.addEventListener('mouseenter', Swal.stopTimer);
              toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
          });
        },

        // Show loading overlay with progress tracking
        showLoadingOverlay(initialMessage = 'טוען נתונים...') {
          this.removeExistingOverlays();

          const stages = [
            { id: 'queued', label: 'בתור לעיבוד', icon: 'clock' },
            { id: 'connecting', label: 'מתחבר לשרת', icon: 'link' },
            { id: 'processing', label: 'מעבד נתונים', icon: 'cog' },
            { id: 'downloading', label: 'מוריד תוכן', icon: 'download' }
          ];

          const overlay = document.createElement('div');
          overlay.className = 'loading-overlay';
          overlay.setAttribute('role', 'dialog');
          overlay.setAttribute('aria-label', initialMessage);

          const content = document.createElement('div');
          content.className = 'loading-content';

          content.innerHTML = `
        <div class="loading-header">
          <div class="pulse-loader" aria-hidden="true"></div>
          <h5>${initialMessage}</h5>
        </div>
        <div class="stages-container">
          ${stages.map((stage) => `
            <div class="stage-item" data-stage="${stage.id}">
              <div class="stage-content">
                <div class="stage-icon">
                  <i class="fas fa-${stage.icon}" aria-hidden="true"></i>
                </div>
                <div class="stage-details">
                  <div class="stage-header">
                    <span class="stage-label">${stage.label}</span>
                    <div class="stage-meta">
                      <span class="stage-duration">0ms</span>
                      <span class="stage-status-dot" aria-hidden="true"></span>
                    </div>
                  </div>
                  <div class="stage-progress">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

          this.addLoadingOverlayStyles();
          overlay.appendChild(content);
          document.body.appendChild(overlay);

          // Store for cleanup
          this.loadingOverlays.push(overlay);

          // Return control API
          return {
            updateStage: (stageId, progress) => {
              const stageElement = overlay.querySelector(`[data-stage="${stageId}"]`);
              if (!stageElement) return;

              // Update progress bar
              const progressBar = stageElement.querySelector('.progress-bar');
              if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
              }

              // Mark as active
              stageElement.classList.add('active');

              // Mark as completed if 100%
              if (progress === 100) {
                stageElement.classList.add('completed');

                // Animate to next stage
                const nextStage = stageElement.nextElementSibling;
                if (nextStage) {
                  setTimeout(() => {
                    nextStage.classList.add('active');
                  }, 300);
                }
              }
            },
            setMessage: (message) => {
              const messageElement = content.querySelector('h5');
              if (messageElement) {
                messageElement.textContent = message;
                overlay.setAttribute('aria-label', message);
              }
            },
            close: () => {
              overlay.style.opacity = '0';
              overlay.addEventListener('transitionend', () => {
                overlay.remove();
                const index = this.loadingOverlays.indexOf(overlay);
                if (index > -1) this.loadingOverlays.splice(index, 1);
              });
            }
          };
        },

        // Add CSS styles for loading overlay
        addLoadingOverlayStyles() {
          if (document.getElementById('loading-overlay-styles')) return;

          const style = document.createElement('style');
          style.id = 'loading-overlay-styles';
          style.textContent = `
        .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          backdrop-filter: blur(8px);
          -webkit-backdrop-filter: blur(8px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          opacity: 1;
          transition: opacity 0.3s ease;
        }

        .loading-content {
          background: var(--bs-body-bg);
          border-radius: 16px;
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          width: 90%;
          max-width: 400px;
          padding: 2rem;
          animation: slideIn 0.3s ease-out;
        }

        .loading-header {
          text-align: center;
          margin-bottom: 2rem;
        }

        .pulse-loader {
          width: 48px;
          height: 48px;
          border: 4px solid var(--bs-primary);
          border-radius: 50%;
          margin: 0 auto 1rem;
          position: relative;
          animation: pulse 1.2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        }

        .stage-item {
          margin-bottom: 1.5rem;
          opacity: 0.7;
          transition: all 0.3s ease;
        }

        .stage-item.active {
          opacity: 1;
        }

        .stage-content {
          display: flex;
          align-items: flex-start;
          gap: 1rem;
        }

        .stage-icon {
          background: var(--bs-gray-100);
          width: 36px;
          height: 36px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.3s ease;
        }

        .stage-item.completed .stage-icon {
          background: var(--bs-success);
          color: white;
        }

        .stage-details {
          flex: 1;
        }

        .stage-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 0.5rem;
        }

        .stage-label {
          font-weight: 500;
          color: var(--bs-body-color);
        }

        .stage-meta {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-size: 0.875rem;
          color: var(--bs-gray-600);
        }

        .stage-status-dot {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: var(--bs-gray-400);
          transition: all 0.3s ease;
        }

        .stage-item.completed .stage-status-dot {
          background: var(--bs-success);
        }

        .stage-progress {
          height: 4px;
          background: var(--bs-gray-200);
          border-radius: 2px;
          overflow: hidden;
        }

        .progress-bar {
          height: 100%;
          background: var(--bs-primary);
          width: 0;
          transition: width 0.3s ease;
        }

        @keyframes pulse {
          0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0.7);
          }
          70% {
            transform: scale(1);
            box-shadow: 0 0 0 10px rgba(var(--bs-primary-rgb), 0);
          }
          100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(var(--bs-primary-rgb), 0);
          }
        }

        @keyframes slideIn {
          from {
            transform: translateY(20px);
            opacity: 0;
          }
          to {
            transform: translateY(0);
            opacity: 1;
          }
        }
      `;

          document.head.appendChild(style);
        },

        // Add CSS for validation styling
        addValidationStyles() {
          if (document.getElementById('validation-styles')) return;

          const style = document.createElement('style');
          style.id = 'validation-styles';
          style.textContent = `
        .invalid-signature {
          border: 2px solid var(--bs-danger) !important;
        }
        
        .invalid-drop-zone {
          border: 2px dashed var(--bs-danger) !important;
        }
        
        .invalid-feedback {
          display: none;
          color: var(--bs-danger);
          font-size: 0.875em;
          margin-top: 0.25rem;
        }
        
        .invalid-feedback.d-block {
          display: block;
        }
      `;

          document.head.appendChild(style);
        },

        // Remove existing overlays
        removeExistingOverlays() {
          this.loadingOverlays.forEach(overlay => overlay.remove());
          this.loadingOverlays = [];
        },

        // Hide loading overlay
        hideLoadingOverlay() {
          this.removeExistingOverlays();
        },

        // Open file preview
        openPreview(element) {
          const overlay = document.getElementById('filePreviewOverlay');
          if (!overlay) return;

          const container = overlay.querySelector('.preview-container');
          if (!container) return;

          // Clear previous content
          container.innerHTML = '';

          try {
            if (element.tagName === 'IMG') {
              // Handle image preview
              container.classList.remove('pdf-mode');
              const img = document.createElement('img');
              img.src = element.src;
              img.alt = 'תצוגה מקדימה';
              container.appendChild(img);
            } else if (element.classList.contains('pdf-preview')) {
              // Handle PDF preview
              container.classList.add('pdf-mode');

              // First check for base64 data (review mode)
              const fileData = element.closest('.file-preview-item')?.dataset.originalFile;
              if (fileData) {
                // In review mode - use the base64 data
                PdfRenderer.renderPDF(fileData, container);
              } else {
                // In upload mode - use the object URL
                const pdfUrl = element.dataset.pdfUrl;
                if (!pdfUrl) {
                  throw new Error('PDF data not found');
                }
                PdfRenderer.renderPDF(pdfUrl, container);
              }
            }

            // Show overlay with animation
            overlay.classList.add('active');

            // Add keyboard listener for escape key
            document.addEventListener('keydown', this.handleEscKey);
          } catch (error) {
            console.error('Preview error:', error);
            this.showNotification('שגיאה בטעינת התצוגה המקדימה: ' + error.message, 'error');
          }
        },

        // Close preview
        closePreview() {
          const overlay = document.getElementById('filePreviewOverlay');
          if (overlay) {
            overlay.classList.remove('active');

            // Remove event listeners
            document.removeEventListener('keydown', this.handleEscKey);
          }
        },

        // Handle escape key press
        handleEscKey(e) {
          if (e.key === 'Escape') {
            UIManager.closePreview();
          }
        },

        // Create timing progress indicator for loading operations
        createTimingProgressIndicator(initialMessage) {
          const startTime = performance.now();
          const progress = this.showLoadingOverlay(initialMessage);

          function formatDuration(ms) {
            if (ms < 1000) return `${Math.round(ms)}ms`;
            const seconds = ms / 1000;
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = (seconds % 60).toFixed(0);
            return `${minutes}:${remainingSeconds.padStart(2, '0')}`;
          }

          return {
            updateFetchProgress: async (fetchPromise) => {
              try {
                // Start connection phase
                progress.updateStage('queued', 100);
                progress.updateStage('connecting', 0);

                const response = await fetchPromise;
                const clonedResponse = response.clone();

                // Connection complete, start processing
                progress.updateStage('connecting', 100);
                progress.updateStage('processing', 50);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length') || 0;
                let receivedLength = 0;

                // Start download phase
                progress.updateStage('processing', 100);
                progress.updateStage('downloading', 0);

                // Read the stream
                while (true) {
                  const { done, value } = await reader.read();
                  if (done) break;

                  receivedLength += value.length;
                  const downloadProgress = contentLength ?
                    Math.round((receivedLength / contentLength) * 100) :
                    50;

                  progress.updateStage('downloading', downloadProgress);

                  // Update elapsed time
                  const elapsed = formatDuration(performance.now() - startTime);
                  progress.setMessage(`טוען נתוני דוח... (${elapsed})`);
                }

                // Complete download phase
                progress.updateStage('downloading', 100);

                return clonedResponse;
              } catch (error) {
                throw error;
              }
            },
            close: () => progress.close()
          };
        }
      };

      // ============= DATA MANAGER MODULE =============
      const DataManager = {
        // Populate expense report with retrieved data
        populateExpenseReport(data) {
          // Update form fields with data
          document.querySelector('input[name="month"]').value = data.expense_main[0].Month;
          document.querySelector('input[name="employeeEmail"]').value = data.expense_main[0].EmployeeName.Email || '';
          document.querySelector('input[name="managerEmail"]').value = data.expense_main[0].Approver.Email || '';
          document.querySelector('input[name="department"]').value = data.expense_main[0].EmployeeName.Department;

          // Populate expenses
          this.populateExpenseItems(data.expense_items);

          // Handle signatures
          this.populateSignatures(data.data?.signatures);

          // Handle attached files
          this.populateAttachedFiles(data.data?.files);

          // Update progress bar
          FormHandler.updateProgress();
        },

        // Populate expense items
        populateExpenseItems(items) {
          const container = document.getElementById('expensesContainer');
          container.innerHTML = ''; // Clear existing expenses

          // Reset category totals before populating
          ExpenseApp.resetCategoryTotals();

          // Add expense items
          items.forEach(item => {
            // Log the item data for debugging
            

            let expenseType = 'other';
            if (item.ExpenseType?.toLowerCase().includes('דלק')) {
              expenseType = 'fuel';
            } else if (item.ExpenseType?.toLowerCase().includes('חניה')) {
              expenseType = 'parking';
            } else if (item.ExpenseType?.toLowerCase().includes('נסיעות')) {
              expenseType = 'route';
            } else if (item.ExpenseType?.toLowerCase().includes('קילומטרים')) {
              expenseType = 'kilometers';
            }

            ExpenseBuilder.quickAdd(expenseType);
            const card = container.firstElementChild;
            if (!card) return;

            card.dataset.expenseId = item.ID;
            card.dataset.expenseType = expenseType;

            // Populate fields
            this.populateExpenseItemFields(card, item);
          });

          // Update total and category breakdowns
          ExpenseCalculator.updateLiveTotal();
        },

        // Populate fields for a single expense item
        populateExpenseItemFields(card, item) {
          // Convert and set date
          let expenseDate = '';
          if (item.ExpenseDate) {
            try {
              const date = new Date(item.ExpenseDate);
              expenseDate = date.toLocaleDateString('en-CA');
            } catch (error) {
              console.warn('Invalid date format:', item.ExpenseDate);
            }
          }

          // Get all inputs
          const dateInput = card.querySelector('input[type="date"]');
          const invoiceInput = card.querySelector('input[placeholder="הזן מספר חשבונית"]');
          const amountInput = card.querySelector('.expense-amount');
          const notesInput = card.querySelector('#note');

          // Set values and make readonly
          if (dateInput) {
            dateInput.value = expenseDate;
            dateInput.readOnly = true;
          }

          if (invoiceInput) {
            invoiceInput.value = item.InvoiceNumber || '';
            invoiceInput.readOnly = true;
          }

          // Handle amount field - special handling for kilometers expenses
          if (amountInput) {
            const amount = parseFloat(item.Amount) || 0;
            amountInput.value = amount;
            amountInput.readOnly = true;

            // Add to category total
            const expenseType = card.dataset.expenseType;
            ExpenseApp.state.categoryTotals[expenseType] += amount;
          }

          // Handle notes field - check for both lowercase and uppercase property names
          if (notesInput) {
            notesInput.value = item.Notes || item.notes || '';
            notesInput.readOnly = true;
          }

          // Special handling for kilometers expenses
          if (card.dataset.expenseType === 'kilometers') {
            // For kilometers expenses, we interpret the Amount field as distance in kilometers
            if (amountInput) {
              // Make sure placeholder reflects kilometers
              amountInput.placeholder = "לדוגמה: 2.3";

              // Update the input group text to show kilometers instead of currency
              const inputGroupText = amountInput.nextElementSibling;
              if (inputGroupText && inputGroupText.classList.contains('input-group-text')) {
                inputGroupText.textContent = 'ק"מ';
              }
            }

            // For kilometers, notes are required and should contain journey purpose
            if (notesInput) {
              notesInput.placeholder = "מטרת נסיעה ויעד";
              notesInput.required = true;
            }

            // Hide file drop zone and preview for kilometers expenses if they exist
            const fileDropZone = card.querySelector('.file-drop-zone');
            if (fileDropZone) {
              fileDropZone.style.display = 'none';
            }

            const filePreview = card.querySelector('.file-preview');
            if (filePreview) {
              filePreview.style.display = 'none';
            }
          }
        }
        ,

        // Populate signatures from retrieved data
        populateSignatures(signatures) {
          if (!signatures || !Array.isArray(signatures)) return;

          signatures.forEach(sig => {
            if (sig.file && sig.id) {
              let padId;
              // Match signature to correct pad
              if (sig.id.toLowerCase().includes('empsig')) {
                padId = 'employeeSignature';
              } else if (sig.id.toLowerCase().includes('mngrsig')) {
                padId = 'managerSignature';
              }

              if (padId && SignatureManager.signaturePads[padId]) {
                const canvas = SignatureManager.signaturePads[padId].canvas;
                // Store original data
                canvas.dataset.originalSignature = sig.file;
                canvas.dataset.signatureId = sig.id;
                // Draw signature
                SignatureManager.drawSignatureToCanvas(canvas, sig.file, SignatureManager.signaturePads[padId]);
              }
            }
          });
        },

        // Populate attached files from retrieved data
        populateAttachedFiles(files) {
          if (!files || !Array.isArray(files)) return;

          const container = document.getElementById('expensesContainer');
          if (!container) return;

          files.forEach(fileData => {
            if (fileData.file && fileData.id) {
              const card = container.querySelector(`[data-expense-id="${fileData.id}"]`);
              if (!card) return;

              const previewContainer = card.querySelector('.file-preview');
              if (!previewContainer) return;

              FileHandler.addFilePreview(previewContainer, fileData);
            }
          });
        },

        // Collect all expense data for submission
        async collectExpenseData() {
          const expenses = [];

          // Process each expense card
          for (const card of document.querySelectorAll('.expense-card')) {
            const type = card.querySelector('.expense-type-indicator')?.textContent.trim();
            const fileElements = card.querySelectorAll('.file-preview-item');
            const files = [];

            // Process each file
            for (const el of fileElements) {
              const fileData = await FileHandler.getFileData(el);
              if (fileData) {
                files.push(fileData);
              }
            }

            expenses.push({
              type: type,
              date: card.querySelector('input[type="date"]')?.value || '',
              invoice: card.querySelector('input[placeholder="הזן מספר חשבונית"]')?.value || '',
              amount: parseFloat(card.querySelector('.expense-amount')?.value) || 0,
              notes: card.querySelector('#note')?.value || '',
              files: files
            });
          }

          return expenses;
        }
      };

      // ============= FORM HANDLER MODULE =============
      const FormHandler = {
        init() {
          // Register form-specific event listeners
          this.registerFormEventListeners();
        },

        // Register form-specific event listeners
        registerFormEventListeners() {
          // Update progress when required fields change
          document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('change', this.updateProgress);
          });

          // Update progress when signatures change
          Object.values(SignatureManager.signaturePads).forEach(pad => {
            pad.addEventListener('endStroke', this.updateProgress);
          });
        },

        // Set default month value for new submissions
        setDefaultMonth() {
          const today = new Date();
          const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
          document.querySelector('input[name="month"]').value = month;
        },

        // Update progress bar based on form completion
        updateProgress() {
          const form = document.getElementById('expenseForm');
          if (!form) return;

          const totalFields = form.querySelectorAll('[required]').length;
          const filledFields = Array.from(form.querySelectorAll('[required]')).filter(field => field.value).length;

          // Calculate signature completeness
          let signatureCount = 0;
          let filledSignatures = 0;

          if (ExpenseApp.state.mode === 'review') {
            // In review mode, only count manager signature
            signatureCount = 1;
            filledSignatures = SignatureManager.signaturePads.managerSignature &&
              !SignatureManager.signaturePads.managerSignature.isEmpty() ? 1 : 0;
          } else {
            // In new submission mode, only count employee signature
            signatureCount = 1;
            filledSignatures = SignatureManager.signaturePads.employeeSignature &&
              !SignatureManager.signaturePads.employeeSignature.isEmpty() ? 1 : 0;
          }

          // Calculate total progress
          const fieldWeight = 0.7;
          const signatureWeight = 0.3;
          const fieldProgress = totalFields > 0 ? (filledFields / totalFields) * fieldWeight : 0;
          const signatureProgress = signatureCount > 0 ? (filledSignatures / signatureCount) * signatureWeight : 0;
          const progress = (fieldProgress + signatureProgress) * 100;

          const progressBar = document.querySelector('.progress-bar');
          if (progressBar) {
            // Use CSS transition for smooth animation
            progressBar.style.transition = 'width 0.5s ease-in-out';
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
          }
        },

        // Validate the entire form
        validateForm() {
          const form = document.getElementById('expenseForm');
          const isReviewMode = ExpenseApp.state.mode === 'review';
          let isValid = true;

          // Clear all existing validation errors first
          document.querySelectorAll('.is-invalid').forEach(el => {
            ValidationManager.clearValidationError(el);
          });

          // Validate required fields
          const requiredFields = form.querySelectorAll('[required]');
          requiredFields.forEach(field => {
            if (!field.value) {
              isValid = ValidationManager.handleValidationError(field, 'שדה חובה');
            }
          });

          // Validate email format
          const emailInputs = form.querySelectorAll('input[type="email"]');
          emailInputs.forEach(emailInput => {
            if (emailInput && emailInput.value) {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(emailInput.value)) {
                isValid = ValidationManager.handleValidationError(emailInput, 'כתובת אימייל לא תקינה');
              }
            }
          });

          // Validate expenses exist
          const expenseCards = document.querySelectorAll('.expense-card');
          if (expenseCards.length === 0) {
            UIManager.showNotification('יש להוסיף לפחות הוצאה אחת', 'warning');
            isValid = false;
          }

          // Validate expense amounts
          expenseCards.forEach(card => {
            const amountInput = card.querySelector('.expense-amount');
            if (amountInput && (isNaN(amountInput.value) || parseFloat(amountInput.value) <= 0)) {
              isValid = ValidationManager.handleValidationError(amountInput, 'יש להזין סכום חיובי');
            }
          });

          // Validate file attachments
          expenseCards.forEach(card => {
            // Check if this is a route expense type (which doesn't require attachments)
            const isRouteExpense = card.querySelector('.expense-type-route1') !== null;

            // Skip attachment validation for route expenses
            if (isRouteExpense) {
              // If there's a dropzone that's marked as invalid, fix it
              const dropZone = card.querySelector('.file-drop-zone');
              if (dropZone && dropZone.classList.contains('invalid-drop-zone')) {
                dropZone.classList.remove('invalid-drop-zone');
                ValidationManager.clearValidationError(dropZone);
              }
              return; // Continue to next card
            }

            const filePreview = card.querySelector('.file-preview');
            const dropZone = card.querySelector('.file-drop-zone');

            if (!filePreview || filePreview.children.length === 0) {
              if (dropZone) {
                dropZone.classList.add('invalid-drop-zone');
                isValid = ValidationManager.handleValidationError(dropZone, 'יש לצרף קבלה או אסמכתא');
              }
            } else {
              if (dropZone) {
                dropZone.classList.remove('invalid-drop-zone');
                ValidationManager.clearValidationError(dropZone);
              }
            }
          });

          // Validate signatures based on mode
          if (isReviewMode) {
            // Manager signature validation in review mode
            if (SignatureManager.signaturePads.managerSignature &&
              SignatureManager.signaturePads.managerSignature.isEmpty()) {
              const canvas = SignatureManager.signaturePads.managerSignature.canvas;
              canvas.classList.add('invalid-signature');
              isValid = ValidationManager.handleValidationError(canvas, 'נדרשת חתימת מנהל');
            }
          } else {
            // Employee signature validation in new submission mode
            if (SignatureManager.signaturePads.employeeSignature &&
              SignatureManager.signaturePads.employeeSignature.isEmpty()) {
              const canvas = SignatureManager.signaturePads.employeeSignature.canvas;
              canvas.classList.add('invalid-signature');
              isValid = ValidationManager.handleValidationError(canvas, 'נדרשת חתימת עובד');
            }
          }

          // Add input listener to clear validation on change
          ValidationManager.setupValidationClearingListeners();

          return isValid;
        },

        // Show reject dialog for reports
        async showRejectDialog() {
          return new Promise((resolve) => {
            Swal.fire({
              title: 'סיבת דחייה',
              input: 'textarea',
              inputPlaceholder: 'אנא ציין את סיבת הדחייה',
              showCancelButton: true,
              confirmButtonText: 'שלח',
              cancelButtonText: 'ביטול',
              reverseButtons: true,
              inputValidator: (value) => {
                if (!value.trim()) {
                  return 'אנא ציין את סיבת הדחייה';
                }
              }
            }).then((result) => {
              if (result.isConfirmed) {
                resolve(result.value);
              } else {
                resolve(null);
              }
            });
          });
        },

        // Handle report rejection
        async handleRejectReport() {
          try {
            // Get the reason for rejection
            const reason = await this.showRejectDialog();
            if (!reason) return; // User cancelled

            const overlay = UIManager.showLoadingOverlay('שולח דחייה...');

            const response = await ApiService.rejectExpenseReport(ExpenseApp.state.id, reason);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            UIManager.hideLoadingOverlay();
            UIManager.showNotification('הדוח נדחה בהצלחה', 'success');

            // Redirect after short delay
            setTimeout(() => {
              window.location.href = '/expenses/dashboard';
            }, 2000);

          } catch (error) {
            console.error('Error rejecting report:', error);
            UIManager.hideLoadingOverlay();
            UIManager.showNotification('שגיאה בדחיית הדוח: ' + error.message, 'error');
          }
        },

        // Handle manager approval
        async handleManagerApprove(e) {
          e.preventDefault();

          if (SignatureManager.signaturePads.managerSignature.isEmpty()) {
            UIManager.showNotification('נדרשת חתימת מנהל', 'warning');
            return;
          }

          const overlay = UIManager.showLoadingOverlay('שולח אישור...');

          try {
            const response = await ApiService.approveExpenseReport(
              ExpenseApp.state.id,
              SignatureManager.getSignatureData(SignatureManager.signaturePads.managerSignature)
            );

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            UIManager.hideLoadingOverlay();
            UIManager.showNotification('הדוח אושר בהצלחה!', 'success');

            // Redirect after successful approval
            setTimeout(() => {
              window.location.href = '/expenses/dashboard';
            }, 2000);

          } catch (error) {
            console.error('Error approving report:', error);
            UIManager.hideLoadingOverlay();
            UIManager.showNotification('שגיאה באישור הדוח: ' + error.message, 'error');
          }
        },

        // Handle new submission
        async handleNewSubmission(e) {
          if (!this.validateForm()) {
            return;
          }

          const overlay = UIManager.showLoadingOverlay('שולח נתונים...');

          try {
            const formData = new FormData(e.target);
            const expenses = await DataManager.collectExpenseData();

            const data = {
              employeeInfo: {
                month: document.querySelector('input[name="month"]').value,
                email: formData.get('employeeEmail'),
                managerEmail: formData.get('managerEmail')
              },
              expenses: expenses,
              signatures: {
                employee: SignatureManager.getSignatureData(SignatureManager.signaturePads.employeeSignature)
              },
              totalAmount: parseFloat(document.getElementById('totalAmount').textContent),
              submittedAt: new Date().toISOString()
            };

            const response = await ApiService.submitExpenseReport(data);

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            UIManager.hideLoadingOverlay();
            UIManager.showNotification('הדוח נשלח בהצלחה!', 'success');

            await this.showFormClearConfirmation(e.target);

          } catch (error) {
            console.error('Error:', error);
            UIManager.hideLoadingOverlay();
            UIManager.showNotification('אירעה שגיאה בשליחת הדוח: ' + error.message, 'error');
          }
        },

        // Show confirmation for clearing form after successful submission
        async showFormClearConfirmation(form) {
          const result = await Swal.fire({
            title: 'ניקוי טופס',
            text: 'האם ברצונך לנקות את הטופס?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'כן, נקה',
            cancelButtonText: 'ביטול',
            reverseButtons: true
          });

          if (result.isConfirmed) {
            form.reset();
            Object.values(SignatureManager.signaturePads).forEach(pad => pad.clear());
            document.getElementById('expensesContainer').innerHTML = '';
            ExpenseApp.resetCategoryTotals();
            ExpenseCalculator.updateLiveTotal();
            ExpenseApp.initializeNewSubmissionMode();
          }
        }
      };

      // ============= SIGNATURE MANAGER MODULE =============
      const SignatureManager = {
        signaturePads: {},

        init() {
          // Initialize all signature pads
          this.signaturePads = {
            employeeSignature: this.initSignaturePad('employeeSignature'),
            managerSignature: this.initSignaturePad('managerSignature')
          };
        },

        // Initialize a signature pad
        initSignaturePad(elementId) {
          const canvas = document.getElementById(elementId);
          if (!canvas) return null;

          // Function to properly resize canvas with DPR handling
          const resizeCanvas = () => {
            const rect = canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            // Set canvas size accounting for DPR
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            // Scale context to match DPR
            const ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);
          };

          // Force an initial reflow to ensure correct dimensions
          canvas.style.display = 'none';
          canvas.offsetHeight; // Trigger reflow
          canvas.style.display = 'block';

          // Initial resize with a small delay to ensure layout is complete
          setTimeout(resizeCanvas, 0);

          // Configure pad with coordinate transformation
          const pad = new SignaturePad(canvas, {
            penColor: this.getSignatureColor(),
            backgroundColor: 'transparent',
            velocityFilterWeight: 0.5,
            minWidth: 0.5,
            maxWidth: 2.5,
            throttle: 16,
            minDistance: 0.5,
            dotSize: 1.5
          });

          // Handle window resize with debounce
          let resizeTimeout;
          const handleResize = () => {
            const data = pad.toData();
            resizeCanvas();
            if (canvas.dataset.originalSignature) {
              this.drawSignatureToCanvas(canvas, canvas.dataset.originalSignature, pad);
            } else if (data && data.length) {
              pad.fromData(data);
            }
          };

          // Ensure canvas is properly sized when tab becomes visible
          document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
              handleResize();
            }
          });

          window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 100);
          });

          // Add touch event listeners for mobile
          this.addTouchEventListeners(pad);

          // Force a resize after a short delay to ensure everything is properly initialized
          setTimeout(handleResize, 100);

          return pad;
        },

        // Add touch event listeners for better mobile support
        addTouchEventListeners(pad) {
          const canvas = pad.canvas;

          // Prevent scrolling while signing
          canvas.addEventListener('touchstart', function (e) {
            if (e.cancelable) e.preventDefault();
          }, { passive: false });

          canvas.addEventListener('touchmove', function (e) {
            if (e.cancelable) e.preventDefault();
          }, { passive: false });

          canvas.addEventListener('touchend', function (e) {
            if (e.cancelable) e.preventDefault();
          }, { passive: false });
        },

        // Get signature color based on theme
        getSignatureColor() {
          const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
          return isDarkMode ? '#ffffff' : '#121f3f'; // White for dark mode, Abra navy for light mode
        },

        // Update signature colors when theme changes
        updateSignatureColors() {
          const newColor = this.getSignatureColor();

          Object.values(this.signaturePads).forEach(pad => {
            if (pad) {
              // If pad is not empty, save data, update color, and redraw
              if (!pad.isEmpty()) {
                const data = pad.toData();
                pad.penColor = newColor;
                pad.clear();
                pad.fromData(data);
              } else {
                pad.penColor = newColor;
              }
            }
          });
        },

        // Clear a signature pad
        clearSignature(id) {
          if (this.signaturePads[id]) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');

            // Clear canvas and data
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            delete canvas.dataset.originalSignature;
            delete canvas.dataset.signatureId;

            this.signaturePads[id].clear();
            this.signaturePads[id].penColor = this.getSignatureColor();

            // Trigger progress update
            FormHandler.updateProgress();
          }
        },

        // Draw signature to canvas from base64 data
        drawSignatureToCanvas(canvas, base64Data, padInstance) {
          const ctx = canvas.getContext('2d');
          const img = new Image();

          img.onload = function () {
            // Clear any existing content
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Get the device pixel ratio and canvas display size
            const dpr = window.devicePixelRatio || 1;
            const displayWidth = canvas.width / dpr;
            const displayHeight = canvas.height / dpr;

            // Calculate scale to fit signature within 80% of the canvas
            const scaleWidth = (displayWidth * 0.99) / img.width;
            const scaleHeight = (displayHeight * 0.99) / img.height;
            const scale = Math.min(scaleWidth, scaleHeight);

            // Calculate dimensions that maintain aspect ratio
            const finalWidth = img.width * scale;
            const finalHeight = img.height * scale;

            // Center the signature
            const x = (displayWidth - finalWidth) / 2;
            const y = (displayHeight - finalHeight) / 2;

            // Draw the image with proper DPR scaling
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            ctx.drawImage(img, x, y, finalWidth, finalHeight);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // Mark the signature pad as having content
            if (padInstance) {
              padInstance._isEmpty = false;
            }
          };

          img.src = 'data:image/png;base64,' + base64Data;
        },

        // Adjust canvas dimensions for proper display
        adjustCanvasDimensions(canvasId) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return;

          const containerWidth = canvas.parentElement.offsetWidth;
          const canvasHeight = containerWidth / 2.34; // Apply 2.34:1 ratio
          canvas.style.height = `${canvasHeight}px`;

          // Force canvas resize after setting new dimensions
          if (this.signaturePads[canvasId]) {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * window.devicePixelRatio;
            canvas.height = rect.height * window.devicePixelRatio;

            const ctx = canvas.getContext('2d');
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
            this.signaturePads[canvasId].clear(); // Clear and reinitialize
          }
        },

        // Configure signatures for review mode
        configureSignaturesForReviewMode(isFinalized) {
          Object.keys(this.signaturePads).forEach(key => {
            if (this.signaturePads[key]) {
              // If status is Approved or Rejected, make all signatures readonly
              if (isFinalized) {
                this.signaturePads[key].off();
                const canvas = this.signaturePads[key].canvas;
                if (canvas) {
                  canvas.style.cursor = 'not-allowed';
                  canvas.style.opacity = '0.7';
                }
                // Hide all clear buttons when finalized
                const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                if (clearButton) {
                  clearButton.style.display = 'none';
                }
              } else {
                // Normal behavior - only manager signature is editable
                if (key !== 'managerSignature') {
                  this.signaturePads[key].off();
                  const canvas = this.signaturePads[key].canvas;
                  if (canvas) {
                    canvas.style.cursor = 'not-allowed';
                    canvas.style.opacity = '0.7';
                  }
                  // Hide clear button for non-manager signatures
                  const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                  if (clearButton) {
                    clearButton.style.display = 'none';
                  }
                } else {
                  this.signaturePads[key].on();
                  const canvas = this.signaturePads[key].canvas;
                  if (canvas) {
                    canvas.style.opacity = '1';
                  }
                  // Show clear button for manager signature
                  const clearButton = canvas.closest('.signature-container').querySelector('.signature-actions button');
                  if (clearButton) {
                    clearButton.style.display = 'block';
                  }
                }
              }
            }
          });
        },

        // Get signature data as base64 string
        getSignatureData(signaturePad) {
          if (!signaturePad || signaturePad.isEmpty()) return null;

          // Get as PNG with transparent background
          const dataUrl = signaturePad.toDataURL('image/png');

          // Remove the data URL prefix
          return dataUrl.split(',')[1];
        }
      };

      // ============= FILE HANDLER MODULE =============
      const FileHandler = {
        init() {
          // Set up global drag and drop listeners
          this.setupGlobalDragAndDrop();
        },

        // Setup global drag and drop listeners
        setupGlobalDragAndDrop() {
          // Prevent default drag behaviors
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.addEventListener(eventName, (e) => {
              // Only prevent default if it's a file being dragged
              if (e.dataTransfer && e.dataTransfer.types.includes('Files')) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, false);
          });
        },

        // Handle drag over event
        handleDragOver(event) {
          event.preventDefault();
          event.currentTarget.classList.add('drag-over');
        },

        // Handle drag leave event
        handleDragLeave(event) {
          event.preventDefault();
          event.currentTarget.classList.remove('drag-over');
        },

        // Handle file drop event
        handleFileDrop(event, dropZone) {
          event.preventDefault();
          dropZone.classList.remove('drag-over');

          const files = event.dataTransfer.files;
          this.handleFiles(files, dropZone);
        },

        // Handle file select from input
        handleFileSelect(event, dropZone) {
          const files = event.target.files;
          this.handleFiles(files, dropZone);
        },

        // Process dropped or selected files
        async handleFiles(files, dropZone) {
          // Get necessary elements
          const expenseCard = dropZone.closest('.expense-card');
          const previewContainer = dropZone.nextElementSibling;

          if (!expenseCard || !previewContainer) return;

          // Check current file count
          const currentFileCount = previewContainer.querySelectorAll('.file-preview-item').length;

          // Filter valid files (images and PDFs)
          const validFiles = Array.from(files).filter(file => {
            const type = file.type.toLowerCase();
            return type.startsWith('image/') || type === 'application/pdf';
          });

          // Validate file types
          if (validFiles.length !== files.length) {
            UIManager.showNotification('רק קבצי תמונה ו-PDF מותרים להעלאה', 'warning');
            return;
          }

          // Check if adding new files would exceed the limit
          if (currentFileCount + validFiles.length > 2) {
            UIManager.showNotification('ניתן לצרף עד 2 קבצים להוצאה', 'warning');
            return;
          }

          // Check for file size (limit to 5MB per file)
          const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes
          const oversizedFiles = validFiles.filter(file => file.size > MAX_FILE_SIZE);
          if (oversizedFiles.length > 0) {
            UIManager.showNotification('גודל הקובץ חייב להיות קטן מ-5MB', 'warning');
            return;
          }

          // Check if important fields already have data
          const amountInput = expenseCard.querySelector('.expense-amount');
          const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
          const hasExistingData = (amountInput?.value || invoiceInput?.value);

          for (const file of validFiles) {
            try {
              if (file.type.startsWith('image/')) {
                await this.processImageFile(file, previewContainer, expenseCard, hasExistingData);
              } else if (file.type === 'application/pdf') {
                this.processPdfFile(file, previewContainer);
              }
            } catch (error) {
              console.error('Error handling file:', error);
              UIManager.showNotification('שגיאה בטעינת הקובץ: ' + error.message, 'error');
            }
          }

          // After all files are processed, check total count and update drop zone
          const totalFileCount = previewContainer.querySelectorAll('.file-preview-item').length;
          this.updateDropZoneAfterUpload(dropZone, totalFileCount);

          // Update validation status
          const fileDropValidation = dropZone.classList.contains('invalid-drop-zone');
          if (fileDropValidation && totalFileCount > 0) {
            dropZone.classList.remove('invalid-drop-zone');
            const errorDiv = dropZone.parentNode.querySelector('.invalid-feedback');
            if (errorDiv) {
              errorDiv.remove();
            }
          }

          // Update progress bar
          FormHandler.updateProgress();
        },

        // Process image file
        async processImageFile(file, previewContainer, expenseCard, hasExistingData) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();

            reader.onload = async function (e) {
              try {
                // Create and add preview
                const preview = document.createElement('div');
                preview.className = 'file-preview-item';
                preview.innerHTML =
                  `<img src="${e.target.result}" alt="Preview">
              <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)">
                <i class="fas fa-times"></i>
              </button>`;

                preview.addEventListener('click', () => {
                  UIManager.openPreview(preview.querySelector('img'));
                });

                previewContainer.appendChild(preview);

                // Only process receipt if no existing data
                if (!hasExistingData) {
                  // Add loading overlay
                  const loadingOverlay = document.createElement('div');
                  loadingOverlay.className = 'processing-overlay';
                  loadingOverlay.innerHTML =
                    `<div class="processing-spinner"></div>
                <div>מעבד את הקבלה...</div>`;
                  expenseCard.style.position = 'relative';
                  expenseCard.appendChild(loadingOverlay);

                  try {
                    loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'מזהה פרטי קבלה...';
                    const base64Image = e.target.result.split(',')[1];
                    const receiptData = await ApiService.processReceiptImage(base64Image);

                    loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'ממלא נתונים...';
                    await ExpenseBuilder.populateExpenseFields(expenseCard, receiptData);

                    loadingOverlay.remove();
                    UIManager.showNotification('נתוני הקבלה זוהו והוזנו בהצלחה', 'success');
                  } catch (error) {
                    console.error('Error processing receipt:', error);
                    loadingOverlay.remove();
                    UIManager.showNotification('לא ניתן היה לזהות את נתוני הקבלה באופן אוטומטי', 'warning');
                  }
                }

                resolve();
              } catch (error) {
                reject(error);
              }
            };

            reader.onerror = () => {
              reject(new Error('שגיאה בקריאת הקובץ'));
            };

            reader.readAsDataURL(file);
          });
        },

        // Process PDF file
        processPdfFile(file, previewContainer) {
          const pdfUrl = URL.createObjectURL(file);
          const pdfPreview = document.createElement('div');
          pdfPreview.className = 'file-preview-item pdf-preview';
          pdfPreview.dataset.pdfUrl = pdfUrl;
          pdfPreview.innerHTML =
            `<i class="fas fa-file-pdf"></i>
        <span>${file.name}</span>
        <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)">
          <i class="fas fa-times"></i>
        </button>`;

          pdfPreview.addEventListener('click', () => {
            UIManager.openPreview(pdfPreview);
          });

          // Store the object URL for cleanup
          pdfPreview.dataset.objectUrl = pdfUrl;
          previewContainer.appendChild(pdfPreview);
        },

        // Update drop zone after file upload
        updateDropZoneAfterUpload(dropZone, totalFileCount) {
          // Hide drop zone if 2 files are uploaded
          if (totalFileCount >= 2) {
            dropZone.style.display = 'none';
          } else {
            // Update drop zone text
            const remainingFiles = 2 - totalFileCount;
            const textDiv = dropZone.querySelector('div:not(.text-muted)');
            if (textDiv) {
              if (remainingFiles === 1) {
                textDiv.textContent = 'ניתן להוסיף עוד קובץ אחד';
              } else {
                textDiv.textContent = 'ניתן להוסיף עוד ' + remainingFiles + ' קבצים';
              }
            }
          }
        },

        // Remove file from preview
        removeFile(button) {
          const previewItem = button.closest('.file-preview-item, .pdf-preview');
          if (!previewItem) return;

          const previewContainer = previewItem.parentElement;
          const expenseCard = previewContainer?.closest('.expense-card');
          if (!expenseCard) return;

          const dropZone = expenseCard.querySelector('.file-drop-zone');

          // Cleanup object URL if it exists
          if (previewItem.dataset.objectUrl) {
            URL.revokeObjectURL(previewItem.dataset.objectUrl);
          }

          // Remove the file preview
          previewItem.remove();

          // Count remaining files
          const remainingFiles = previewContainer.querySelectorAll('.file-preview-item').length;

          // Show drop zone and update text if we have less than 2 files
          if (dropZone && remainingFiles < 2) {
            dropZone.style.display = 'block';

            // Update the drop zone text
            const textDiv = dropZone.querySelector('div:not(.text-muted)');
            if (textDiv) {
              if (remainingFiles === 0) {
                textDiv.textContent = 'גרור קבצים לכאן או לחץ להעלאה';
              } else {
                textDiv.textContent = 'ניתן להוסיף עוד קובץ אחד';
              }
            }
          }

          // Update progress
          FormHandler.updateProgress();
        },

        // Add file preview from retrieved data
        addFilePreview(previewContainer, fileData) {
          const previewItem = document.createElement('div');
          const isPdf = fileData.name.toLowerCase().endsWith('.pdf');
          previewItem.className = isPdf ? 'file-preview-item pdf-preview' : 'file-preview-item';
          previewItem.dataset.originalFile = fileData.file;

          if (isPdf) {
            previewItem.innerHTML = `
          <i class="fas fa-file-pdf"></i>
          <span>${fileData.name}</span>
          <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)" disabled>
            <i class="fas fa-times"></i>
          </button>
        `;
          } else {
            const mimeType = fileData.name.split('.').pop().toLowerCase() === 'png' ? 'image/png' : 'image/jpeg';
            const dataUrl = `data:${mimeType};base64,${fileData.file}`;
            previewItem.innerHTML = `
          <img src="${dataUrl}" alt="${fileData.name}">
          <button type="button" class="file-remove" onclick="event.stopPropagation(); FileHandler.removeFile(this)" disabled>
            <i class="fas fa-times"></i>
          </button>
        `;
          }

          previewItem.addEventListener('click', () => {
            UIManager.openPreview(previewItem.querySelector('img') || previewItem);
          });

          previewContainer.appendChild(previewItem);

          // Hide drop zone
          const dropZone = previewContainer.closest('.expense-card').querySelector('.file-drop-zone');
          if (dropZone) dropZone.style.display = 'none';
        },

        // Get file data for submission
        async getFileData(element) {
          let fileType, fileData, fileName;

          if (element.classList.contains('pdf-preview')) {
            // Handle PDF files
            fileType = 'application/pdf';
            fileName = element.querySelector('span')?.textContent || `document_${Date.now()}.pdf`;

            // Handle different PDF data sources
            if (element.dataset.originalFile) {
              // Review mode - already in base64
              fileData = element.dataset.originalFile;
            } else if (element.dataset.pdfUrl && element.dataset.pdfUrl.startsWith('blob:')) {
              // Upload mode - need to convert blob URL to base64
              fileData = await this.blobToBase64(element.dataset.pdfUrl);
            }
          } else {
            // Handle image files
            const img = element.querySelector('img');
            if (!img) return null;

            fileType = img.src.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
            fileName = `receipt_${Date.now()}.${fileType.split('/')[1]}`;

            if (img.src.startsWith('data:')) {
              // Image is already in base64
              fileData = img.src.split(',')[1];
            } else if (img.src.startsWith('blob:')) {
              // Convert blob URL to base64
              fileData = await this.blobToBase64(img.src);
            }
          }

          // Only return data if we successfully got all parts
          if (fileData && fileType && fileName) {
            return {
              type: fileType,
              name: fileName,
              body: fileData
            };
          }

          return null;
        },

        // Convert blob URL to base64
        async blobToBase64(blobUrl) {
          const response = await fetch(blobUrl);
          const blob = await response.blob();

          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
              // Remove the data URL prefix
              const base64Data = reader.result.split(',')[1];
              resolve(base64Data);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        }
      };

      // ============= EXPENSE BUILDER MODULE =============
      const ExpenseBuilder = {
        // Quick add expense card based on type
        quickAdd(type) {
          const container = document.getElementById('expensesContainer');
          if (!container) return;

          const today = new Date().toISOString().split('T')[0];

          const card = document.createElement('div');
          card.className = 'expense-card animate__animated animate__fadeIn';
          card.dataset.expenseType = type; // Store expense type for category tracking

          let typeLabel, typeIcon, typeClass;
          switch (type) {
            case 'fuel':
              typeLabel = 'דלק';
              typeIcon = 'gas-pump';
              typeClass = 'fuel';
              break;
            case 'parking':
              typeLabel = 'חניה';
              typeIcon = 'parking';
              typeClass = 'parking';
              break;
            case 'route':
              typeLabel = 'נסיעות';
              typeIcon = 'route';
              typeClass = 'route';
              break;
            case 'kilometers':
              typeLabel = 'קילומטרים';
              typeIcon = 'road';
              typeClass = 'kilometers';
              break;
            case 'other':
              typeLabel = 'הוצאה אחרת';
              typeIcon = 'receipt';
              typeClass = 'other';
              break;
          }

          if (type === 'kilometers') {
            card.innerHTML = `
      <div class="expense-type-indicator expense-type-${typeClass}">
        <i class="fas fa-${typeIcon}"></i>
        ${typeLabel}
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">תאריך</label>
          <input type="date" class="form-control" value="${today}" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">מרחק (ק"מ)</label>
          <div class="input-group">
            <input type="number" step="0.1" min="0.1" class="form-control expense-amount" placeholder="לדוגמה: 2.3" required>
            <span class="input-group-text">ק"מ</span>
          </div>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-danger w-100" onclick="ExpenseBuilder.removeExpenseRow(this)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="col-md-12">
          <label class="form-label">הערות נוספות</label>
          <textarea class="form-control" id="note" rows="2" placeholder="הוסף מטרת נסיעה ויעד" required></textarea>
        </div>
      </div>
    `;
          } else {
            // Original HTML structure for other expense types
            card.innerHTML = `
      <div class="expense-type-indicator expense-type-${typeClass}">
        <i class="fas fa-${typeIcon}"></i>
        ${typeLabel}
      </div>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label">תאריך</label>
          <input type="date" class="form-control" value="${today}" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">מספר חשבונית</label>
          <input type="text" class="form-control" placeholder="הזן מספר חשבונית" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">סכום</label>
          <div class="input-group">
            <input type="number" step="0.01" class="form-control expense-amount" required>
            <span class="input-group-text">₪</span>
          </div>
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-outline-danger w-100" onclick="ExpenseBuilder.removeExpenseRow(this)">
            <i class="fas fa-trash"></i>
          </button>
        </div>
        <div class="col-md-12">
          <label class="form-label">הערות נוספות</label>
          <textarea class="form-control" id="note" rows="2" placeholder="הוסף הערות או פרטים נוספים לגבי ההוצאה (לא חובה)"></textarea>
        </div>
        <div class="col-12">
          <div class="file-drop-zone" ondrop="FileHandler.handleFileDrop(event, this)" 
               ondragover="FileHandler.handleDragOver(event)" 
               ondragleave="FileHandler.handleDragLeave(event)">
            <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 2rem;"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="צלם את הקבלה באמצעות הטלפון או גרור לכאן קובץ PDF"></i>
            <div>גרור קבצים לכאן או לחץ להעלאה</div>
            <div class="text-muted">(תמונות או PDF בלבד)</div>
            <input type="file" class="d-none" accept="image/*,.pdf" multiple 
                   onchange="FileHandler.handleFileSelect(event, this.parentElement)">
          </div>
          <div class="file-preview"></div>
        </div>
      </div>
    `;
          }

          container.insertBefore(card, container.firstChild);

          // Set up real-time expense amount tracking
          const amountInput = card.querySelector('.expense-amount');
          amountInput.addEventListener('input', function () {
            ExpenseCalculator.updateExpenseAmount(this, type);
          });

          // Add click handler for file upload zone ONLY if this is not a kilometers expense
          if (type !== 'kilometers') {
            const dropZone = card.querySelector('.file-drop-zone');
            if (dropZone) { // Add a null check for safety
              dropZone.addEventListener('click', () => {
                dropZone.querySelector('input[type="file"]').click();
              });
            }
          }

          // Initialize tooltips
          UIManager.initTooltips();

          // Additional handling for review mode
          if (ExpenseApp.state.mode === 'review') {
            // Hide delete buttons in review mode
            const deleteButton = card.querySelector('.btn-outline-danger');
            if (deleteButton) {
              deleteButton.style.display = 'none';
            }
          }

          // Return the created card for chaining
          return card;
        },

        // Remove expense row
        removeExpenseRow(button) {
          const card = button.closest('.expense-card');
          if (!card) return;

          const expenseType = card.dataset.expenseType || 'other';
          const amountInput = card.querySelector('.expense-amount');
          const amount = parseFloat(amountInput?.value) || 0;

          // Subtract from category total
          ExpenseApp.state.categoryTotals[expenseType] -= amount;

          // Fade out and remove the card
          card.classList.remove('animate__fadeIn');
          card.classList.add('animate__fadeOut');

          card.addEventListener('animationend', () => {
            card.remove();
            ExpenseCalculator.updateLiveTotal();
          });
        },

        // Populate expense fields from receipt data
        async populateExpenseFields(expenseCard, receiptData) {
          try {
            // Convert date from DD/MM/YY to YYYY-MM-DD for input field
            const [day, month, year] = receiptData.date.split('/');
            const fullYear = '20' + year; // Assuming all dates are from 2000s
            const formattedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

            // Populate date field
            const dateInput = expenseCard.querySelector('input[type="date"]');
            if (dateInput) dateInput.value = formattedDate;

            // Populate invoice number
            const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
            if (invoiceInput) invoiceInput.value = receiptData.reception_number;

            // Populate amount (remove commas and convert to number)
            const amountInput = expenseCard.querySelector('.expense-amount');
            if (amountInput) {
              const amount = receiptData.total_payment.replace(/,/g, '');
              amountInput.value = parseFloat(amount);

              // Trigger the input event to update category totals
              const expenseType = expenseCard.dataset.expenseType;
              ExpenseCalculator.updateExpenseAmount(amountInput, expenseType);
            }

            console.log('Receipt data populated successfully:', receiptData);
          } catch (error) {
            console.error('Error populating fields:', error);
            throw new Error('שגיאה במילוי הנתונים מהקבלה');
          }
        }
      };

      // ============= EXPENSE CALCULATOR MODULE =============
      // Updated functions to handle kilometer expenses without expand/collapse UI
      // Complete ExpenseCalculator Module
      const ExpenseCalculator = {
        // Update expense amount in real-time
        updateExpenseAmount(input, type) {
          const card = input.closest('.expense-card');
          const oldValue = parseFloat(card.dataset.lastAmount || '0');
          const newValue = parseFloat(input.value) || 0;

          // Update the tracker
          ExpenseApp.state.categoryTotals[type] = ExpenseApp.state.categoryTotals[type] - oldValue + newValue;

          // Store the current value for next update
          card.dataset.lastAmount = newValue;

          // Update totals with animation
          this.updateLiveTotal();
        },

        // Update live total display with animation
        updateLiveTotal() {
          // Calculate monetary total (excluding kilometers)
          const monetaryTotal = ExpenseApp.state.categoryTotals.fuel +
            ExpenseApp.state.categoryTotals.route +
            ExpenseApp.state.categoryTotals.parking +
            ExpenseApp.state.categoryTotals.other;

          // Get kilometers total separately
          const kilometersTotal = ExpenseApp.state.categoryTotals.kilometers;

          // Update floating total with proper handling
          this.updateFloatingTotalWithCategories(monetaryTotal, kilometersTotal);

          // Update progress bar
          FormHandler.updateProgress();
        },

        // Animate number changes
        animateNumber(start, end, options) {
          if (Math.abs(end - start) < 0.01) {
            options.onUpdate(end);
            return;
          }

          const startTime = performance.now();
          const duration = options.duration || 1000;

          const update = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Easing function for smooth animation
            const easeOutQuad = (t) => t * (2 - t);
            const easedProgress = easeOutQuad(progress);

            const currentValue = start + (end - start) * easedProgress;
            options.onUpdate(currentValue);

            if (progress < 1) {
              requestAnimationFrame(update);
            }
          };

          requestAnimationFrame(update);
        },

        // Update floating total with category breakdown
        updateFloatingTotalWithCategories(monetaryTotal, kilometersTotal) {
          const floatingTotal = document.querySelector('.floating-total');
          if (!floatingTotal) return;

          // Check mode
          const hasKilometers = kilometersTotal > 0;
          const isReviewMode = ExpenseApp.state.mode === 'review';
          const reviewModeApproved = document.body.classList.contains('status-approved') ||
            document.body.classList.contains('status-rejected');

          // If we don't have any state data, default to collapsed
          if (!floatingTotal.dataset.state) {
            floatingTotal.dataset.state = 'collapsed';
          }

          // Handle based on current state - always preserving collapse/expand functionality
          if (floatingTotal.dataset.state === 'collapsed') {
            // Generate collapsed state HTML - now including kilometers if present
            const collapsedHTML = `
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <div>
            סה"כ: <span id="totalAmount">${monetaryTotal.toFixed(2)}</span> ₪
            ${hasKilometers ? `
              | <span id="totalKilometers">${kilometersTotal.toFixed(2)}</span> ק"מ
            ` : ''}
          </div>
          <button type="button" class="btn-expand-total ms-2" aria-label="הצג פירוט">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        ${isReviewMode && !reviewModeApproved ? `
          <div class="d-flex gap-3">
            <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
              <i class="fas fa-times"></i> דחה דוח
            </button>
            <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
              <i class="fas fa-check"></i> אשר דוח
            </button>
          </div>
        ` : isReviewMode ? `` : `
          <button type="submit" form="expenseForm" class="submit-button">
            <i class="fas fa-paper-plane"></i>
            שלח דוח
          </button>
        `}
      </div>
    `;
            floatingTotal.innerHTML = collapsedHTML;
          } else if (floatingTotal.dataset.state === 'expanded') {
            // Generate expanded state HTML - including kilometers section if needed
            const expandedHTML = `
      <div class="expanded-total-content w-100">
        <div class="d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center">
            <div>פירוט הוצאות</div>
            <button type="button" class="btn-collapse-total ms-2" aria-label="הסתר פירוט">
              <i class="fas fa-chevron-down"></i>
            </button>
          </div>
          ${isReviewMode && !reviewModeApproved ? `
            <div class="d-flex gap-3">
              <button type="button" class="reject-button" onclick="FormHandler.handleRejectReport()">
                <i class="fas fa-times"></i> דחה דוח
              </button>
              <button type="button" class="approve-button" onclick="FormHandler.handleManagerApprove(event)">
                <i class="fas fa-check"></i> אשר דוח
              </button>
            </div>
          ` : isReviewMode ? `` : `
            <button type="submit" form="expenseForm" class="submit-button">
              <i class="fas fa-paper-plane"></i>
              שלח דוח
            </button>
          `}
        </div>
        <div class="category-totals mt-2">
          ${ExpenseApp.state.categoryTotals.fuel > 0 ? `
            <div class="category-total-item">
              <i class="fas fa-gas-pump"></i>
              <span>דלק:</span>
              <span class="category-amount">${ExpenseApp.state.categoryTotals.fuel.toFixed(2)} ₪</span>
            </div>
          ` : ''}
          ${ExpenseApp.state.categoryTotals.route > 0 ? `
            <div class="category-total-item">
              <i class="fas fa-route"></i>
              <span>נסיעות:</span>
              <span class="category-amount">${ExpenseApp.state.categoryTotals.route.toFixed(2)} ₪</span>
            </div>
          ` : ''}
          ${ExpenseApp.state.categoryTotals.parking > 0 ? `
            <div class="category-total-item">
              <i class="fas fa-parking"></i>
              <span>חניה:</span>
              <span class="category-amount">${ExpenseApp.state.categoryTotals.parking.toFixed(2)} ₪</span>
            </div>
          ` : ''}
          ${hasKilometers ? `
            <div class="category-total-item">
              <i class="fas fa-road"></i>
              <span>קילומטרים:</span>
              <span class="category-amount">${kilometersTotal.toFixed(2)} ק"מ</span>
            </div>
          ` : ''}
          ${ExpenseApp.state.categoryTotals.other > 0 ? `
            <div class="category-total-item">
              <i class="fas fa-receipt"></i>
              <span>הוצאות אחרות:</span>
              <span class="category-amount">${ExpenseApp.state.categoryTotals.other.toFixed(2)} ₪</span>
            </div>
          ` : ''}
          <div class="category-total-item grand-total">
            <span>סה"כ כספי:</span>
            <span class="category-amount" id="totalAmount">${monetaryTotal.toFixed(2)} ₪</span>
          </div>
          ${hasKilometers ? `
            <div class="category-total-item grand-total-kilometers">
              <span>סה"כ קילומטרים:</span>
              <span class="category-amount" id="totalKilometers">${kilometersTotal.toFixed(2)} ק"מ</span>
            </div>
          ` : ''}
        </div>
      </div>
    `;
            floatingTotal.innerHTML = expandedHTML;
          }

          // Update CSS classes based on state
          if (floatingTotal.dataset.state === 'expanded') {
            floatingTotal.classList.add('expanded');
            floatingTotal.classList.remove('collapsed');
          } else {
            floatingTotal.classList.remove('expanded');
            floatingTotal.classList.add('collapsed');
          }

          // Add kilometers-mode class for extra styling if needed
          if (hasKilometers) {
            floatingTotal.classList.add('kilometers-mode');
          } else {
            floatingTotal.classList.remove('kilometers-mode');
          }

          // Update displayed totals with animation
          this.updateDisplayedTotals(monetaryTotal, kilometersTotal);

          // Set up event handlers for expand/collapse
          this.setupTotalClickHandlers(floatingTotal);
        },

        // Helper function to update all displayed totals
        updateDisplayedTotals(monetaryTotal, kilometersTotal) {
          // Update all monetary totals
          document.querySelectorAll('[id="totalAmount"]').forEach(el => {
            this.animateNumber(
              parseFloat(el.textContent || '0'),
              monetaryTotal,
              {
                duration: 500,
                onUpdate: (value) => {
                  el.textContent = value.toFixed(2);
                }
              }
            );
          });

          // Update all kilometer totals
          document.querySelectorAll('[id="totalKilometers"]').forEach(el => {
            this.animateNumber(
              parseFloat(el.textContent || '0'),
              kilometersTotal,
              {
                duration: 500,
                onUpdate: (value) => {
                  el.textContent = value.toFixed(2);
                }
              }
            );
          });

          // Update category amounts individually if in expanded state
          if (document.querySelector('.floating-total.expanded')) {
            // Update each category amount
            ['fuel', 'route', 'parking', 'other'].forEach(category => {
              const amount = ExpenseApp.state.categoryTotals[category];
              if (amount > 0) {
                let selector;
                switch (category) {
                  case 'fuel': selector = '.fa-gas-pump'; break;
                  case 'route': selector = '.fa-route'; break;
                  case 'parking': selector = '.fa-parking'; break;
                  case 'other': selector = '.fa-receipt'; break;
                }

                const categoryItems = document.querySelectorAll(selector);
                categoryItems.forEach(icon => {
                  const categoryItem = icon.closest('.category-total-item');
                  if (categoryItem) {
                    const amountElement = categoryItem.querySelector('.category-amount');
                    if (amountElement) {
                      const currentValue = parseFloat(amountElement.textContent);
                      this.animateNumber(currentValue, amount, {
                        duration: 500,
                        onUpdate: (value) => {
                          amountElement.textContent = value.toFixed(2) + ' ₪';
                        }
                      });
                    }
                  }
                });
              }
            });

            // Update kilometers separately if they exist
            if (kilometersTotal > 0) {
              const kilometersItems = document.querySelectorAll('.fa-road');
              kilometersItems.forEach(icon => {
                const categoryItem = icon.closest('.category-total-item');
                if (categoryItem) {
                  const amountElement = categoryItem.querySelector('.category-amount');
                  if (amountElement) {
                    const currentValue = parseFloat(amountElement.textContent);
                    this.animateNumber(currentValue, kilometersTotal, {
                      duration: 500,
                      onUpdate: (value) => {
                        amountElement.textContent = value.toFixed(2) + ' ק"מ';
                      }
                    });
                  }
                }
              });
            }
          }
        },

        // Setup click handlers for expand/collapse
        // Setup click handlers for expand/collapse
        setupTotalClickHandlers(floatingTotal) {
          // Remove any existing handlers to prevent duplication
          const newElement = floatingTotal.cloneNode(true);
          if (floatingTotal.parentNode) {
            floatingTotal.parentNode.replaceChild(newElement, floatingTotal);
          }

          // Add click handler for expand/collapse buttons
          newElement.addEventListener('click', (e) => {
            // Find the closest button element - check for both the button itself and its icon
            const expandButton = e.target.closest('.btn-expand-total');
            const collapseButton = e.target.closest('.btn-collapse-total');

            // If the click wasn't on either button, exit
            if (!expandButton && !collapseButton) return;

            // Calculate current totals
            const monetaryTotal = ExpenseApp.state.categoryTotals.fuel +
              ExpenseApp.state.categoryTotals.route +
              ExpenseApp.state.categoryTotals.parking +
              ExpenseApp.state.categoryTotals.other;
            const kilometersTotal = ExpenseApp.state.categoryTotals.kilometers;

            // Toggle state and redraw
            if (expandButton) {
              newElement.dataset.state = 'expanded';
              this.updateFloatingTotalWithCategories(monetaryTotal, kilometersTotal);
            } else if (collapseButton) {
              newElement.dataset.state = 'collapsed';
              this.updateFloatingTotalWithCategories(monetaryTotal, kilometersTotal);
            }
          });

          // Return the new element reference
          return newElement;
        },

        // Add CSS styles for floating total
        addFloatingTotalStyles() {
          if (document.getElementById('total-expand-css')) return;

          const totalExpandCss = document.createElement('style');
          totalExpandCss.id = 'total-expand-css';
          totalExpandCss.textContent = `
      .floating-total {
        transition: all 0.3s ease;
        overflow: hidden;
      }
      
      .floating-total.expanded {
        max-height: 280px;
      }
      
      .floating-total.kilometers-mode {
        max-height: 320px; /* Slightly taller to accommodate both totals */
      }
      
      .btn-expand-total, .btn-collapse-total {
        background: none;
        border: none;
        color: var(--bs-primary);
        cursor: pointer;
        padding: 0 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
      }
      
      .btn-expand-total:hover, .btn-collapse-total:hover {
        transform: translateY(-2px);
      }
      
      .category-totals {
        background: rgba(var(--bs-primary-rgb), 0.05);
        border-radius: 8px;
        padding: 10px;
      }
      
      .category-total-item {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
        font-size: 0.9rem;
      }
      
      .category-total-item:last-child {
        margin-bottom: 0;
      }
      
      .category-total-item i {
        margin-inline-end: 10px;
        width: 20px;
        text-align: center;
      }
      
      .category-total-item .category-amount {
        margin-inline-start: auto;
        font-weight: 500;
      }
      
      .grand-total {
        border-top: 1px solid rgba(var(--bs-primary-rgb), 0.2);
        margin-top: 6px;
        padding-top: 6px;
        font-weight: bold;
      }
      
      .grand-total-kilometers {
        margin-top: 3px;
        font-weight: bold;
        color: var(--bs-primary);
      }
    `;

          document.head.appendChild(totalExpandCss);
        }
      };


      // ============= VALIDATION MANAGER MODULE =============
      const ValidationManager = {
        init() {
          // Nothing to initialize
        },

        // Handle validation error
        handleValidationError(element, errorMessage, errorClass = 'invalid-feedback') {
          element.classList.add('is-invalid');

          // Look for existing error div within the parent
          let errorDiv = element.parentNode.querySelector('.' + errorClass);

          // Create error div if it doesn't exist
          if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = errorClass;
            // For drop zones and signatures, make sure error is visible
            if (element.classList.contains('file-drop-zone') ||
              element.classList.contains('signature-pad')) {
              errorDiv.className += ' d-block';
            }
            element.parentNode.appendChild(errorDiv);
          }

          errorDiv.textContent = errorMessage;
          return false;
        },

        // Clear validation error
        clearValidationError(element) {
          element.classList.remove('is-invalid');
          const errorDiv = element.parentNode.querySelector('.invalid-feedback');
          if (errorDiv) {
            errorDiv.remove();
          }
        },

        // Setup listeners to clear validation errors on input
        setupValidationClearingListeners() {
          // Clear validation styling on input
          const form = document.getElementById('expenseForm');
          if (!form) return;

          form.addEventListener('input', function (e) {
            if (e.target.classList.contains('is-invalid')) {
              ValidationManager.clearValidationError(e.target);
            }
          });

          // Clear signature validation on signing
          Object.values(SignatureManager.signaturePads).forEach(pad => {
            const canvas = pad.canvas;
            if (!canvas._hasValidationListener) { // Check if listener already exists
              canvas._hasValidationListener = true;
              canvas.addEventListener('mousedown', function () {
                this.classList.remove('invalid-signature');
                ValidationManager.clearValidationError(this);
              });
            }
          });
        }
      };
      ValidationManager.validateAbraEmail = function (email) {
        // Check if email contains "@abra" in any form
        return email.toLowerCase().includes('@abra');
      };

      // Extend the validateForm function in the FormHandler module to include this validation
      const originalValidateForm = FormHandler.validateForm;
      FormHandler.validateForm = function () {
        // Run the original validation first
        const isValid = originalValidateForm.call(this);

        // If the basic validation failed, no need to continue
        if (!isValid) return false;

        // Now check for Abra domain validation
        const employeeEmail = document.querySelector('input[name="employeeEmail"]').value;
        const managerEmail = document.querySelector('input[name="managerEmail"]').value;

        // Check employee email
        if (employeeEmail && !ValidationManager.validateAbraEmail(employeeEmail)) {
          Swal.fire({
            title: 'שגיאת אימות',
            text: 'כתובת האימייל של העובד חייבת להיות עם דומיין Abra',
            icon: 'error',
            confirmButtonText: 'אישור',
            showCloseButton: true,
            rtl: true
          });

          ValidationManager.handleValidationError(
            document.querySelector('input[name="employeeEmail"]'),
            'כתובת האימייל חייבת להכיל @abra'
          );
          return false;
        }

        // Check manager email
        if (managerEmail && !ValidationManager.validateAbraEmail(managerEmail)) {
          Swal.fire({
            title: 'שגיאת אימות',
            text: 'כתובת האימייל של המנהל חייבת להיות עם דומיין Abra',
            icon: 'error',
            confirmButtonText: 'אישור',
            showCloseButton: true,
            rtl: true
          });

          ValidationManager.handleValidationError(
            document.querySelector('input[name="managerEmail"]'),
            'כתובת האימייל חייבת להכיל @abra'
          );
          return false;
        }

        // All validations passed
        return true;
      };
      // ============= PDF RENDERER MODULE =============
      const PdfRenderer = {
        init() {
          // Add required PDF styles
          this.addPdfStyles();
        },

        // Add PDF viewer styles
        addPdfStyles() {
          if (document.getElementById('pdf-viewer-styles')) return;

          const pdfStyles = document.createElement('style');
          pdfStyles.id = 'pdf-viewer-styles';
          pdfStyles.textContent = `
        .pdf-viewer {
          display: flex;
          flex-direction: column;
          align-items: center;
          max-width: 100%;
          overflow-x: auto;
        }
        
        .pdf-controls {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          margin-bottom: 10px;
          padding: 0 10px;
        }
        
        .pdf-canvas {
          max-width: 100%;
          box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .pdf-loading {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 200px;
          text-align: center;
        }
        
        .pdf-loading .spinner {
          position: relative;
          display: flex;
          align-items: center;
          justify-content: center;
        }
        
        .pdf-loading .spinner-border {
          position: absolute;
          width: 50px;
          height: 50px;
        }
        
        .pdf-loading .fa-file-pdf {
          font-size: 48px;
          color: #dc3545;
          z-index: 1;
        }
      `;

          document.head.appendChild(pdfStyles);
        },

        // Render PDF to container
        renderPDF(pdfSource, container) {
          // Clear any existing content
          container.innerHTML = '';

          // Create loading indicator
          const loadingIndicator = document.createElement('div');
          loadingIndicator.className = 'pdf-loading';
          loadingIndicator.innerHTML = `
        <div class="spinner">
          <i class="fas fa-file-pdf"></i>
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">טוען PDF...</span>
          </div>
        </div>
        <p>טוען מסמך PDF...</p>
      `;
          container.appendChild(loadingIndicator);

          // Determine the source type
          let pdfData;
          try {
            // Check if it's a base64 string or blob/object URL
            if (typeof pdfSource === 'string') {
              if (pdfSource.startsWith('data:application/pdf;base64,')) {
                // Full data URL
                pdfData = pdfSource;
              } else if (pdfSource.startsWith('blob:')) {
                // Blob URL
                return this.fetchBlobPDF(pdfSource, container);
              } else {
                // Assume base64 without prefix
                pdfData = `data:application/pdf;base64,${pdfSource}`;
              }
            } else {
              throw new Error('Invalid PDF source');
            }

            // Create PDF viewer
            const pdfViewerContainer = document.createElement('div');
            pdfViewerContainer.className = 'pdf-viewer';

            // Navigation controls
            const controls = document.createElement('div');
            controls.className = 'pdf-controls';
            controls.innerHTML = `
          <button class="btn btn-outline-secondary pdf-zoom-out">
            <i class="fas fa-search-minus"></i>
          </button>
          <span class="pdf-page-info">עמוד <span class="current-page">1</span> מתוך <span class="total-pages">-</span></span>
          <button class="btn btn-outline-secondary pdf-zoom-in">
            <i class="fas fa-search-plus"></i>
          </button>
        `;

            // Canvas for PDF rendering
            const canvas = document.createElement('canvas');
            canvas.className = 'pdf-canvas';

            // State variables for PDF
            const pdfState = {
              pdfDoc: null,
              pageNum: 1,
              pageRendering: false,
              pageNumPending: null,
              scale: 1.5
            };

            // Load PDF
            pdfjsLib.getDocument(pdfData).promise
              .then((pdf) => {
                pdfState.pdfDoc = pdf;
                loadingIndicator.remove();

                // Add controls and canvas
                pdfViewerContainer.appendChild(controls);
                pdfViewerContainer.appendChild(canvas);
                container.appendChild(pdfViewerContainer);

                // Render first page
                this.renderPdfPage(canvas, pdfState, 1);

                // Set up zoom controls
                this.setupPdfControls(controls, canvas, pdfState);
              })
              .catch((error) => {
                console.error('PDF Load Error:', error);
                loadingIndicator.innerHTML = `
              <div class="text-danger">
                <i class="fas fa-exclamation-triangle"></i>
                שגיאה בטעינת PDF
              </div>
            `;
              });

          } catch (error) {
            console.error('PDF Render Error:', error);
            container.innerHTML = `
          <div class="text-danger">
            <i class="fas fa-exclamation-triangle"></i>
            שגיאה בהצגת PDF: ${error.message}
          </div>
        `;
          }
        },

        // Render a specific PDF page
        renderPdfPage(canvas, pdfState, num) {
          pdfState.pageRendering = true;

          pdfState.pdfDoc.getPage(num).then((page) => {
            const viewport = page.getViewport({ scale: pdfState.scale });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
              canvasContext: canvas.getContext('2d'),
              viewport: viewport
            };

            const renderTask = page.render(renderContext);
            renderTask.promise.then(() => {
              pdfState.pageRendering = false;
              if (pdfState.pageNumPending !== null) {
                this.renderPdfPage(canvas, pdfState, pdfState.pageNumPending);
                pdfState.pageNumPending = null;
              }

              // Update page info
              const pdfViewer = canvas.closest('.pdf-viewer');
              if (pdfViewer) {
                const currentPage = pdfViewer.querySelector('.current-page');
                const totalPages = pdfViewer.querySelector('.total-pages');

                if (currentPage) currentPage.textContent = num;
                if (totalPages) totalPages.textContent = pdfState.pdfDoc.numPages;
              }
            });
          });
        },

        // Queue page rendering (if already rendering)
        queueRenderPage(canvas, pdfState, num) {
          if (pdfState.pageRendering) {
            pdfState.pageNumPending = num;
          } else {
            this.renderPdfPage(canvas, pdfState, num);
          }
        },

        // Set up PDF controls (zoom, navigation)
        setupPdfControls(controls, canvas, pdfState) {
          controls.querySelector('.pdf-zoom-in').addEventListener('click', () => {
            pdfState.scale += 0.25;
            this.queueRenderPage(canvas, pdfState, pdfState.pageNum);
          });

          controls.querySelector('.pdf-zoom-out').addEventListener('click', () => {
            pdfState.scale = Math.max(0.5, pdfState.scale - 0.25);
            this.queueRenderPage(canvas, pdfState, pdfState.pageNum);
          });
        },

        // Helper function to fetch blob PDFs
        fetchBlobPDF(blobUrl, container) {
          fetch(blobUrl)
            .then(response => response.blob())
            .then(blob => {
              const reader = new FileReader();
              reader.onloadend = () => {
                this.renderPDF(reader.result, container);
              };
              reader.readAsDataURL(blob);
            })
            .catch(error => {
              console.error('Blob PDF Fetch Error:', error);
              container.innerHTML = `
            <div class="text-danger">
              <i class="fas fa-exclamation-triangle"></i>
              שגיאה בטעינת PDF: ${error.message}
            </div>
          `;
            });
        }
      };

      // ============= API SERVICE MODULE =============
      const ApiService = {
        // API endpoints
        endpoints: {
          base: API_ENDPOINT,
          params: API_PARAMS
        },

        // Get expense report by ID
        getExpenseReport(id) {
          return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              id: id,
              action: "get-report"
            })
          });
        },

        // Submit new expense report
        submitExpenseReport(data) {
          return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              ...data,
              action: "new-submit",
              status: 'submitted'
            })
          });
        },

        // Manager approve expense report
        approveExpenseReport(id, signature) {
          return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              id: id,
              action: "manager-approve",
              status: 'manager_approved',
              managerSignature: signature,
              approvedAt: new Date().toISOString()
            })
          });
        },

        // Manager reject expense report
        rejectExpenseReport(id, reason) {
          return fetch(`${this.endpoints.base}?${this.endpoints.params}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              id: id,
              action: "manager-reject",
              status: 'rejected',
              rejectionReason: reason,
              rejectedAt: new Date().toISOString()
            })
          });
        },

        // Process receipt image with Gemini API
        async processReceiptImage(imageBase64) {
          const systemPrompt = `אתה מומחה בניתוח קבלות. אנא חלץ את המידע הבא מהקבלה ותחזיר אותו בפורמט JSON:
        - תאריך (date)
        - סכום לתשלום (total_payment)
        - מספר קבלה/חשבונית (reception_number)
        
        החזר את התוצאה בפורמט הבא בדיוק:
        { "date": "DD/MM/YY", "total_payment": "X,XXX.XX", "reception_number": "XXXXX" }`;

          // Array of model configurations to try in order
          const models = [
            {
              name: 'Gemini 1.5',
              endpoint: 'gemini-1.5-flash',
              handler: async () => {
                const requestBody = {
                  contents: [{
                    parts: [
                      { text: systemPrompt },
                      {
                        inlineData: {
                          mimeType: "image/jpeg",
                          data: imageBase64
                        }
                      }
                    ]
                  }],
                  generationConfig: {
                    temperature: 0.1,
                    topK: 1,
                    topP: 0.1
                  }
                };

                const response = await fetch(
                  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                  {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                  }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
              }
            },
            {
              name: 'Gemini 1.5 Flash 8B',
              endpoint: 'gemini-1.5-flash-8b',
              handler: async () => {
                const requestBody = {
                  contents: [{
                    role: "user",
                    parts: [
                      {
                        inlineData: {
                          mimeType: "image/jpeg",
                          data: imageBase64
                        }
                      },
                      { text: systemPrompt }
                    ]
                  }],
                  generationConfig: {
                    temperature: 1,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                    responseMimeType: "text/plain"
                  }
                };

                const response = await fetch(
                  `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-8b:generateContent?key=${GEMINI_API_KEY}`,
                  {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                  }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
              }
            },
            {
              name: 'Gemini 2.0',
              endpoint: 'gemini-2.0-flash',
              handler: async () => {
                const requestBody = {
                  contents: [{
                    role: "user",
                    parts: [
                      {
                        inlineData: {
                          mimeType: "image/jpeg",
                          data: imageBase64
                        }
                      },
                      { text: systemPrompt }
                    ]
                  }],
                  generationConfig: {
                    temperature: 1,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 8192,
                    responseMimeType: "text/plain"
                  }
                };

                const response = await fetch(
                  `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                  {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                  }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
              }
            }
          ];

          // Try each model in sequence with better error handling
          let lastError = null;
          for (const model of models) {
            try {
              console.log(`Trying ${model.name}...`);
              const data = await model.handler();

              // Parse the response
              if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                throw new Error('Invalid response format: missing text in response');
              }

              const text = data.candidates[0].content.parts[0].text;

              // Try to extract JSON from the response using more flexible regex
              const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/) ||
                text.match(/```\n([\s\S]*?)\n```/) ||
                text.match(/{[\s\S]*}/);

              if (!jsonMatch) {
                throw new Error('Invalid response format: could not extract JSON');
              }

              // Get JSON content and parse it
              const jsonString = jsonMatch[1] ? jsonMatch[1].trim() : text.match(/{[\s\S]*}/)[0];
              const result = JSON.parse(jsonString);

              // Validate the parsed receipt data
              this.validateReceiptData(result);

              console.log(`Success with ${model.name}`);
              return result;
            } catch (error) {
              console.error(`${model.name} failed:`, error);
              lastError = error;
              continue; // Try next model
            }
          }

          // If we get here, all models failed
          console.error('All models failed to process the receipt');
          throw new Error('לא ניתן היה לזהות את נתוני הקבלה - ' + lastError.message);
        },

        // Validate receipt data
        validateReceiptData(data) {
          // Check that all required fields are present
          const requiredFields = ['date', 'total_payment', 'reception_number'];
          for (const field of requiredFields) {
            if (!data.hasOwnProperty(field)) {
              throw new Error(`Missing required field: ${field}`);
            }
          }

          // Validate date format (allow multiple formats)
          const dateFormats = [
            /^\d{2}\/\d{2}\/\d{2}$/, // DD/MM/YY
            /^\d{2}\.\d{2}\.\d{2}$/, // DD.MM.YY
            /^\d{2}-\d{2}-\d{2}$/    // DD-MM-YY
          ];

          let validDateFormat = false;
          for (const dateRegex of dateFormats) {
            if (dateRegex.test(data.date)) {
              validDateFormat = true;
              break;
            }
          }

          if (!validDateFormat) {
            // Try to normalize the date format
            const normalizedDate = this.normalizeDate(data.date);
            if (normalizedDate) {
              data.date = normalizedDate;
            } else {
              throw new Error('Invalid date format. Expected DD/MM/YY');
            }
          }

          // Normalize date to DD/MM/YY if needed
          if (data.date.includes('.') || data.date.includes('-')) {
            data.date = data.date.replace(/[.-]/g, '/');
          }

          // Validate total_payment format (allow more flexibility)
          const paymentFormats = [
            /^\d{1,3}(?:,\d{3})*\.\d{2}$/, // X,XXX.XX
            /^\d+\.\d{2}$/,                 // XXXX.XX
            /^\d+$/                         // XXXX (whole number)
          ];

          let validPaymentFormat = false;
          for (const paymentRegex of paymentFormats) {
            if (paymentRegex.test(data.total_payment)) {
              validPaymentFormat = true;
              break;
            }
          }

          if (!validPaymentFormat) {
            // Try to normalize by removing non-numeric chars except . and ,
            const normalizedPayment = data.total_payment.replace(/[^\d.,]/g, '');
            if (/^[\d.,]+$/.test(normalizedPayment)) {
              data.total_payment = normalizedPayment;
            } else {
              throw new Error('Invalid total_payment format');
            }
          }

          // If payment is a whole number, add decimal places
          if (/^\d+$/.test(data.total_payment)) {
            data.total_payment = data.total_payment + '.00';
          }

          // Format with thousands separator if needed
          if (!data.total_payment.includes(',')) {
            const parts = data.total_payment.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            data.total_payment = parts.join('.');
          }

          // Validate reception_number (more flexible)
          if (!data.reception_number || data.reception_number.length < 3) {
            // Generate a placeholder if missing or too short
            data.reception_number = 'INV' + Math.floor(Math.random() * 90000 + 10000);
          }
        },

        // Helper to normalize date from various formats
        normalizeDate(dateString) {
          // Try to extract day, month, year with various separators
          const dateMatch = dateString.match(/(\d{1,2})[./-](\d{1,2})[./-](\d{2,4})/);
          if (dateMatch) {
            let [_, day, month, year] = dateMatch;

            // Handle 2-digit day/month
            day = day.padStart(2, '0');
            month = month.padStart(2, '0');

            // Handle 4-digit year
            if (year.length === 4) {
              year = year.substring(2);
            }

            return `${day}/${month}/${year}`;
          }

          return null;
        }
      };

      // ============= INITIALIZE APP =============
      // Execute when DOM is fully loaded
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize the app
        ExpenseApp.init();

        // Expose necessary methods to global scope for HTML event handlers
        window.ExpenseBuilder = ExpenseBuilder;
        window.FormHandler = FormHandler;
        window.FileHandler = FileHandler;
        window.SignatureManager = SignatureManager;
        window.UIManager = UIManager;
        window.closePreview = UIManager.closePreview.bind(UIManager);
        window.clearSignature = SignatureManager.clearSignature.bind(SignatureManager);
        const emailFields = document.querySelectorAll('input[type="email"]');

        emailFields.forEach(field => {
          field.addEventListener('blur', function () {
            if (this.value && !ValidationManager.validateAbraEmail(this.value)) {
              ValidationManager.handleValidationError(
                this,
                'כתובת האימייל חייבת להכיל @abra'
              );
            }
          });
        });
        checkAndShowAlert();
      });

    })();
  </script>
  <script>
    // Add these functions to your JavaScript file, either at the end of your main script or in a separate <script> tag

    function generateMiniCalendar() {
      const DateTime = luxon.DateTime;

      const today = DateTime.now();

      const currentDay = today.day;
      const { daysInMonth } = today;
      const firstDay = today.startOf('month');
      // תיקון החישוב - אנחנו רוצים שיום א' יהיה בעמודה הראשונה
      // ב-Luxon יום א' הוא 7 ויום ב' הוא 1, לכן נעשה התאמה
      let firstDayOfMonth = firstDay.weekday;
      if (firstDayOfMonth === 7) { // אם זה יום ראשון
        firstDayOfMonth = 1;
      } else {
        firstDayOfMonth += 1; // להזיז את כל שאר הימים
      }

      const monthName = today.toFormat('MMMM yyyy');

      let html = `<div class="calendar-container">
                <div class="month-header">
                  <i data-lucide="calendar-days" class="w-6 h-6 ml-2 text-indigo-600 icon-indicator"></i>
                  ${monthName}
                </div>
                <div class="grid grid-cols-7 gap-1 text-center">`;

      // ימי השבוע - סדר ישראלי: א' בעמודה הראשונה
      ['א', 'ב', 'ג', 'ד', 'ה', 'ו', 'ש'].forEach(day => {
        html += `<div class="weekday-header">${day}</div>`;
      });

      // רווחים בתחילת השורה
      for (let i = 1; i < firstDayOfMonth; i++) {
        html += "<div></div>";
      }

      // ימי החודש
      for (let day = 1; day <= daysInMonth; day++) {
        let classes = "day-cell ";
        let tooltipText = "";

        if (day <= 25) {
          classes += "bg-green-600 hover:bg-green-700 text-white";
          tooltipText = "החזר הוצאות יכנס למשכורת עבור החודש הנוכחי";
        } else {
          classes += "bg-orange-500 hover:bg-orange-600 text-white";
          tooltipText = "החזר הוצאות ייכנס למשכורת החודש הבא";
        }

        // הוספת סימון מיוחד ליום הנוכחי וליום 25
        const isCurrent = day === currentDay;
        const isDeadline = day === 25;

        if (isDeadline) {
          classes += " ring-2 ring-red-500 ring-offset-2";
          tooltipText = "תאריך אחרון להגשת דו״ח להחזר בחודש הנוכחי!";
        } else if (isCurrent && !isDeadline) {
          classes += " today ring-2 ring-blue-500 ring-offset-1";
          if (day <= 25) {
            tooltipText = "היום! החזר הוצאות יכנס למשכורת עבור החודש הנוכחי";
          } else {
            tooltipText = "היום! החזר הוצאות יכנס למשכורת בחודש הבא";
          }
        }

        let dayContent = day;
        if (isDeadline) {
          dayContent = `<span class="relative">${day}
                     <i data-lucide="bookmark" class="w-3 h-3 absolute -top-1 -right-1 text-white icon-indicator"></i>
                   </span>`;
        }

        html += `<div class="${classes}" data-tippy-content="${tooltipText}">${dayContent}</div>`;
      }

      html += `</div>`;

      // מקרא משופר
      html += `<div class="mt-5 text-sm text-slate-700 bg-gray-50 p-3 rounded-lg shadow-sm border border-gray-100">
            <div class="legend-item">
                <svg class="w-4 h-4 text-green-600 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="10" />
                </svg>
                <span class="font-medium text-green-600">עד ה-25:</span> 
                <span class="text-gray-700">החזר הוצאות במשכורת החודש</span>
            </div>
            <div class="legend-item">
                <svg class="w-4 h-4 text-orange-500 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="10" />
                </svg>
                <span class="font-medium text-orange-500">אחרי ה-25:</span> 
                <span class="text-gray-700">החזר הוצאות במשכורת הבאה</span>
            </div>
            <div class="legend-item">
                <svg class="w-4 h-4 text-red-500 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                    <circle cx="12" cy="12" r="10" />
                </svg>
                <span class="font-medium text-red-600">25 לחודש:</span> 
                <span class="text-gray-700">תאריך אחרון להגשת החזר הוצאות במשכורת החודש</span>
            </div>

           </div>`;

      html += `</div>`;
      return html;
    }

    function showAlert() {
      const today = luxon.DateTime.now();
      // תוצג התראה אם היום הוא בין 20 ליום האחרון של החודש (כולל)
      if (today.day >= 20) {
        const extraMsg = `<div class="mb-5 mx-auto max-w-md">
                        <div class="flex items-center gap-2 text-red-600 font-bold mb-3 justify-center">
                          <i data-lucide="bell-ring" class="w-6 h-6 icon-indicator"></i>
                          דו"ח שמוגש לאחר ה-25 החזר ההוצאות ייכנס למשכורת בחודש שלאחריו
                        </div>
                      </div>`;

        // הוספת פס התקדמות לסגירה אוטומטית
        const progressBar = `<div class="auto-close-progress">
                          <div class="auto-close-progress-bar"></div>
                        </div>`;

        // הגדרת התראה עם טיימר 10 שניות
        const alertInstance = Swal.fire({
          title: '<div class="alert-title">תזכורת חשובה</div>',
          icon: "",
          html: extraMsg + generateMiniCalendar() + progressBar,
          showCloseButton: true,
          showCancelButton: false,
          focusConfirm: false,
          width: 'auto',
          confirmButtonText: '<div class="flex items-center gap-2"><i data-lucide="check-circle" class="w-5 h-5"></i>הבנתי</div>',
          confirmButtonColor: '#4f46e5',
          cancelButtonText: '<div class="flex items-center gap-2"><i data-lucide="x" class="w-5 h-5"></i>סגור</div>',
          cancelButtonColor: '#64748b',
          customClass: {
            container: 'swal-rtl',
            popup: 'rounded-xl'
          },
          didOpen: () => {
            lucide.createIcons();
            // הפעלת טיפים על כל תאי הימים
            tippy('[data-tippy-content]', {
              placement: 'top',
              arrow: true,
              delay: [100, 0],
              duration: [200, 200],
              theme: 'custom'
            });

            // סגירה אוטומטית לאחר 15 שניות
            setTimeout(() => {
              Swal.close();
            }, 25000);
          }
        });
      }
    }

    function checkAndShowAlert() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");

      // If 'id' parameter exists and is not empty, do not show the alert
      if (id) return;

      const today = luxon.DateTime.now();
      // If today is between the 20th and the last day of the month
      if (today.day >= 20 && today.day <= today.daysInMonth) {
        showAlert();
      }
    }


    // Initialize Lucide icons after the page loads
    document.addEventListener('DOMContentLoaded', function () {
      lucide.createIcons();
    });
  </script>
  <div id="filePreviewOverlay" class="file-preview-overlay">
    <div class="preview-content">
      <button type="button" class="close-preview" onclick="closePreview()">
        <i class="fas fa-times"></i>
      </button>
      <div class="preview-container">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>
</body>

</html>