<!DOCTYPE html>
<html lang="he" dir="rtl" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוח החזר הוצאות | Abra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="style.css?ver=1.0" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="pdf.js"></script>
    <style>

    </style>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "q8n5bdb421");
    </script>
</head>

<body class="body-he">
    <header class="header header-animate">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title heading-he text-h1">דוח החזר הוצאות</h1>
                <div class="d-flex align-items-center gap-3">
                    <!-- Theme Toggle Button -->
                    <button class="theme-toggle" aria-label="Toggle dark mode" title="שינוי מצב תצוגה">
                        <i class="fas fa-sun light-icon"></i>
                        <i class="fas fa-moon dark-icon"></i>
                    </button>
                    <!-- Company Logo -->
                    <div class="logo-container">
                        <img src="abra logo FullColor white PNG.png" alt="Company Logo" class="company-logo"
                            loading="eager">
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div class="container mt-3">
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0"
                aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
    <div class="container">
        <form id="expenseForm">
            <!-- Basic Info Section -->
            <div class="info-section mb-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">חודש</label>
                        <input type="month" class="form-control" name="month" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">אימייל עובד/ת</label>
                        <input type="email" class="form-control" name="employeeName" placeholder="הזן את כתובת האימייל שלך" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">חטיבה/מחלקה</label>
                        <input type="text" class="form-control" name="department">
                    </div>
                </div>
            </div>

            <!-- Quick Add Bar -->
            <div class="quick-add-bar">
                <div class="d-flex gap-3 flex-wrap">
                    <button type="button" class="quick-add-button" onclick="quickAdd('fuel')" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="הוסף הוצאת דלק - צרף תמונת קבלה לזיהוי אוטומטי של הפרטים">
                        <i class="fas fa-gas-pump"></i>
                        דלק
                    </button>
                    <button type="button" class="quick-add-button" onclick="quickAdd('parking')"
                        data-bs-toggle="tooltip" data-bs-placement="top"
                        title="הוסף הוצאת חניה - צרף קבלה או אישור תשלום">
                        <i class="fas fa-parking"></i>
                        חניה
                    </button>
                    <button type="button" class="quick-add-button" onclick="quickAdd('other')" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="הוסף הוצאה אחרת - למשל: נסיעות, ציוד, או הוצאות משרדיות">
                        <i class="fas fa-receipt"></i>
                        הוצאה אחרת
                    </button>
                </div>
            </div>

            <!-- Expenses Container -->
            <div id="expensesContainer"></div>

            <!-- Signatures Section -->
            <div class="signature-section">
                <h5 class="mb-4">חתימות</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-user"></i>
                                חתימת העובד
                            </div>
                            <canvas id="employeeSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button"
                                    onclick="clearSignature('employeeSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-user-tie"></i>
                                חתימת מנהל ישיר
                            </div>
                            <canvas id="managerSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button"
                                    onclick="clearSignature('managerSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-check-double"></i>
                                חתימת אברא
                            </div>
                            <canvas id="provadorSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button"
                                    onclick="clearSignature('provadorSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Floating Total with Submit -->
    <div class="floating-total">
        <div>
            סה"כ: <span id="totalAmount">0.00</span> ₪
        </div>
        <button type="submit" form="expenseForm" class="submit-button">
            <i class="fas fa-paper-plane"></i>
            שלח דוח
        </button>
    </div>

    <script>
        function initializeForm() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    if (id) {
        // Manager review mode
        initializeManagerReview();
    } else {
        // New submission mode
        initializeNewSubmission();
    }
}
function createTimingProgressIndicator() {
    const startTime = performance.now();
    const progress = showLoadingOverlay('טוען נתוני דוח...');

    function formatDuration(ms) {
        if (ms < 1000) return `${Math.round(ms)}ms`;
        const seconds = ms / 1000;
        if (seconds < 60) return `${seconds.toFixed(1)}s`;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = (seconds % 60).toFixed(0);
        return `${minutes}:${remainingSeconds.padStart(2, '0')}`;
    }

    return {
        updateFetchProgress: async (fetchPromise) => {
            try {
                // Start connection phase
                progress.updateStage('queued', 100);
                progress.updateStage('connecting', 0);
                
                const response = await fetchPromise;
                const clonedResponse = response.clone(); // Clone immediately after getting response
                
                // Connection complete, start processing
                progress.updateStage('connecting', 100);
                progress.updateStage('processing', 50);

                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length') || 0;
                let receivedLength = 0;

                // Start download phase
                progress.updateStage('processing', 100);
                progress.updateStage('downloading', 0);

                // Read the stream
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    receivedLength += value.length;
                    const downloadProgress = contentLength ? 
                        Math.round((receivedLength / contentLength) * 100) : 
                        50;

                    progress.updateStage('downloading', downloadProgress);
                    
                    // Update elapsed time
                    const elapsed = formatDuration(performance.now() - startTime);
                    progress.setMessage(`טוען נתוני דוח... (${elapsed})`);
                }

                // Complete download phase
                progress.updateStage('downloading', 100);

                // Return the cloned response that hasn't been read
                return clonedResponse;

            } catch (error) {
                throw error;
            }
        },
        close: () => progress.close()
    };
}

async function initializeManagerReview() {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    if (id) {
        const progressTracker = createTimingProgressIndicator();
        
        try {
            const fetchPromise = fetch('https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    id: id,
                    action: "get-report"  
                })
            });

            // Track the fetch progress and get the cloned response
            const clonedResponse = await progressTracker.updateFetchProgress(fetchPromise);
            
            // Use the cloned response to get JSON
            const data = await clonedResponse.json();
            
            populateExpenseReport(data);
            setupManagerReviewMode(data);
            
            progressTracker.close();
            
        } catch (error) {
            console.error('Error fetching expense report:', error);
            progressTracker.close();
            showNotification('שגיאה בטעינת הדוח: ' + error.message, 'danger');
        }
    }
}
function initializeNewSubmission() {
    // Set current month as default
    const today = new Date();
    const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
    document.querySelector('input[name="month"]').value = month;

    // Update employee name field label and placeholder
    const employeeNameInput = document.querySelector('input[name="employeeName"]');
    employeeNameInput.previousElementSibling.textContent = 'אימייל עובד/ת';
    employeeNameInput.placeholder = 'הזן את כתובת האימייל שלך';
    employeeNameInput.type = 'email';

    // Hide department field for new submission
    const departmentField = document.querySelector('.col-md-4:last-child');
    departmentField.style.display = 'none';
}
function populateExpenseReport(data) {
    // Update the employee name label and input type
    const employeeNameLabel = document.querySelector('input[name="employeeName"]').previousElementSibling;
    employeeNameLabel.textContent = 'שם עובד/ת';
    const employeeNameInput = document.querySelector('input[name="employeeName"]');
    employeeNameInput.type = 'text';
    employeeNameInput.placeholder = '';

    // Populate basic info
    document.querySelector('input[name="month"]').value = data.expense_main[0].Month;
    employeeNameInput.value = data.expense_main[0].EmployeeName.DisplayName;
    document.querySelector('input[name="department"]').value = data.expense_main[0].EmployeeName.Department;

    // Populate expenses
    const container = document.getElementById('expensesContainer');
    container.innerHTML = ''; // Clear existing expenses
    
    let totalAmount = 0; // Initialize total

    // Add expense items
    data.expense_items.forEach(item => {
        let expenseType = 'other';
        if (item.ExpenseType.toLowerCase().includes('דלק')) {
            expenseType = 'fuel';
        } else if (item.ExpenseType.toLowerCase().includes('חניה')) {
            expenseType = 'parking';
        }

        quickAdd(expenseType);
        const card = container.firstElementChild;
        card.dataset.expenseId = item.ID;
        
        // Convert and set date
        let expenseDate = '';
        if (item.ExpenseDate) {
            const date = new Date(item.ExpenseDate);
            expenseDate = date.toLocaleDateString('en-CA');
        }
        
        // Populate fields
        const dateInput = card.querySelector('input[type="date"]');
        const invoiceInput = card.querySelector('input[placeholder="הזן מספר חשבונית"]');
        const amountInput = card.querySelector('.expense-amount');
        
        if (dateInput) {
            dateInput.value = expenseDate;
            dateInput.readOnly = true;
        }
        if (invoiceInput) {
            invoiceInput.value = item.InvoiceNumber || '';
            invoiceInput.readOnly = true;
        }
        if (amountInput) {
            const amount = parseFloat(item.Amount) || 0;
            amountInput.value = amount;
            amountInput.readOnly = true;
            totalAmount += amount; // Add to running total
        }
    });

    // Set the initial total amount
    const totalElement = document.getElementById('totalAmount');
    if (totalElement) {
        totalElement.textContent = totalAmount.toFixed(2);
    }

    // Handle signatures
    if (data.data.signatures) {
        data.data.signatures.forEach(sig => {
            if (sig.file && sig.id) {
                let padId;
                // Match signature to correct pad
                if (sig.id.toLowerCase().includes('empsig')) {
                    padId = 'employeeSignature';
                } else if (sig.id.toLowerCase().includes('mngrsig')) {
                    padId = 'managerSignature';
                } else if (sig.id.toLowerCase().includes('provsig')) {
                    padId = 'provadorSignature';
                }

                if (padId && signaturePads[padId]) {
                    const canvas = signaturePads[padId].canvas;
                    // Store original data
                    canvas.dataset.originalSignature = sig.file;
                    canvas.dataset.signatureId = sig.id;
                    // Draw signature using helper function
                    drawSignatureToCanvas(canvas, sig.file, signaturePads[padId]);
                }
            }
        });
    }

    // Handle attached files
    if (data.data.files) {
        data.data.files.forEach(fileData => {
            if (fileData.file && fileData.id) {
                const card = container.querySelector(`[data-expense-id="${fileData.id}"]`);
                if (!card) return;

                const previewContainer = card.querySelector('.file-preview');
                if (!previewContainer) return;

                const previewItem = document.createElement('div');
                const isPdf = fileData.name.toLowerCase().endsWith('.pdf');
                previewItem.className = isPdf ? 'file-preview-item pdf-preview' : 'file-preview-item';
                previewItem.dataset.originalFile = fileData.file;

                if (isPdf) {
                    previewItem.innerHTML = `
                        <i class="fas fa-file-pdf"></i>
                        <span>${fileData.name}</span>
                        <button type="button" class="file-remove" onclick="event.stopPropagation(); removeFile(this)" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                } else {
                    const mimeType = fileData.name.split('.').pop().toLowerCase() === 'png' ? 'image/png' : 'image/jpeg';
                    const dataUrl = `data:${mimeType};base64,${fileData.file}`;
                    previewItem.innerHTML = `
                        <img src="${dataUrl}" alt="${fileData.name}">
                        <button type="button" class="file-remove" onclick="event.stopPropagation(); removeFile(this)" disabled>
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                }

                previewItem.addEventListener('click', () => {
                    openPreview(previewItem.querySelector('img') || previewItem);
                });

                previewContainer.appendChild(previewItem);

                // Hide drop zone
                const dropZone = card.querySelector('.file-drop-zone');
                if (dropZone) dropZone.style.display = 'none';
            }
        });
    }

    // Set up manager review mode controls if needed
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('id')) {
        // Hide file upload zones
        document.querySelectorAll('.file-drop-zone').forEach(zone => {
            zone.style.display = 'none';
        });

        // Disable inputs except manager signature
        document.querySelectorAll('input, .file-remove').forEach(el => {
            if (!el.closest('#managerSignature') && 
                !el.classList.contains('theme-toggle') && 
                !el.classList.contains('close-preview') &&
                !el.classList.contains('submit-button')) {
                el.disabled = true;
            }
        });

        // Disable non-manager signature pads
        ['employeeSignature', 'provadorSignature'].forEach(id => {
            if (signaturePads[id]) {
                signaturePads[id].off();
            }
        });
    }
    setTimeout(() => {
        updateTotal();
    }, 0);
    // Update progress bar
    updateProgress();
}

function setupManagerReviewMode(data) {
    // Get status from the response
    const status = data.expense_main[0].Status.Value;
    const isFinalized = status === 'Approved' || status === 'Rejected';
    
    // First check if header already exists to avoid duplicates
    const existingHeader = document.querySelector('.manager-review-header');
    
    if (!existingHeader) {
        // Create the header element
        const header = document.createElement('div');
        header.className = 'alert alert-info manager-review-header';
        header.style.margin = '0';
        header.style.borderRadius = '0';
        
        // Set header text based on status
        let headerText = '';
        if (status === 'Approved') {
            headerText = 'הדוח אושר על ידי המנהל';
            header.className = 'alert alert-success manager-review-header';
        } else if (status === 'Rejected') {
            headerText = 'הדוח נדחה על ידי המנהל';
            header.className = 'alert alert-danger manager-review-header';
        } else {
            headerText = 'הנך מתבקש/ת לסקור את הדוח ולחתום כמנהל/ת ישיר/ה';
        }
        
        header.innerHTML = `
            <div class="container">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <div>${headerText}</div>
                </div>
            </div>
        `;

        const mainHeader = document.querySelector('header.header');
        if (mainHeader) {
            mainHeader.parentNode.insertBefore(header, mainHeader.nextSibling);
        }
    }

    // Update employee name field
    const employeeNameInput = document.querySelector('input[name="employeeName"]');
    const employeeNameLabel = employeeNameInput.previousElementSibling;
    employeeNameLabel.textContent = 'שם עובד/ת';
    employeeNameInput.type = 'text';
    employeeNameInput.placeholder = '';

    // Make form fields readonly
    document.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="month"]').forEach(input => {
        input.readOnly = true;
    });

    // Handle signatures based on status
    Object.keys(signaturePads).forEach(key => {
        if (signaturePads[key]) {
            // If status is Approved or Rejected, make all signatures readonly
            if (isFinalized) {
                signaturePads[key].off();
                const canvas = signaturePads[key].canvas;
                if (canvas) {
                    canvas.style.cursor = 'not-allowed';
                    canvas.style.opacity = '0.7';
                }
            } else {
                // Normal behavior - only manager signature is editable
                if (key !== 'managerSignature') {
                    signaturePads[key].off();
                    const canvas = signaturePads[key].canvas;
                    if (canvas) {
                        canvas.style.cursor = 'not-allowed';
                        canvas.style.opacity = '0.7';
                    }
                } else {
                    signaturePads[key].on();
                    const canvas = signaturePads[key].canvas;
                    if (canvas) {
                        canvas.style.cursor = 'crosshair';
                        canvas.style.opacity = '1';
                    }
                }
            }
        }
    });

    // Update floating total section based on status
    const floatingTotal = document.querySelector('.floating-total');
    if (floatingTotal) {
        if (isFinalized) {
            // If approved/rejected, just show the total
            floatingTotal.innerHTML = `
                <div>
                    סה"כ: <span id="totalAmount">0.00</span> ₪
                </div>
            `;
        } else {
            // Show approve/reject buttons for pending review
            floatingTotal.innerHTML = `
                <div>
                    סה"כ: <span id="totalAmount">0.00</span> ₪
                </div>
                <div class="d-flex gap-3">
                    <button type="button" class="reject-button" onclick="handleRejectReport()">
                        <i class="fas fa-times"></i> דחה דוח
                    </button>
                    <button type="button" class="approve-button" onclick="handleManagerApprove(event)">
                        <i class="fas fa-check"></i> אשר דוח
                    </button>
                </div>
            `;
        }
    }

    // Hide unnecessary elements
    const elementsToHide = [
        '.quick-add-bar',
        '.btn-outline-danger', 
        '.file-drop-zone',
        '.signature-actions button',
        '.file-remove'
    ];

    elementsToHide.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            el.style.display = 'none';
        });
    });

    // Add manager review class to body
    document.body.classList.add('manager-review-mode');

    // Update progress bar
    updateProgress();
}


// Initialize signature pads
        const signaturePads = {
            employeeSignature: initSignaturePad('employeeSignature'),
            managerSignature: initSignaturePad('managerSignature'),
            provadorSignature: initSignaturePad('provadorSignature')
        };


        function removeExpenseRow(button) {
            const card = button.closest('.expense-card');
            card.classList.remove('animate__fadeIn');
            card.classList.add('animate__fadeOut');

            card.addEventListener('animationend', () => {
                card.remove();
                updateTotal();
            });
        }
        function drawSignatureToCanvas(canvas, base64Data, padInstance) {
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
        // Get the actual canvas display dimensions
        const displayWidth = canvas.width / window.devicePixelRatio;
        const displayHeight = canvas.height / window.devicePixelRatio;
        
        // Calculate scale to fit the entire signature
        const scaleWidth = displayWidth / 432;  // Original width
        const scaleHeight = displayHeight / 187; // Original height
        const scale = Math.min(scaleWidth, scaleHeight);
        
        // Calculate centered position
        const centerX = (displayWidth - (432 * scale)) / 2;
        const centerY = (displayHeight - (187 * scale)) / 2;
        
        // Clear any existing content
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw the image at the calculated position and scale
        ctx.drawImage(
            img,
            centerX * window.devicePixelRatio,
            centerY * window.devicePixelRatio,
            432 * scale * window.devicePixelRatio,
            187 * scale * window.devicePixelRatio
        );
        
        // Mark the signature pad as having content
        if (padInstance) {
            padInstance._isEmpty = false;
        }
    };
    
    img.src = 'data:image/png;base64,' + base64Data;
}
function initSignaturePad(elementId) {
    const canvas = document.getElementById(elementId);
    const rect = canvas.getBoundingClientRect();

    // Set initial canvas size
    canvas.width = rect.width * window.devicePixelRatio;
    canvas.height = rect.height * window.devicePixelRatio;
    
    // Configure pad
    const pad = new SignaturePad(canvas, {
        penColor: getSignatureColor(),
        backgroundColor: 'transparent',
        velocityFilterWeight: 0.5,
        minWidth: 0.5,
        maxWidth: 2.5,
        throttle: 16,
        minDistance: 0.5
    });

    // Handle resize
    const handleResize = () => {
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * window.devicePixelRatio;  // Fixed here
        canvas.height = rect.height * window.devicePixelRatio; // Fixed here

        if (canvas.dataset.originalSignature) {
            drawSignatureToCanvas(canvas, canvas.dataset.originalSignature, pad);
        }
    };

    // Add resize event listener
    window.addEventListener('resize', handleResize);

    return pad;
}

        function getSignatureColor() {
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            return isDarkMode ? '#ffffff' : '#121f3f'; // White for dark mode, Abra navy for light mode
        }
        function clearSignature(id) {
    if (signaturePads[id]) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext('2d');

        // Clear canvas and data
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        delete canvas.dataset.originalSignature;
        delete canvas.dataset.signatureId;

        signaturePads[id].clear();
        signaturePads[id].penColor = getSignatureColor();
    }
}
        function updateTotal() {
            const amounts = document.querySelectorAll('.expense-amount');
            const total = Array.from(amounts).reduce((sum, input) => {
                return sum + (parseFloat(input.value) || 0);
            }, 0);

            const totalElement = document.getElementById('totalAmount');
            // Animate the total change
            animateNumber(
                parseFloat(totalElement.textContent),
                total,
                {
                    duration: 500,
                    onUpdate: (value) => {
                        totalElement.textContent = value.toFixed(2);
                    }
                }
            );
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-3" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 150);
            }, 5000);
        }

        function updateProgress() {
            const form = document.getElementById('expenseForm');
            const totalFields = form.querySelectorAll('[required]').length;
            const filledFields = Array.from(form.querySelectorAll('[required]')).filter(field => field.value).length;
            const signatures = Object.values(signaturePads).filter(pad => !pad.isEmpty()).length;

            const progress = ((filledFields / totalFields) * 0.7 + (signatures / 3) * 0.3) * 100;

            document.querySelector('.progress-bar').style.width = `${progress}%`;
        }

        // Add event listeners for all form fields
        document.querySelectorAll('[required]').forEach(field => {
            field.addEventListener('change', updateProgress);
        });

        // Update progress when signatures change
        Object.values(signaturePads).forEach(pad => {
            pad.addEventListener('endStroke', updateProgress);
        });
        function quickAdd(type) {
            const container = document.getElementById('expensesContainer');
            const today = new Date().toISOString().split('T')[0];

            const card = document.createElement('div');
            card.className = 'expense-card animate__animated animate__fadeIn';

            let typeLabel, typeIcon, typeClass;
            switch (type) {
                case 'fuel':
                    typeLabel = 'דלק';
                    typeIcon = 'gas-pump';
                    typeClass = 'fuel';
                    break;
                case 'parking':
                    typeLabel = 'חניה';
                    typeIcon = 'parking';
                    typeClass = 'parking';
                    break;
                case 'other':
                    typeLabel = 'הוצאה אחרת';
                    typeIcon = 'receipt';
                    typeClass = 'other';
                    break;
            }

            card.innerHTML = `
                <div class="expense-type-indicator expense-type-${typeClass}">
                    <i class="fas fa-${typeIcon}"></i>
                    ${typeLabel}
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">תאריך</label>
                        <input type="date" class="form-control" value="${today}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">מספר חשבונית</label>
                        <input type="text" class="form-control" placeholder="הזן מספר חשבונית" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">סכום</label>
                        <div class="input-group">
                            <input type="number" step="0.01" class="form-control expense-amount" required>
                            <span class="input-group-text">₪</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeExpenseRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="col-12">
                        <div class="file-drop-zone" ondrop="handleFileDrop(event, this)" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 2rem;"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       title="צלם את הקבלה באמצעות הטלפון או גרור לכאן קובץ PDF"></i>
                            <div>גרור קבצים לכאן או לחץ להעלאה</div>
                            <div class="text-muted">(תמונות או PDF בלבד)</div>
                            <input type="file" class="d-none" accept="image/*,.pdf" multiple 
                                   onchange="handleFileSelect(event, this.parentElement)">
                        </div>
                        <div class="file-preview"></div>
                    </div>
                </div>
            `;

            container.insertBefore(card, container.firstChild);
            updateTotal();

            // Add click handler for file upload zone
            const dropZone = card.querySelector('.file-drop-zone');
            dropZone.addEventListener('click', () => {
                dropZone.querySelector('input[type="file"]').click();
            });
        }

        // New functions for file handling
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
        }

        function handleFileDrop(event, dropZone) {
            event.preventDefault();
            dropZone.classList.remove('drag-over');

            const files = event.dataTransfer.files;
            handleFiles(files, dropZone);
        }

        function handleFileSelect(event, dropZone) {
            const files = event.target.files;
            handleFiles(files, dropZone);
        }

        async function handleFiles(files, dropZone) {
    const validFiles = Array.from(files).filter(file => {
        const type = file.type.toLowerCase();
        return type.startsWith('image/') || type === 'application/pdf';
    });

    if (validFiles.length !== files.length) {
        showNotification('רק קבצי תמונה ו-PDF מותרים להעלאה', 'warning');
    }

    const expenseCard = dropZone.closest('.expense-card');
    const previewContainer = dropZone.nextElementSibling;

    // Check if important fields already have data
    const amountInput = expenseCard.querySelector('.expense-amount');
    const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
    const hasExistingData = (amountInput?.value || invoiceInput?.value);

    for (const file of validFiles) {
        try {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    // Create and add preview
                    const preview = document.createElement('div');
                    preview.className = 'file-preview-item';
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <button type="button" class="file-remove" onclick="event.stopPropagation(); removeFile(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    preview.addEventListener('click', () => {
                        openPreview(preview.querySelector('img'));
                    });
                    
                    previewContainer.appendChild(preview);

                    // Only process receipt if no existing data
                    if (!hasExistingData) {
                        // Add loading overlay
                        const loadingOverlay = document.createElement('div');
                        loadingOverlay.className = 'processing-overlay';
                        loadingOverlay.innerHTML = `
                            <div class="processing-spinner"></div>
                            <div>מעבד את הקבלה...</div>
                        `;
                        expenseCard.style.position = 'relative';
                        expenseCard.appendChild(loadingOverlay);

                        try {
                            loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'מזהה פרטי קבלה...';
                            const base64Image = e.target.result.split(',')[1];
                            const receiptData = await processReceiptImage(base64Image);
                            
                            loadingOverlay.querySelector('div:not(.processing-spinner)').textContent = 'ממלא נתונים...';
                            await populateExpenseFields(expenseCard, receiptData);
                            
                            loadingOverlay.remove();
                            showNotification('נתוני הקבלה זוהו והוזנו בהצלחה', 'success');
                        } catch (error) {
                            console.error('Error processing receipt:', error);
                            loadingOverlay.remove();
                            showNotification('לא ניתן היה לזהות את נתוני הקבלה באופן אוטומטי', 'warning');
                        }
                    }
                };
                reader.readAsDataURL(file);
                
            } else if (file.type === 'application/pdf') {
                // Create object URL for PDF files
                const pdfUrl = URL.createObjectURL(file);
                const pdfPreview = document.createElement('div');
                pdfPreview.className = 'file-preview-item pdf-preview';
                pdfPreview.dataset.pdfUrl = pdfUrl;
                pdfPreview.innerHTML = `
                    <i class="fas fa-file-pdf"></i>
                    <span>${file.name}</span>
                    <button type="button" class="file-remove" onclick="event.stopPropagation(); removeFile(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                pdfPreview.addEventListener('click', () => {
                    openPreview(pdfPreview);
                });

                // Store the object URL for cleanup
                pdfPreview.dataset.objectUrl = pdfUrl;
                
                previewContainer.appendChild(pdfPreview);
            }
        } catch (error) {
            console.error('Error handling file:', error);
            showNotification('שגיאה בטעינת הקובץ: ' + error.message, 'danger');
        }
    }

    // Hide drop zone if files were added
    if (validFiles.length > 0) {
        dropZone.style.display = 'none';
    }
}
function removeFile(button) {
    const previewItem = button.closest('.file-preview-item, .pdf-preview');
    
    // Cleanup object URL if it exists
    if (previewItem.dataset.objectUrl) {
        URL.revokeObjectURL(previewItem.dataset.objectUrl);
    }
    
    previewItem.remove();
}
        // Animate number changes
        function animateNumber(start, end, options) {
            const startTime = performance.now();
            const duration = options.duration || 1000;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function for smooth animation
                const easeOutQuad = (t) => t * (2 - t);
                const easedProgress = easeOutQuad(progress);

                const currentValue = start + (end - start) * easedProgress;
                options.onUpdate(currentValue);

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }
        const GEMINI_API_KEY = 'AIzaSyDixJ-7jmpArj67qP5mbT95roaO6gvCES4';
        // Function to process receipt image with Gemini API
        async function processReceiptImage(imageBase64) {
            const systemPrompt = `אתה מומחה בניתוח קבלות. אנא חלץ את המידע הבא מהקבלה ותחזיר אותו בפורמט JSON:
    - תאריך (date)
    - סכום לתשלום (total_payment)
    - מספר קבלה/חשבונית (reception_number)
    
    החזר את התוצאה בפורמט הבא בדיוק:
    { "date": "DD/MM/YY", "total_payment": "X,XXX.XX", "reception_number": "XXXXX" }`;

            // Array of model configurations to try in order
            const models = [
                {
                    name: 'Gemini 1.5',
                    handler: async () => {
                        const requestBody = {
                            contents: [{
                                parts: [
                                    { text: systemPrompt },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: imageBase64
                                        }
                                    }
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.1,
                                topK: 1,
                                topP: 0.1
                            }
                        };

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestBody)
                            }
                        );

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    }
                },
                {
                    name: 'Gemini 1.5 Flash 8B',
                    handler: async () => {
                        const requestBody = {
                            contents: [{
                                role: "user",
                                parts: [
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: imageBase64
                                        }
                                    },
                                    { text: systemPrompt }
                                ]
                            }],
                            generationConfig: {
                                temperature: 1,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                                responseMimeType: "text/plain"
                            }
                        };

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-8b:generateContent?key=${GEMINI_API_KEY}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestBody)
                            }
                        );

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    }
                },
                {
                    name: 'Gemini 2.0',
                    handler: async () => {
                        const requestBody = {
                            contents: [{
                                role: "user",
                                parts: [
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: imageBase64
                                        }
                                    },
                                    { text: systemPrompt }
                                ]
                            }],
                            generationConfig: {
                                temperature: 1,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                                responseMimeType: "text/plain"
                            }
                        };

                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestBody)
                            }
                        );

                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    }
                }
            ];

            // Try each model in sequence
            let lastError = null;
            for (const model of models) {
                try {
                    console.log(`Trying ${model.name}...`);
                    const data = await model.handler();

                    // Parse the response
                    try {
                        const text = data.candidates[0].content.parts[0].text;
                        const jsonMatch = text.match(/```json\n([\s\S]*?)\n```/);

                        if (!jsonMatch) {
                            throw new Error('Invalid response format');
                        }

                        const jsonString = jsonMatch[1].trim();
                        const result = JSON.parse(jsonString);

                        console.log(`Success with ${model.name}`);
                        return result;
                    } catch (parseError) {
                        console.error(`${model.name} response parsing error:`, parseError);
                        throw parseError;
                    }
                } catch (error) {
                    console.error(`${model.name} failed:`, error);
                    lastError = error;
                    continue; // Try next model
                }
            }

            // If we get here, all models failed
            console.error('All models failed to process the receipt');
            throw new Error('לא ניתן היה לזהות את נתוני הקבלה - ' + lastError.message);
        }

        async function handleRejectReport() {
    try {
        // Get the reason for rejection
        const reason = await showRejectDialog();
        if (!reason) return; // User cancelled

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');

        const overlay = showLoadingOverlay('שולח דחייה...');

        const response = await fetch('https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                id: id,
                action: "manager-reject",
                status: 'rejected',
                rejectionReason: reason,
                rejectedAt: new Date().toISOString()
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        hideLoadingOverlay();
        showNotification('הדוח נדחה בהצלחה', 'success');

        // Redirect after short delay
        setTimeout(() => {
            window.location.href = '/expenses/dashboard';
        }, 200000);

    } catch (error) {
        console.error('Error rejecting report:', error);
        hideLoadingOverlay();
        showNotification('שגיאה בדחיית הדוח: ' + error.message, 'danger');
    }
}
function showRejectDialog() {
    return new Promise((resolve) => {
        // Create modal backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        document.body.appendChild(backdrop);

        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">סיבת דחייה</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <textarea class="form-control" rows="3" 
                                placeholder="אנא ציין את סיבת הדחייה"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                        <button type="button" class="btn btn-primary">שלח</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Handle close
        const closeModal = () => {
            modal.remove();
            backdrop.remove();
            resolve(null);
        };

        // Handle submit
        const submitReason = () => {
            const reason = modal.querySelector('textarea').value.trim();
            if (!reason) {
                showNotification('אנא ציין את סיבת הדחייה', 'warning');
                return;
            }
            modal.remove();
            backdrop.remove();
            resolve(reason);
        };

        // Add event listeners
        modal.querySelector('[data-bs-dismiss="modal"]').onclick = closeModal;
        modal.querySelector('.btn-secondary').onclick = closeModal;
        modal.querySelector('.btn-primary').onclick = submitReason;
        modal.querySelector('textarea').onkeydown = (e) => {
            if (e.key === 'Enter' && e.ctrlKey) submitReason();
        };
    });
}
        function populateExpenseFields(expenseCard, receiptData) {
            try {
                // Convert date from DD/MM/YY to YYYY-MM-DD for input field
                const [day, month, year] = receiptData.date.split('/');
                const fullYear = '20' + year; // Assuming all dates are from 2000s
                const formattedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                // Populate date field
                const dateInput = expenseCard.querySelector('input[type="date"]');
                if (dateInput) dateInput.value = formattedDate;

                // Populate invoice number
                const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
                if (invoiceInput) invoiceInput.value = receiptData.reception_number;

                // Populate amount (remove commas and convert to number)
                const amountInput = expenseCard.querySelector('.expense-amount');
                if (amountInput) {
                    const amount = receiptData.total_payment.replace(/,/g, '');
                    amountInput.value = parseFloat(amount);
                }

                // Update total
                updateTotal();

                console.log('Receipt data populated successfully:', receiptData);
            } catch (error) {
                console.error('Error populating fields:', error);
                throw new Error('שגיאה במילוי הנתונים מהקבלה');
            }
        }

        // Listen for amount changes
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('expense-amount')) {
                updateTotal();
            }
        });


// Helper function to get clean base64 data
function getCleanBase64FromDataUrl(dataUrl) {
    if (!dataUrl) return null;
    // Remove the data URL prefix (e.g., "data:image/png;base64,")
    const base64Data = dataUrl.split(',')[1];
    return base64Data;
}

// Helper function to get signature data
function getSignatureData(signaturePad) {
    if (!signaturePad || signaturePad.isEmpty()) return null;
    return getCleanBase64FromDataUrl(signaturePad.toDataURL());
}
async function handleManagerApprove(e) {
    e.preventDefault();
    
    if (signaturePads.managerSignature.isEmpty()) {
        showNotification('נדרשת חתימת מנהל', 'warning');
        return;
    }

    const overlay = showLoadingOverlay('שולח אישור...');
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    try {
        const response = await fetch('https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                id: id,
                action: "manager-approve",
                status: 'manager_approved',
                managerSignature: getSignatureData(signaturePads.managerSignature),
                approvedAt: new Date().toISOString()
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        hideLoadingOverlay();
        showNotification('הדוח אושר בהצלחה!', 'success');

        // Redirect after successful approval
        setTimeout(() => {
            window.location.href = '/expenses/dashboard';
        }, 2000);

    } catch (error) {
        console.error('Error approving report:', error);
        hideLoadingOverlay();
        showNotification('שגיאה באישור הדוח: ' + error.message, 'danger');
    }
}



// When submitting new report
document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    if (id) {
        // Call handleManagerApprove directly for manager review mode
        await handleManagerApprove(e);
    } else {
        // Handle new submission
        await handleNewSubmission(e);
    }
});

async function handleNewSubmission(e) {
    if (!validateForm()) {
        showNotification('נא למלא את כל השדות הנדרשים', 'warning');
        return;
    }

    const overlay = showLoadingOverlay('שולח נתונים...');

    try {
        const formData = new FormData(e.target);
        const expenses = await collectExpenses();

        const data = {
            employeeInfo: {
                month: formData.get('month'),
                email: formData.get('employeeName'), // Now storing email instead of name
            },
            expenses: expenses,
            signatures: {
                employee: getSignatureData(signaturePads.employeeSignature)
            },
            totalAmount: parseFloat(document.getElementById('totalAmount').textContent),
            submittedAt: new Date().toISOString()
        };

        const response = await fetch('https://prod-231.westeurope.logic.azure.com:443/workflows/5e62cd12d64e41b590dfe658c682446d/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=lf93ZLn6PE3PLfqJZkwQmbcFuOiwLD2MLgbUN8tGzhs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify({
                ...data,
                action: "new-submit",
                status: 'submitted'
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        hideLoadingOverlay();
        showNotification('הדוח נשלח בהצלחה!', 'success');

        if (confirm('האם ברצונך לנקות את הטופס?')) {
            e.target.reset();
            Object.values(signaturePads).forEach(pad => pad.clear());
            document.getElementById('expensesContainer').innerHTML = '';
            updateTotal();
            initializeNewSubmission();
        }
    } catch (error) {
        console.error('Error:', error);
        hideLoadingOverlay();
        showNotification('אירעה שגיאה בשליחת הדוח: ' + error.message, 'danger');
    }
}       
        
        function initTooltips() {
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(element => {
                if (!element._tippy) {
                    new bootstrap.Tooltip(element);
                }
            });
        }
        function showLoadingOverlay(initialMessage = 'טוען נתונים...') {
    removeExistingOverlays();

    const stages = [
        { id: 'queued', label: 'בתור לעיבוד', icon: 'clock' },
        { id: 'connecting', label: 'מתחבר לשרת', icon: 'link' },
        { id: 'processing', label: 'מעבד נתונים', icon: 'cog' },
        { id: 'downloading', label: 'מוריד תוכן', icon: 'download' }
    ];

    const overlay = document.createElement('div');
    overlay.className = 'fixed-top vh-100 vw-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50 backdrop-blur';

    const content = document.createElement('div');
    content.className = 'card shadow-lg border-0 mx-3';
    content.style.maxWidth = '450px';
    
    content.innerHTML = `
        <div class="card-body p-4">
            <div class="text-center mb-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">טוען...</span>
                </div>
                <h5 class="mb-0 text-body">${initialMessage}</h5>
            </div>
            <div class="stages-container">
                ${stages.map((stage, index) => `
                    <div class="stage-item mb-3" data-stage="${stage.id}">
                        <div class="d-flex align-items-center gap-3">
                            <div class="stage-icon">
                                <i class="fas fa-${stage.icon} text-muted"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="stage-label fw-medium">${stage.label}</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="stage-duration text-muted small">0ms</span>
                                        <span class="stage-status">
                                            <i class="fas fa-circle fs-6 text-muted opacity-50"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="progress rounded-pill" style="height: 6px;">
                                    <div class="progress-bar bg-primary rounded-pill" 
                                         role="progressbar" 
                                         style="width: 0%" 
                                         aria-valuenow="0" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    // Add some additional class styling
    const style = document.createElement('style');
    style.textContent = `
        .backdrop-blur {
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .stage-item {
            transition: opacity 0.3s ease;
        }
        .stage-item.completed .stage-icon i {
            color: var(--bs-success) !important;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    `;
    document.head.appendChild(style);

    overlay.appendChild(content);
    document.body.appendChild(overlay);

    return {
        updateStage: (stageId, progress) => {
            const stageElement = overlay.querySelector(`[data-stage="${stageId}"]`);
            if (!stageElement) return;

            const progressBar = stageElement.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
        },
        getStageElement: (stageId) => {
            return overlay.querySelector(`[data-stage="${stageId}"]`);
        },
        setMessage: (message) => {
            const messageElement = content.querySelector('h5');
            if (messageElement) {
                messageElement.textContent = message;
            }
        },
        close: () => {
            overlay.remove();
            style.remove();
        }
    };
}   
        function removeExistingOverlays() {
            const existingOverlays = document.querySelectorAll('.loading-overlay');
            existingOverlays.forEach(overlay => overlay.remove());
        }
        function validateForm() {
            const form = document.getElementById('expenseForm');
            const requiredFields = form.querySelectorAll('[required]');

            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Check signatures
            const signatures = Object.values(signaturePads);
            signatures.forEach(pad => {
                const canvas = pad.canvas;
                if (pad.isEmpty()) {
                    canvas.style.borderColor = 'var(--danger)';
                    isValid = false;
                } else {
                    canvas.style.borderColor = '';
                }
            });

            return isValid;
        }

        async function collectExpenses() {
    const expenses = [];
    
    // Helper function to convert blob URL to base64
    async function blobToBase64(blobUrl) {
        const response = await fetch(blobUrl);
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => {
                // Remove the data URL prefix (e.g., "data:application/pdf;base64,")
                const base64Data = reader.result.split(',')[1];
                resolve(base64Data);
            };
            reader.onerror = reject;
            reader.readAsDataURL(blob);
        });
    }

    // Process each expense card
    for (const card of document.querySelectorAll('.expense-card')) {
        const type = card.querySelector('.expense-type-indicator').textContent.trim();
        const fileElements = card.querySelectorAll('.file-preview-item');
        const files = [];

        // Process each file
        for (const el of fileElements) {
            let fileType, fileData, fileName;
            
            if (el.classList.contains('pdf-preview')) {
                // Handle PDF files
                fileType = 'application/pdf';
                fileName = el.querySelector('span').textContent;
                
                // Handle different PDF data sources
                if (el.dataset.originalFile) {
                    // Review mode - already in base64
                    fileData = el.dataset.originalFile;
                } else if (el.dataset.pdfUrl && el.dataset.pdfUrl.startsWith('blob:')) {
                    // Upload mode - need to convert blob URL to base64
                    fileData = await blobToBase64(el.dataset.pdfUrl);
                }
            } else {
                // Handle image files
                const img = el.querySelector('img');
                fileType = img.src.startsWith('data:image/png') ? 'image/png' : 'image/jpeg';
                fileName = `receipt_${Date.now()}.${fileType.split('/')[1]}`;
                
                if (img.src.startsWith('data:')) {
                    // Image is already in base64
                    fileData = img.src.split(',')[1];
                } else if (img.src.startsWith('blob:')) {
                    // Convert blob URL to base64
                    fileData = await blobToBase64(img.src);
                }
            }

            // Only add file if we successfully got the data
            if (fileData) {
                files.push({
                    type: fileType,
                    name: fileName,
                    body: fileData
                });
            }
        }

        expenses.push({
            type: type,
            date: card.querySelector('input[type="date"]').value,
            invoice: card.querySelector('input[placeholder="הזן מספר חשבונית"]').value,
            amount: parseFloat(card.querySelector('.expense-amount').value) || 0,
            files: files
        });
    }
    
    return expenses;
}




        // Function to hide loading overlay
        function hideLoadingOverlay() {
            removeExistingOverlays();
        }
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            if (window.scrollY > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });
        // Intersection Observer for better performance
        const headerObserver = new IntersectionObserver(
            (entries) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) {
                        entry.target.classList.add('scrolled');
                    } else {
                        entry.target.classList.remove('scrolled');
                    }
                });
            },
            { threshold: 1 }
        );

        // Observe the header
        const header = document.querySelector('.header');
        if (header) {
            headerObserver.observe(header);
        }




        // Initialize form
        window.addEventListener('load', () => {

            initializeForm();
            // Set current month as default
            const today = new Date();
            const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.querySelector('input[name="month"]').value = month;
        });
        document.addEventListener('DOMContentLoaded', function () {
            initTooltips();

            // Add tooltips to signatures
            const signaturePads = document.querySelectorAll('.signature-pad');
            signaturePads.forEach(pad => {
                pad.setAttribute('data-bs-toggle', 'tooltip');
                pad.setAttribute('data-bs-placement', 'top');
                pad.setAttribute('title', 'חתום כאן - לחץ והחזק את העכבר תוך כדי ציור החתימה');
            });

            // Add tooltips to form fields
            document.querySelector('input[name="month"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="month"]').setAttribute('title', 'בחר את החודש עבורו מוגש הדוח');

            document.querySelector('input[name="employeeName"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="employeeName"]').setAttribute('title', 'הזן את כתובת המייל שלך כפי שהיא רשומה במערכת, כדי להבטיח זיהוי נכון.');

            document.querySelector('input[name="department"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="department"]').setAttribute('title', 'בחר את המחלקה או החטיבה אליה אתה שייך');

            initTooltips();
        });
        // Theme Switcher Logic
        function initThemeSwitcher() {
            const themeToggle = document.querySelector('.theme-toggle');

            function setTheme(isDark) {
                document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            }

            themeToggle.addEventListener('click', () => {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                setTheme(!isDarkMode);
            });

            // Set initial theme based on user's system preferences
            //if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
             //   setTheme(true);
           // }

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                setTheme(e.matches);
            });
        }
        function openPreview(element) {
    const overlay = document.getElementById('filePreviewOverlay');
    const container = overlay.querySelector('.preview-container');

    // Clear previous content
    container.innerHTML = '';

    try {
        if (element.tagName === 'IMG') {
            // Handle image preview
            container.classList.remove('pdf-mode');
            const img = document.createElement('img');
            img.src = element.src;
            container.appendChild(img);
        } else if (element.classList.contains('pdf-preview')) {
            // Handle PDF preview
            container.classList.add('pdf-mode');
            
            // First check for base64 data (review mode)
            const fileData = element.closest('.file-preview-item')?.dataset.originalFile;
            if (fileData) {
                // In review mode - use the base64 data
                renderPDF(fileData, container);
            } else {
                // In upload mode - use the object URL
                const pdfUrl = element.dataset.pdfUrl;
                if (!pdfUrl) {
                    throw new Error('PDF data not found');
                }
                renderPDF(pdfUrl, container);
            }
        }

        // Show overlay with animation
        overlay.classList.add('active');

        // Add keyboard listener for escape key
        document.addEventListener('keydown', handleEscKey);
    } catch (error) {
        console.error('Preview error:', error);
        showNotification('שגיאה בטעינת התצוגה המקדימה: ' + error.message, 'danger');
    }
}
        // Function to close preview
        function closePreview() {
    const overlay = document.getElementById('filePreviewOverlay');
    overlay.classList.remove('active');

    // Cleanup PDF viewer
    currentPdfDoc = null;
    currentScale = initialScale;
    currentPage = 1;

    // Remove event listeners
    document.removeEventListener('keydown', handleEscKey);
}

        // Handle escape key press
        function handleEscKey(e) {
            if (e.key === 'Escape') {
                closePreview();
            }
        }








        // Initialize theme switcher when DOM is loaded
        document.addEventListener('DOMContentLoaded', initThemeSwitcher);
    </script>
    <div id="filePreviewOverlay" class="file-preview-overlay">
        <div class="preview-content">
            <button type="button" class="close-preview" onclick="closePreview()">
                <i class="fas fa-times"></i>
            </button>
            <div class="preview-container">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>
</body>

</html>