<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דוח החזר הוצאות | Abra</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <style>
/* CSS Variables */
:root {
    /* Brand Colors */
    --abra-navy: rgb(18, 31, 63);      /* #121f3f */
    --abra-coral: rgb(255, 119, 72);   /* #ff7748 */
    --abra-pink: rgb(255, 82, 136);    /* #ff5288 */
    --abra-yellow: rgb(255, 159, 0);   /* #ff9f00 */
    --abra-white: rgb(252, 249, 245);  /* #fcf9f5 */
    
    /* Secondary Colors */
    --coral-light: rgba(255, 119, 72, 0.1);
    --pink-light: rgba(255, 82, 136, 0.1);
    --yellow-light: rgba(255, 159, 0, 0.1);
    --navy-light: rgba(18, 31, 63, 0.1);
    
    /* Typography */
    --font-heading: 'Sharp Sans No1', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-body: 'Simpler Pro', -apple-system, BlinkMacSystemFont, sans-serif;
    
    /* Shadows */
    --shadow-sm: 0 2px 4px rgba(18, 31, 63, 0.05);
    --shadow-md: 0 4px 12px rgba(18, 31, 63, 0.1);
    --shadow-lg: 0 8px 24px rgba(18, 31, 63, 0.15);
    
    /* Border Radius */
    --radius-sm: 0.5rem;
    --radius-md: 0.75rem;
    --radius-lg: 1rem;
    --radius-full: 9999px;
    --font-heading: 'Sharp Sans No1', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-body: 'Simpler Pro', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}
@font-face {
    font-family: 'Sharp Sans No1';
    src: url('./fonts/SharpSansNo1-Bold.otf') format('opentype');
    font-weight: 700;
    font-style: normal;
}

@font-face {
    font-family: 'Simpler Pro';
    src: url('./fonts/SimplerPro-Bold.otf') format('opentype');
    font-weight: 700;
    font-style: normal;
}

@font-face {
    font-family: 'Simpler Pro';
    src: url('./fonts/SimplerPro-Regular.otf') format('opentype');
    font-weight: 400;
    font-style: normal;
}

/* Base Styles */
body {
    background-color: var(--abra-white);
    font-family: var(--font-body);
    color: var(--abra-navy);
    line-height: 1.5;
    min-height: 100vh;
    padding-bottom: 80px;
}

h1, h2, h3, h4, h5, h6 {
    font-family: var(--font-heading);
    font-weight: bold;
    line-height: 1.2;
}

/* Header Styles */
.header {
    background: var(--abra-navy);
    padding: 1.5rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-md);
    transition: all 0.3s ease;
}
/* English Headings */
.heading-en {
    font-family: var(--font-heading);
    font-weight: 700;
    letter-spacing: -0.02em;
}

/* Hebrew Headings */
.heading-he {
    font-family: var(--font-body);
    font-weight: 700;
}

/* Body Text - English */
.body-en {
    font-family: var(--font-body);
    font-weight: 400;
}

/* Body Text - Hebrew */
.body-he {
    font-family: var(--font-body);
    font-weight: 400;
}

/* Typography Scale */
.text-display {
    font-size: 3.5rem;
    line-height: 1.1;
}

.text-h1 {
    font-size: 2.5rem;
    line-height: 1.2;
}

.text-h2 {
    font-size: 2rem;
    line-height: 1.2;
}

.text-h3 {
    font-size: 1.75rem;
    line-height: 1.2;
}

.text-h4 {
    font-size: 1.5rem;
    line-height: 1.25;
}

.text-h5 {
    font-size: 1.25rem;
    line-height: 1.25;
}

.text-h6 {
    font-size: 1.125rem;
    line-height: 1.25;
}

.text-body-lg {
    font-size: 1.125rem;
    line-height: 1.5;
}

.text-body {
    font-size: 1rem;
    line-height: 1.5;
}

.text-body-sm {
    font-size: 0.875rem;
    line-height: 1.5;
}

.text-caption {
    font-size: 0.75rem;
    line-height: 1.5;
}
.header.scrolled {
    padding: 1rem;
    background: rgba(18, 31, 63, 0.95);
    backdrop-filter: blur(8px);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1.5rem;
}

.header-title {
    color: white;
    font-size: 2rem;
    font-weight: bold;
    margin: 0;
    position: relative;
}

.logo-container {
    min-width: 120px;
    height: 40px;
    display: flex;
    align-items: center;
}

.company-logo {
    height: 100%;
    width: auto;
    max-width: 200px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.company-logo:hover {
    transform: scale(1.05);
}

/* Progress Bar */
.progress {
    height: 8px;
    background: var(--navy-light);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin: 1rem 0;
}

.progress-bar {
    background: var(--abra-coral);
    transition: width 0.3s ease;
}

/* Quick Add Bar */
.quick-add-bar {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    padding: 1rem;
    border-bottom: 1px solid var(--navy-light);
    position: sticky;
    top: 72px;
    z-index: 90;
}

.quick-add-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    background: white;
    color: var(--abra-navy);
    border: 1px solid var(--navy-light);
    border-color: var(--abra-yellow);
    font-weight: 500;
    transition: all 0.2s ease;
}

.quick-add-button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--abra-pink);
    color: var(--abra-pink);
}

/* Expense Card */
.expense-card {
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--navy-light);
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
}

.expense-card:hover {
    box-shadow: var(--shadow-md);
}

.expense-type-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-weight: 500;
    margin-bottom: 1rem;
}

.expense-type-fuel {
    background-color: var(--coral-light);
    color: var(--abra-coral);
}

.expense-type-parking {
    background-color: var(--pink-light);
    color: var(--abra-pink);
}

.expense-type-other {
    background-color: var(--yellow-light);
    color: var(--abra-yellow);
}

/* Form Controls */
.form-control {
    border-radius: var(--radius-md);
    border: 1px solid var(--navy-light);
    padding: 0.75rem 1rem;
    transition: all 0.2s ease;
}

.form-control:focus {
    border-color: var(--abra-coral);
    box-shadow: 0 0 0 3px var(--coral-light);
}

.input-group-text {
    border-radius: var(--radius-md);
    background: var(--navy-light);
    border: none;
    color: var(--abra-navy);
}

/* File Upload */
.file-drop-zone {
    border: 2px dashed var(--navy-light);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.file-drop-zone:hover,
.file-drop-zone.drag-over {
    border-color: var(--abra-coral);
    background: var(--coral-light);
}

.file-preview {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.file-preview-item {
    position: relative;
    width: 100px;
    height: 100px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--navy-light);
}

.file-preview-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.file-remove {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: rgba(255, 255, 255, 0.9);
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    color: var(--abra-pink);
    cursor: pointer;
}

/* Signature Section */
.signature-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin: 2rem 0;
    border: 1px solid var(--navy-light);
}

.signature-container {
    background: var(--abra-white);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    margin-bottom: 1rem;
}

.signature-pad {
    border: 2px dashed var(--navy-light);
    border-radius: var(--radius-md);
    background: white;
    width: 100%;
    height: 150px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.signature-pad:hover {
    border-color: var(--abra-coral);
}

.signature-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-weight: 500;
    color: var(--abra-navy);
}

/* Floating Total */
.floating-total {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    left: 1.5rem;
    background: var(--abra-navy);
    color: white;
    padding: 1.25rem;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 100;
}

.submit-button {
    background: var(--abra-coral);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius-md);
    font-weight: 500;
    transition: all 0.2s ease;
}

.submit-button:hover {
    background: rgb(230, 107, 65);
    transform: translateY(-1px);
}

/* Loading States */
.processing-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 1rem;
    border-radius: var(--radius-md);
    z-index: 10;
}

.processing-spinner {
    width: 40px;
    height: 40px;
    border: 4px solid var(--navy-light);
    border-top-color: var(--abra-coral);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Notifications */
.alert {
    border-radius: var(--radius-md);
    border: none;
    padding: 1rem 1.5rem;
}

.alert-success {
    background: var(--coral-light);
    color: var(--abra-coral);
}

.alert-danger {
    background: var(--pink-light);
    color: var(--abra-pink);
}

.alert-warning {
    background: var(--yellow-light);
    color: var(--abra-yellow);
}

/* Animations */
@keyframes spin {
    to { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.animate__fadeIn {
    animation: fadeIn 0.3s ease-in-out;
}

/* Responsive Design */
@media (max-width: 768px) {
    .header {
        padding: 1rem;
    }
    
    .header.scrolled {
        padding: 0.75rem;
    }
    
    .header-title {
        font-size: 1.5rem;
    }
    
    .company-logo {
        max-width: 160px;
    }
    
    .quick-add-bar {
        padding: 0.75rem;
    }
    
    .expense-card {
        padding: 1rem;
    }
    
    .signature-section {
        padding: 1rem;
    }
    
    .floating-total {
        bottom: 1rem;
        right: 1rem;
        left: 1rem;
        padding: 1rem;
    }
    
    .file-preview-item {
        width: 80px;
        height: 80px;
    }
}

/* Print Styles */
@media print {
    .floating-total,
    .quick-add-bar,
    .file-drop-zone,
    .signature-actions {
        display: none;
    }
    
    body {
        padding: 0;
        background: white;
    }
    
    .expense-card,
    .signature-section {
        break-inside: avoid;
        border: 1px solid #ccc;
    }
}
    </style>
</head>
<body class="body-he">
    <header class="header header-animate">
        <div class="container">
            <div class="header-content">
                <h1 class="header-title">דוח החזר הוצאות</h1>
                <div class="logo-container">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Google_2015_logo.svg/1200px-Google_2015_logo.svg.png" 
                         alt="Company Logo" 
                         class="company-logo"
                         loading="eager">
                </div>
            </div>
        </div>
    </header>
    <div class="container mt-3">
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>
    <div class="container">
        <form id="expenseForm">
            <!-- Basic Info Section -->
            <div class="info-section">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">חודש</label>
                        <input type="month" class="form-control" name="month" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">שם עובד/ת</label>
                        <input type="text" class="form-control" name="employeeName" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">חטיבה/מחלקה</label>
                        <input type="text" class="form-control" name="department" required>
                    </div>
                </div>
            </div>

            <!-- Quick Add Bar -->
            <div class="quick-add-bar">
                <div class="d-flex gap-3 flex-wrap">
                    <button type="button" class="quick-add-button" 
                        onclick="quickAdd('fuel')"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="הוסף הוצאת דלק - צרף תמונת קבלה לזיהוי אוטומטי של הפרטים">
                        <i class="fas fa-gas-pump"></i>
                        דלק
                    </button>
                    <button type="button" class="quick-add-button"
                        onclick="quickAdd('parking')"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="הוסף הוצאת חניה - צרף קבלה או אישור תשלום">
                        <i class="fas fa-parking"></i>
                        חניה
                    </button>
                    <button type="button" class="quick-add-button"
                        onclick="quickAdd('other')"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        title="הוסף הוצאה אחרת - למשל: נסיעות, ציוד, או הוצאות משרדיות">
                        <i class="fas fa-receipt"></i>
                        הוצאה אחרת
                    </button>
                </div>
            </div>

            <!-- Expenses Container -->
            <div id="expensesContainer"></div>

            <!-- Signatures Section -->
            <div class="signature-section">
                <h5 class="mb-4">חתימות</h5>
                <div class="row g-4">
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-user"></i>
                                חתימת העובד
                            </div>
                            <canvas id="employeeSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button" onclick="clearSignature('employeeSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-user-tie"></i>
                                חתימת המנהל
                            </div>
                            <canvas id="managerSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button" onclick="clearSignature('managerSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="signature-container">
                            <div class="signature-label">
                                <i class="fas fa-check-double"></i>
                                חתימת פרוודור
                            </div>
                            <canvas id="provadorSignature" class="signature-pad"></canvas>
                            <div class="signature-actions">
                                <button type="button" class="signature-button" onclick="clearSignature('provadorSignature')">
                                    <i class="fas fa-eraser"></i>
                                    נקה חתימה
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Floating Total with Submit -->
    <div class="floating-total">
        <div>
            סה"כ: <span id="totalAmount">0.00</span> ₪
        </div>
        <button type="submit" form="expenseForm" class="submit-button">
            <i class="fas fa-paper-plane"></i>
            שלח דוח
        </button>
    </div>

    <script>
        // Initialize signature pads
        const signaturePads = {
            employeeSignature: new SignaturePad(document.getElementById('employeeSignature')),
            managerSignature: new SignaturePad(document.getElementById('managerSignature')),
            provadorSignature: new SignaturePad(document.getElementById('provadorSignature'))
        };

        function quickAdd(type) {
            const container = document.getElementById('expensesContainer');
            const today = new Date().toISOString().split('T')[0];
            
            const card = document.createElement('div');
            card.className = 'expense-card animate__animated animate__fadeIn';
            
            let typeLabel, typeIcon, typeClass;
            switch(type) {
                case 'fuel':
                    typeLabel = 'דלק';
                    typeIcon = 'gas-pump';
                    typeClass = 'fuel';
                    break;
                case 'parking':
                    typeLabel = 'חניה';
                    typeIcon = 'parking';
                    typeClass = 'parking';
                    break;
                case 'other':
                    typeLabel = 'הוצאה אחרת';
                    typeIcon = 'receipt';
                    typeClass = 'other';
                    break;
            }
            
            card.innerHTML = `
                <div class="expense-type-indicator expense-type-${typeClass}">
                    <i class="fas fa-${typeIcon}"></i>
                    ${typeLabel}
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">תאריך</label>
                        <input type="date" class="form-control" value="${today}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">מספר חשבונית</label>
                        <input type="text" class="form-control" placeholder="הזן מספר חשבונית" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">סכום</label>
                        <div class="input-group">
                            <input type="number" step="0.01" class="form-control expense-amount" required>
                            <span class="input-group-text">₪</span>
                        </div>
                    </div>
<div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100 h-100" onclick="removeExpenseRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.insertBefore(card, container.firstChild);
            updateTotal();
            
            // Focus on the first input
            card.querySelector('input').focus();
        }

        function removeExpenseRow(button) {
            const card = button.closest('.expense-card');
            card.classList.remove('animate__fadeIn');
            card.classList.add('animate__fadeOut');
            
            card.addEventListener('animationend', () => {
                card.remove();
                updateTotal();
            });
        }

        function clearSignature(id) {
            if (signaturePads[id]) {
                signaturePads[id].clear();
            }
        }

        function updateTotal() {
            const amounts = document.querySelectorAll('.expense-amount');
            const total = Array.from(amounts).reduce((sum, input) => {
                return sum + (parseFloat(input.value) || 0);
            }, 0);
            
            const totalElement = document.getElementById('totalAmount');
            // Animate the total change
            animateNumber(
                parseFloat(totalElement.textContent),
                total,
                {
                    duration: 500,
                    onUpdate: (value) => {
                        totalElement.textContent = value.toFixed(2);
                    }
                }
            );
        }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 150);
            }, 5000);
        }
function updateProgress() {
    const form = document.getElementById('expenseForm');
    const totalFields = form.querySelectorAll('[required]').length;
    const filledFields = Array.from(form.querySelectorAll('[required]')).filter(field => field.value).length;
    const signatures = Object.values(signaturePads).filter(pad => !pad.isEmpty()).length;
    
    const progress = ((filledFields / totalFields) * 0.7 + (signatures / 3) * 0.3) * 100;
    
    document.querySelector('.progress-bar').style.width = `${progress}%`;
}

// Add event listeners for all form fields
document.querySelectorAll('[required]').forEach(field => {
    field.addEventListener('change', updateProgress);
});

// Update progress when signatures change
Object.values(signaturePads).forEach(pad => {
    pad.addEventListener('endStroke', updateProgress);
});
        function quickAdd(type) {
            const container = document.getElementById('expensesContainer');
            const today = new Date().toISOString().split('T')[0];
            
            const card = document.createElement('div');
            card.className = 'expense-card animate__animated animate__fadeIn';
            
            let typeLabel, typeIcon, typeClass;
            switch(type) {
                case 'fuel':
                    typeLabel = 'דלק';
                    typeIcon = 'gas-pump';
                    typeClass = 'fuel';
                    break;
                case 'parking':
                    typeLabel = 'חניה';
                    typeIcon = 'parking';
                    typeClass = 'parking';
                    break;
                case 'other':
                    typeLabel = 'הוצאה אחרת';
                    typeIcon = 'receipt';
                    typeClass = 'other';
                    break;
            }
            
            card.innerHTML = `
                <div class="expense-type-indicator expense-type-${typeClass}">
                    <i class="fas fa-${typeIcon}"></i>
                    ${typeLabel}
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">תאריך</label>
                        <input type="date" class="form-control" value="${today}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">מספר חשבונית</label>
                        <input type="text" class="form-control" placeholder="הזן מספר חשבונית" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">סכום</label>
                        <div class="input-group">
                            <input type="number" step="0.01" class="form-control expense-amount" required>
                            <span class="input-group-text">₪</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger w-100" onclick="removeExpenseRow(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="col-12">
                        <div class="file-drop-zone" ondrop="handleFileDrop(event, this)" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <i class="fas fa-cloud-upload-alt mb-2" style="font-size: 2rem;"
       data-bs-toggle="tooltip"
       data-bs-placement="top"
       title="צלם את הקבלה באמצעות הטלפון או גרור לכאן קובץ PDF"></i>
                            <div>גרור קבצים לכאן או לחץ להעלאה</div>
                            <div class="text-muted">(תמונות או PDF בלבד)</div>
                            <input type="file" class="d-none" accept="image/*,.pdf" multiple 
                                   onchange="handleFileSelect(event, this.parentElement)">
                        </div>
                        <div class="file-preview"></div>
                    </div>
                </div>
            `;
            
            container.insertBefore(card, container.firstChild);
            updateTotal();
            
            // Add click handler for file upload zone
            const dropZone = card.querySelector('.file-drop-zone');
            dropZone.addEventListener('click', () => {
                dropZone.querySelector('input[type="file"]').click();
            });
        }

        // New functions for file handling
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
        }

        function handleFileDrop(event, dropZone) {
            event.preventDefault();
            dropZone.classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            handleFiles(files, dropZone);
        }

        function handleFileSelect(event, dropZone) {
            const files = event.target.files;
            handleFiles(files, dropZone);
        }

        async function handleFiles(files, dropZone) {
            const validFiles = Array.from(files).filter(file => {
                const type = file.type.toLowerCase();
                return type.startsWith('image/') || type === 'application/pdf';
            });

            if (validFiles.length !== files.length) {
                showNotification('רק קבצי תמונה ו-PDF מותרים להעלאה', 'warning');
            }

            const previewContainer = dropZone.nextElementSibling;
            const expenseCard = dropZone.closest('.expense-card');

            for (const file of validFiles) {
                if (file.type.startsWith('image/')) {
                    try {
                        // Show processing overlay
                        const processingOverlay = document.createElement('div');
                        processingOverlay.className = 'processing-overlay';
                        processingOverlay.innerHTML = `
                            <div class="processing-spinner"></div>
                            <div>מעבד קבלה...</div>
                        `;
                        expenseCard.style.position = 'relative';
                        expenseCard.appendChild(processingOverlay);

                        // Create preview
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            const preview = document.createElement('div');
                            preview.className = 'file-preview-item';
                            preview.innerHTML = `
                                <img src="${e.target.result}" alt="Preview">
                                <button type="button" class="file-remove" onclick="removeFile(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            previewContainer.appendChild(preview);

                            // Extract base64 data
                            const base64Data = e.target.result.split(',')[1];
                            
                            // Process image with Gemini
                            try {
                                const receiptData = await processReceiptImage(base64Data);
                                populateExpenseFields(expenseCard, receiptData);
                                showNotification('פרטי הקבלה הועתקו בהצלחה', 'success');
                            } catch (error) {
                                console.error('Receipt processing error:', error);
                                showNotification('שגיאה בעיבוד הקבלה: ' + error.message, 'danger');
                            } finally {
                                // Remove processing overlay
                                processingOverlay.remove();
                            }
                        };
                        reader.readAsDataURL(file);
                    } catch (error) {
                        console.error('File handling error:', error);
                        showNotification('שגיאה בטעינת הקובץ', 'danger');
                    }
                } else if (file.type === 'application/pdf') {
                    // Handle PDFs as before
                    const pdfPreview = document.createElement('div');
                    pdfPreview.className = 'pdf-preview';
                    pdfPreview.innerHTML = `
                        <i class="fas fa-file-pdf"></i>
                        <span>${file.name}</span>
                        <button type="button" class="btn btn-sm btn-link text-danger" onclick="removeFile(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(pdfPreview);
                }
            }
        }
        function removeFile(button) {
            button.closest('.file-preview-item, .pdf-preview').remove();
        }
        // Animate number changes
        function animateNumber(start, end, options) {
            const startTime = performance.now();
            const duration = options.duration || 1000;

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);

                // Easing function for smooth animation
                const easeOutQuad = (t) => t * (2 - t);
                const easedProgress = easeOutQuad(progress);

                const currentValue = start + (end - start) * easedProgress;
                options.onUpdate(currentValue);

                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }

            requestAnimationFrame(update);
        }
        const GEMINI_API_KEY = 'AIzaSyDixJ-7jmpArj67qP5mbT95roaO6gvCES4';
 // Function to process receipt image with Gemini API
 async function processReceiptImage(imageBase64) {
    const systemPrompt = `אתה מומחה בניתוח קבלות. אנא חלץ את המידע הבא מהקבלה ותחזיר אותו בפורמט JSON:
    - תאריך (date)
    - סכום לתשלום (total_payment)
    - מספר קבלה/חשבונית (reception_number)
    
    החזר את התוצאה בפורמט הבא בדיוק:
    { "date": "DD/MM/YY", "total_payment": "X,XXX.XX", "reception_number": "XXXXX" }`;

    const requestBody = {
        contents: [{
            parts: [
                { text: systemPrompt },
                {
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: imageBase64
                    }
                }
            ]
        }],
        generationConfig: {
            temperature: 0.1,
            topK: 1,
            topP: 0.1
        }
    };

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'שגיאה בהתחברות ל-API');
        }

        const data = await response.json();
        
        // Extract the JSON string from the code block
        const extractedText = data.candidates[0].content.parts[0].text;
        const jsonMatch = extractedText.match(/```json\n([\s\S]*?)\n```/);
        
        if (!jsonMatch) {
            throw new Error('פורמט תשובה לא תקין מה-API');
        }

        // Parse the JSON response
        try {
            const jsonString = jsonMatch[1].trim();
            return JSON.parse(jsonString);
        } catch (parseError) {
            console.error('JSON Parse Error:', parseError);
            throw new Error('שגיאה בפענוח תשובת ה-API');
        }

    } catch (error) {
        console.error('Gemini API error:', error);
        throw new Error(`שגיאה בניתוח הקבלה: ${error.message}`);
    }
}
function populateExpenseFields(expenseCard, receiptData) {
    try {
        // Convert date from DD/MM/YY to YYYY-MM-DD for input field
        const [day, month, year] = receiptData.date.split('/');
        const fullYear = '20' + year; // Assuming all dates are from 2000s
        const formattedDate = `${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

        // Populate date field
        const dateInput = expenseCard.querySelector('input[type="date"]');
        if (dateInput) dateInput.value = formattedDate;

        // Populate invoice number
        const invoiceInput = expenseCard.querySelector('input[placeholder="הזן מספר חשבונית"]');
        if (invoiceInput) invoiceInput.value = receiptData.reception_number;

        // Populate amount (remove commas and convert to number)
        const amountInput = expenseCard.querySelector('.expense-amount');
        if (amountInput) {
            const amount = receiptData.total_payment.replace(/,/g, '');
            amountInput.value = parseFloat(amount);
        }

        // Update total
        updateTotal();
        
        console.log('Receipt data populated successfully:', receiptData);
    } catch (error) {
        console.error('Error populating fields:', error);
        throw new Error('שגיאה במילוי הנתונים מהקבלה');
    }
} 
 
        // Listen for amount changes
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('expense-amount')) {
                updateTotal();
            }
        });

        // Handle form submission
        document.getElementById('expenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    let overlay = null;

    try {
        if (!validateForm()) {
            showNotification('נא למלא את כל השדות הנדרשים', 'warning');
            return;
        }

        overlay = showLoadingOverlay();

        // Collect form data
        const formData = new FormData(e.target);
        const data = {
            employeeInfo: {
                month: formData.get('month'),
                name: formData.get('employeeName'),
                department: formData.get('department')
            },
            expenses: collectExpenses(),
            signatures: {
                employee: signaturePads.employeeSignature.isEmpty() ? null : signaturePads.employeeSignature.toDataURL(),
                manager: signaturePads.managerSignature.isEmpty() ? null : signaturePads.managerSignature.toDataURL(),
                provador: signaturePads.provadorSignature.isEmpty() ? null : signaturePads.provadorSignature.toDataURL()
            },
            totalAmount: parseFloat(document.getElementById('totalAmount').textContent),
            submittedAt: new Date().toISOString()
        };

        const response = await fetch('https://3d7bf2afe3ee412993e0fedf4cecf08d.api.mockbin.io', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        hideLoadingOverlay(); // Remove overlay before showing success notification
        showNotification('הדוח נשלח בהצלחה!', 'success');

        if (confirm('האם ברצונך לנקות את הטופס?')) {
            e.target.reset();
            Object.values(signaturePads).forEach(pad => pad.clear());
            document.getElementById('expensesContainer').innerHTML = '';
            updateTotal();
            const today = new Date();
            const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.querySelector('input[name="month"]').value = month;
        }

    } catch (error) {
        console.error('Error:', error);
        hideLoadingOverlay(); // Remove overlay before showing error notification
        showNotification('אירעה שגיאה בשליחת הדוח: ' + error.message, 'danger');
    }
});      
        function initTooltips() {
            const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltips.forEach(element => {
                if (!element._tippy) {
                    new bootstrap.Tooltip(element);
                }
            });
        }
        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
            overlay.style.cssText = `
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(5px);
                z-index: 9999;
            `;
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-light mb-2" role="status">
                        <span class="visually-hidden">טוען...</span>
                    </div>
                    <div class="text-light">שולח נתונים...</div>
                </div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }
        function removeExistingOverlays() {
    const existingOverlays = document.querySelectorAll('.loading-overlay');
    existingOverlays.forEach(overlay => overlay.remove());
}
        function validateForm() {
            const form = document.getElementById('expenseForm');
            const requiredFields = form.querySelectorAll('[required]');
            
            let isValid = true;
            requiredFields.forEach(field => {
                if (!field.value) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Check signatures
            const signatures = Object.values(signaturePads);
            signatures.forEach(pad => {
                const canvas = pad.canvas;
                if (pad.isEmpty()) {
                    canvas.style.borderColor = 'var(--danger)';
                    isValid = false;
                } else {
                    canvas.style.borderColor = '';
                }
            });

            return isValid;
        }

        function collectExpenses() {
            const expenses = [];
            document.querySelectorAll('.expense-card').forEach(card => {
                const type = card.querySelector('.expense-type-indicator').textContent.trim();
                const fileElements = card.querySelectorAll('.file-preview-item img, .pdf-preview');
                const files = Array.from(fileElements).map(el => {
                    if (el.tagName === 'IMG') {
                        return { type: 'image', data: el.src };
                    } else {
                        return { type: 'pdf', name: el.querySelector('span').textContent };
                    }
                });

                expenses.push({
                    type: type,
                    date: card.querySelector('input[type="date"]').value,
                    invoice: card.querySelector('input[placeholder="הזן מספר חשבונית"]').value,
                    amount: parseFloat(card.querySelector('.expense-amount').value) || 0,
                    files: files
                });
            });
            return expenses;
        }

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
    notification.style.zIndex = '9999';
    notification.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            <div>${message}</div>
            <button type="button" class="btn-close ms-3" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Remove notification after 5 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 150);
    }, 5000);
}
function showLoadingOverlay() {
    // First remove any existing overlays
    removeExistingOverlays();
    
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center loading-overlay';
    overlay.style.cssText = `
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
        z-index: 9999;
    `;
    overlay.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-light mb-2" role="status">
                <span class="visually-hidden">טוען...</span>
            </div>
            <div class="text-light">שולח נתונים...</div>
        </div>
    `;
    document.body.appendChild(overlay);
    return overlay;
}

// Function to hide loading overlay
function hideLoadingOverlay() {
    removeExistingOverlays();
}
window.addEventListener('scroll', () => {
    const header = document.querySelector('.header');
    if (window.scrollY > 50) {
        header.classList.add('scrolled');
    } else {
        header.classList.remove('scrolled');
    }
});
// Intersection Observer for better performance
const headerObserver = new IntersectionObserver(
    (entries) => {
        entries.forEach(entry => {
            if (!entry.isIntersecting) {
                entry.target.classList.add('scrolled');
            } else {
                entry.target.classList.remove('scrolled');
            }
        });
    },
    { threshold: 1 }
);

// Observe the header
const header = document.querySelector('.header');
if (header) {
    headerObserver.observe(header);
}




        // Initialize form
        window.addEventListener('load', () => {
            // Set current month as default
            const today = new Date();
            const month = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
            document.querySelector('input[name="month"]').value = month;
        });
        document.addEventListener('DOMContentLoaded', function() {
            initTooltips();
            
            // Add tooltips to signatures
            const signaturePads = document.querySelectorAll('.signature-pad');
            signaturePads.forEach(pad => {
                pad.setAttribute('data-bs-toggle', 'tooltip');
                pad.setAttribute('data-bs-placement', 'top');
                pad.setAttribute('title', 'חתום כאן - לחץ והחזק את העכבר תוך כדי ציור החתימה');
            });
            
            // Add tooltips to form fields
            document.querySelector('input[name="month"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="month"]').setAttribute('title', 'בחר את החודש עבורו מוגש הדוח');
            
            document.querySelector('input[name="employeeName"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="employeeName"]').setAttribute('title', 'הזן את שמך המלא כפי שמופיע במערכת');
            
            document.querySelector('input[name="department"]').setAttribute('data-bs-toggle', 'tooltip');
            document.querySelector('input[name="department"]').setAttribute('title', 'בחר את המחלקה או החטיבה אליה אתה שייך');
            
            initTooltips();
        });
    </script>
</body>
</html>
